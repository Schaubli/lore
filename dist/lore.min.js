"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Enum(e){var t=Object.keys(e).reduce(function(t,n){return t[e[n]]=n,t},{});return Object.freeze(Object.keys(e).reduce(function(t,n){return t[n]=e[n],t},function(e){return t[e]}))}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),Lore={Version:"1.0.0"};"function"==typeof define&&define.amd?define("lore",Lore):"undefined"!=typeof exports&&"undefined"!=typeof module&&(module.exports=Lore),Lore.Mouse=Enum({Left:0,Middle:1,Right:2}),Lore.Keyboard=Enum({Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Esc:27}),Lore.Shaders={},Lore.getShader=function(e){return Lore.Shaders[e].clone()},Lore.init=function(e,t){this.opts=Lore.Utils.extend(!0,Lore.defaults,t),Lore.getGrakaInfo(e);var n=(new Lore.UI(e),Lore.Color.fromHex(this.opts.clearColor)),o=new Lore.Renderer(e,{clearColor:n,verbose:!0,fps:document.getElementById("fps"),center:new Lore.Vector3f(125,125,125),antialiasing:this.opts.antialiasing});return o.controls.limitRotationToHorizon(this.opts.limitRotationToHorizon),o.render=function(e,t){for(var n in t)t[n].draw(o)},o},Lore.getGrakaInfo=function(e){var t=document.getElementById(e),n=t.getContext("webgl")||t.getContext("experimental-webgl"),o={renderer:"",vendor:""},i=n.getExtension("WEBGL_debug_renderer_info");return null!=i&&(o.renderer=n.getParameter(i.UNMASKED_RENDERER_WEBGL),o.vendor=n.getParameter(i.UNMASKED_VENDOR_WEBGL)),o},Lore.supportsHighQuality=function(e){Lore.getGrakaInfo(e);return!1},Lore.defaults={clearColor:"#121212",limitRotationToHorizon:!1,antialiasing:!1},Lore.DrawModes={points:0,lines:1,lineStrip:2,lineLoop:3,triangles:4,traingleStrip:5,triangleFan:6},Lore.Color=function(){function e(t,n,o,i){_classCallCheck(this,e),1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=n||0,this.components[2]=o||0,this.components[3]=i||1)}return _createClass(e,[{key:"set",value:function(e,t,n,o){return this.components[0]=e,this.components[1]=t,this.components[2]=n,4==arguments.length&&(this.components[3]=o),this}}],[{key:"fromHex",value:function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,n,o){return t+t+n+n+o+o});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),n=parseInt(t[1],16),o=parseInt(t[2],16),i=parseInt(t[3],16);return t?new Lore.Color(n/255,o/255,i/255,1):null}},{key:"hueToRgb",value:function(e,t,n){if(n<0)n+=1;else if(n>1)n-=1;else{if(n<.1667)return e+6*(t-e)*n;if(n<.5)return t;if(n<.6667)return e+(t-e)*(.6667-n)*6}return e}},{key:"hslToRgb",value:function(e,t,n){var o=void 0,i=void 0,s=void 0;if(0==t)o=i=s=n;else{var r=n<.5?n*(1+t):n+t-n*t,a=2*n-r;o=Lore.Color.hueToRgb(a,r,e+.3333),i=Lore.Color.hueToRgb(a,r,e),s=Lore.Color.hueToRgb(a,r,e-.3333)}return[o,i,s]}},{key:"rgbToHsl",value:function(e,t,n){e/=255,t/=255,n/=255;var o=Math.max(e,t,n),i=Math.min(e,t,n),s=void 0,r=void 0,a=(o+i)/2;if(o==i)s=r=0;else{var c=o-i;switch(r=a>.5?c/(2-o-i):c/(o+i),o){case e:s=(t-n)/c+(t<n?6:0);break;case t:s=(n-e)/c+2;break;case n:s=(e-t)/c+4}s/=6}return[s,r,a]}},{key:"gdbHueShift",value:function(e){return e=.85*e+.66,e>1&&(e-=1),e=1-e+.33,e>1&&(e-=1),e}}]),e}(),Lore.Renderer=function(){function e(t,n){_classCallCheck(this,e),this.defaults={antialiasing:!0,verbose:!1,fpsElement:document.getElementById("fps"),clearColor:Lore.Color.fromHex("#000000"),clearDepth:1,center:new Lore.Vector3f,enableDepthTest:!0},this.opts=Lore.Utils.extend(!0,this.defaults,n),this.canvas=document.getElementById(t),this.parent=this.canvas.parentElement,this.fps=0,this.fpsCount=0,this.maxFps=1e3/30,this.devicePixelRatio=this.getDevicePixelRatio(),this.camera=new Lore.OrthographicCamera(this.getWidth()/-2,this.getWidth()/2,this.getHeight()/2,this.getHeight()/-2),this.geometries={},this.ready=!1,this.gl=null,this.render=function(e,t){},this.effect=null,this.lastTiming=performance.now(),this.disableContextMenu();var o=this;o.init();var i=n.center?n.center:new Lore.Vector3f;o.controls=n.controls||new Lore.OrbitalControls(o,1200,i)}return _createClass(e,[{key:"init",value:function(){var e=this,t={antialias:this.opts.antialiasing};if(this.gl=this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t),!this.gl)return void console.error("Could not initialize the WebGL context.");var n=this.gl;if(this.opts.verbose){var o=n.getContextAttributes().antialias,i=n.getParameter(n.SAMPLES);console.info("Antialiasing: "+o+" ("+i+"x)");var s=n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.HIGH_FLOAT),r=0!=s.precision;console.info("High precision support: "+r)}var a="OES_standard_derivatives";null===n.getExtension(a)&&console.warn("Could not load extension: "+a+".");var c="WEBGL_draw_buffers";null===n.getExtension(c)&&console.warn("Could not load extension: "+c+".");var u="WEBGL_depth_texture";null===n.getExtension(u)&&console.warn("Could not load extension: "+u+"."),this.setClearColor(this.opts.clearColor),n.clearDepth(this.opts.clearDepth),this.opts.enableDepthTest&&(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),this.opts.verbose&&console.log("enable depth test")),setTimeout(function(){e.updateViewport(0,0,e.getWidth(),e.getHeight())},1e3),this.updateViewport(0,0,e.getWidth(),e.getHeight()),window.addEventListener("resize",function(t){var n=e.getWidth(),o=e.getHeight();e.updateViewport(0,0,n,o)}),this.effect=new Lore.Effect(this,"fxaaEffect"),this.ready=!0,this.animate()}},{key:"disableContextMenu",value:function(){this.canvas.addEventListener("contextmenu",function(e){if(2===e.button)return e.preventDefault(),!1})}},{key:"setClearColor",value:function(e){this.opts.clearColor=e;var t=this.opts.clearColor.components;this.gl.clearColor(t[0],t[1],t[2],t[3])}},{key:"getWidth",value:function(){return this.canvas.offsetWidth}},{key:"getHeight",value:function(){return this.canvas.offsetHeight}},{key:"updateViewport",value:function(e,t,n,o){this.canvas.width=n,this.canvas.height=o,this.gl.viewport(e,t,n,o),this.camera.updateViewport(n,o),this.camera.updateProjectionMatrix(),this.effect=new Lore.Effect(this,"fxaaEffect"),this.effect.shader.uniforms.resolution.setValue([n,o])}},{key:"animate",value:function(){var e=this;if(setTimeout(function(){requestAnimationFrame(function(){e.animate()})},this.maxFps),this.opts.fpsElement){var t=performance.now(),n=t-this.lastTiming;this.lastTiming=t,this.fpsCount<10?(this.fps+=Math.round(1e3/n),this.fpsCount++):(this.opts.fpsElement.innerHTML=Math.round(this.fps/this.fpsCount),this.fpsCount=0,this.fps=0)}this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.render(this.camera,this.geometries),this.camera.isProjectionMatrixStale=!1,this.camera.isViewMatrixStale=!1}},{key:"createGeometry",value:function(e,t){var n=Lore.getShader(t);n.init(this.gl);var o=new Lore.Geometry(e,this.gl,n);return this.geometries[e]=o,o}},{key:"setMaxFps",value:function(e){this.maxFps=1e3/e}},{key:"getDevicePixelRatio",value:function(){return window.devicePixelRatio||1}}]),e}(),Lore.Shader=function(){function e(t,n,o,i){_classCallCheck(this,e),this.name=t,this.uniforms=n||{},this.vertexShader=o||[],this.fragmentShader=i||[],this.gl=null,this.program=null,this.initialized=!1,this.lastTime=(new Date).getTime(),this.uniforms.modelViewMatrix=new Lore.Uniform("modelViewMatrix",(new Lore.Matrix4f).entries,"float_mat4"),this.uniforms.projectionMatrix=new Lore.Uniform("projectionMatrix",(new Lore.Matrix4f).entries,"float_mat4")}return _createClass(e,[{key:"clone",value:function(){return new Lore.Shader(this.name,this.uniforms,this.vertexShader,this.fragmentShader)}},{key:"getVertexShaderCode",value:function(){return this.vertexShader.join("\n")}},{key:"getFragmentShaderCode",value:function(){return this.fragmentShader.join("\n")}},{key:"getVertexShader",value:function(e){var t=e.createShader(e.VERTEX_SHADER),n="uniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\n"+this.getVertexShaderCode();return e.shaderSource(t,n),e.compileShader(t),Lore.Shader.showCompilationInfo(e,t,this.name,"Vertex Shader"),t}},{key:"getFragmentShader",value:function(e){var t=e.createShader(e.FRAGMENT_SHADER),n="#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#ifdef GL_ES\nprecision highp float;\n#endif\n\n"+this.getFragmentShaderCode();return e.shaderSource(t,n),e.compileShader(t),Lore.Shader.showCompilationInfo(e,t,this.name,"Fragment Shader"),t}},{key:"init",value:function(e){this.gl=e,this.program=this.gl.createProgram();var t=this.getVertexShader(this.gl),n=this.getFragmentShader(this.gl);return t&&n?(this.gl.attachShader(this.program,t),this.gl.attachShader(this.program,n),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)?void(this.initialized=!0):(console.error("Could not link program.\nVALIDATE_STATUS: "+this.gl.getProgramParameter(program,this.gl.VALIDATE_STATUS)+"\nERROR: "+this.gl.getError()),null)):(console.error("Failed to create the fragment or the vertex shader."),null)}},{key:"updateUniforms",value:function(e){if(this.uniforms.time){var t=this.uniforms.time,n=(new Date).getTime();t.value+=n-this.lastTime,this.lastTime=n,Lore.Uniform.Set(this.gl,this.program,t),t.stale=!1}for(var o in this.uniforms){var i=this.uniforms[o];i.stale&&Lore.Uniform.Set(this.gl,this.program,i)}}},{key:"use",value:function(){this.gl.useProgram(this.program),this.updateUniforms()}}],[{key:"showCompilationInfo",value:function(e,t,n,o){o=o||"Shader",!1===e.getShaderParameter(t,e.COMPILE_STATUS)&&console.error(o+" "+n+" did not compile."),""!==e.getShaderInfoLog(t)&&console.warn(o+" "+n+" info log: "+e.getShaderInfoLog(t))}}]),e}(),Lore.Uniform=function(){function e(t,n,o){_classCallCheck(this,e),this.name=t,this.value=n,this.type=o,this.stale=!0}return _createClass(e,[{key:"setValue",value:function(e){this.value=e,this.stale=!0}}],[{key:"Set",value:function(e,t,n){var o=e.getUniformLocation(t,n.name);"int"===n.type?e.uniform1i(o,n.value):"int_vec2"===n.type?e.uniform2iv(o,n.value):"int_vec3"===n.type?e.uniform3iv(o,n.value):"int_vec4"===n.type?e.uniform4iv(o,n.value):"int_array"===n.type?e.uniform1iv(o,n.value):"float"===n.type?e.uniform1f(o,n.value):"float_vec2"===n.type?e.uniform2fv(o,n.value):"float_vec3"===n.type?e.uniform3fv(o,n.value):"float_vec4"===n.type?e.uniform4fv(o,n.value):"float_array"===n.type?e.uniform1fv(o,n.value):"float_mat2"===n.type?e.uniformMatrix2fv(o,!1,n.value):"float_mat3"===n.type?e.uniformMatrix3fv(o,!1,n.value):"float_mat4"===n.type&&e.uniformMatrix4fv(o,!1,n.value),n.stale=!0}}]),e}(),Lore.Node=function(){function e(){_classCallCheck(this,e),this.type="Lore.Node",this.id=Lore.Node.createGUID(),this.isVisible=!0,this.position=new Lore.Vector3f,this.rotation=new Lore.Quaternion,this.scale=new Lore.Vector3f(1,1,1),this.up=new Lore.Vector3f(0,1,0),this.normalMatrix=new Lore.Matrix3f,this.modelMatrix=new Lore.Matrix4f,this.isStale=!1,this.children=new Array,this.parent=null}return _createClass(e,[{key:"applyMatrix",value:function(e){return this.modelMatrix.multiplyB(e),this}},{key:"getUpVector",value:function(){return new Lore.Vector3f(0,1,0).applyQuaternion(this.rotation)}},{key:"getForwardVector",value:function(){return new Lore.Vector3f(0,0,1).applyQuaternion(this.rotation)}},{key:"getRightVector",value:function(){return new Lore.Vector3f(1,0,0).applyQuaternion(this.rotation)}},{key:"translateOnAxis",value:function(e,t){var n=new Lore.Vector3f(e.components[0],e.components[1],e.components[2]);return n.applyQuaternion(this.rotation),n.multiplyScalar(t),this.position.add(n),this}},{key:"translateX",value:function(e){return this.position.components[0]=this.position.components[0]+e,this}},{key:"translateY",value:function(e){return this.position.components[1]=this.position.components[1]+e,this}},{key:"translateZ",value:function(e){return this.position.components[2]=this.position.components[2]+e,this}},{key:"setTranslation",value:function(e){return this.position=e,this}},{key:"setRotation",value:function(e,t){return this.rotation.setFromAxisAngle(e,t),this}},{key:"rotate",value:function(e,t){var n=new Lore.Quaternion(e,t);return this.rotation.multiplyA(n),this}},{key:"rotateX",value:function(e){return this.rotation.rotateX(e),this}},{key:"rotateY",value:function(e){return this.rotation.rotateY(e),this}},{key:"rotateZ",value:function(e){return this.rotation.rotateZ(e),this}},{key:"getRotationMatrix",value:function(){return this.rotation.toRotationMatrix()}},{key:"update",value:function(){return this.modelMatrix.compose(this.position,this.rotation,this.scale),this.isStale=!0,this}},{key:"getModelMatrix",value:function(){return this.modelMatrix.entries}}],[{key:"createGUID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}}]),e}(),Lore.Geometry=function(e){function t(e,n,o){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.type="Lore.Geometry",i.name=e,i.gl=n,i.shader=o,i.attributes={},i.drawMode=i.gl.POINTS,i.isVisible=!0,i}return _inherits(t,e),_createClass(t,[{key:"addAttribute",value:function(e,t,n){return this.attributes[e]=new Lore.Attribute(t,n,e),this.attributes[e].createBuffer(this.gl,this.shader.program),this}},{key:"updateAttribute",value:function(e,t){return t&&(this.attributes[e].data=t),this.attributes[e].update(this.gl),this}},{key:"getAttribute",value:function(e){return this.attributes[e]}},{key:"removeAttribute",value:function(e){return delete this.attributes[e],this}},{key:"setMode",value:function(e){switch(e){case Lore.DrawModes.points:this.drawMode=this.gl.POINTS;break;case Lore.DrawModes.lines:this.drawMode=this.gl.LINES;break;case Lore.DrawModes.lineStrip:this.drawMode=this.gl.LINE_STRIP;break;case Lore.DrawModes.lineLoop:this.drawMode=this.gl.LINE_LOOP;break;case Lore.DrawModes.triangles:this.drawMode=this.gl.TRIANGLES;break;case Lore.DrawModes.triangleStrip:this.drawMode=this.gl.TRIANGLE_STRIP;break;case Lore.DrawModes.triangleFan:this.drawMode=this.gl.TRIANGLE_FAN}return this}},{key:"size",value:function(){return Object.keys(this.attributes).length>0?this.attributes[Object.keys(this.attributes)[0]].size:0}},{key:"draw",value:function(e){if(this.isVisible){for(var t in this.attributes)this.attributes[t].stale&&this.attributes[t].update(this.gl);if(this.shader.use(),e.camera.isProjectionMatrixStale&&this.shader.uniforms.projectionMatrix.setValue(e.camera.getProjectionMatrix()),e.camera.isViewMatrixStale){var n=Lore.Matrix4f.multiply(e.camera.viewMatrix,this.modelMatrix);this.shader.uniforms.modelViewMatrix.setValue(n.entries)}this.shader.updateUniforms();for(var o in this.attributes)this.attributes[o].bind(this.gl);this.gl.drawArrays(this.drawMode,0,this.size())}}}]),t}(Lore.Node),Lore.Attribute=function(){function e(t,n,o){_classCallCheck(this,e),this.type="Lore.Attribute",this.data=t,this.attributeLength=n||3,this.name=o,this.size=this.data.length/this.attributeLength,this.buffer=null,this.attributeLocation,this.bufferType=null,this.drawMode=null,this.stale=!1}return _createClass(e,[{key:"setFromVector",value:function(e,t){this.data.set(t.components,e*this.attributeLength,t.components.length)}},{key:"setFromVectorArray",value:function(e){if(this.attributeLength!==e[0].components.length)throw"The attribute has a length of "+this.attributeLength+". But the vectors have "+e[0].components.length+" components.";for(var t=0;t<e.length;t++)this.data.set(e[t].components,t*this.attributeLength,e[t].components.length)}},{key:"getX",value:function(e){return this.data[e*this.attributeLength]}},{key:"setX",value:function(e,t){this.data[e*this.attributeLength]}},{key:"getY",value:function(e){return this.data[e*this.attributeLength+1]}},{key:"setY",value:function(e,t){this.data[e*this.attributeLength+1]}},{key:"getZ",value:function(e){return this.data[e*this.attributeLength+2]}},{key:"setZ",value:function(e,t){this.data[e*this.attributeLength+2]}},{key:"getW",value:function(e){return this.data[e*this.attributeLength+3]}},{key:"setW",value:function(e,t){this.data[e*this.attributeLength+3]}},{key:"getGlType",value:function(e){return e.FLOAT}},{key:"update",value:function(e){e.bindBuffer(this.bufferType,this.buffer),e.bufferData(this.bufferType,this.data,this.drawMode),this.stale=!1}},{key:"createBuffer",value:function(e,t,n,o){this.buffer=e.createBuffer(),this.bufferType=n||e.ARRAY_BUFFER,this.drawMode=o||e.STATIC_DRAW,e.bindBuffer(this.bufferType,this.buffer),e.bufferData(this.bufferType,this.data,this.drawMode),this.buffer.itemSize=this.attributeLength,this.buffer.numItems=this.size,this.attributeLocation=e.getAttribLocation(t,this.name),e.bindBuffer(this.bufferType,null)}},{key:"bind",value:function(e){e.bindBuffer(this.bufferType,this.buffer),this.attributeLocation>=0&&(e.vertexAttribPointer(this.attributeLocation,this.attributeLength,this.getGlType(e),e.FALSE,0,0),e.enableVertexAttribArray(this.attributeLocation))}}]),e}(),Lore.Effect=function(){function e(t,n){_classCallCheck(this,e),this.renderer=t,this.gl=this.renderer.gl,this.framebuffer=this.initFramebuffer(),this.texture=this.initTexture(),this.renderbuffer=this.initRenderbuffer(),this.shader=Lore.getShader(n),this.shader.init(this.renderer.gl),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}return _createClass(e,[{key:"initBuffer",value:function(){var e=this.gl,t=e.getAttribLocation(this.shader.program,"v_coord"),n=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,-1,-1,1,-1,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),n}},{key:"initTexture",value:function(){var e=this.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.renderer.getWidth(),this.renderer.getHeight(),0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),t}},{key:"initFramebuffer",value:function(){var e=this.gl,t=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,t),t}},{key:"initRenderbuffer",value:function(){var e=this.gl,t=e.createRenderbuffer();return e.bindRenderbuffer(e.RENDERBUFFER,t),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.renderer.getWidth(),this.renderer.getHeight()),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t),t}},{key:"bind",value:function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}},{key:"unbind",value:function(){var e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this.initBuffer(),this.shader.use(),e.drawArrays(e.TRIANGLES,0,6)}}]),e}(),Lore.ControlsBase=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Lore.Vector3f;arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,e),this.renderer=t,this.camera=t.camera,this.canvas=t.canvas,this.lowFps=15,this.highFps=30,this._eventListeners={},this.renderer.setMaxFps(this.lowFps),this.touchMode="drag",this.lookAt=n,this.mouse={previousPosition:{x:null,y:null},delta:{x:0,y:0},position:{x:0,y:0},state:{left:!1,middle:!1,right:!1},normalizedPosition:{x:0,y:0},touches:0},this.keyboard={alt:!1,ctrl:!1,shift:!1},this.VR={};var o=this;this.canvas.addEventListener("mousemove",function(e){(null!==o.mouse.previousPosition.x&&o.mouse.state.left||o.mouse.state.middle||o.mouse.state.right)&&(o.mouse.delta.x=e.pageX-o.mouse.previousPosition.x,o.mouse.delta.y=e.pageY-o.mouse.previousPosition.y,o.mouse.position.x+=.01*o.mouse.delta.x,o.mouse.position.y+=.01*o.mouse.delta.y,o.mouse.state.left?o.raiseEvent("mousedrag",{e:o.mouse.delta,source:"left"}):o.mouse.state.middle?o.raiseEvent("mousedrag",{e:o.mouse.delta,source:"middle"}):o.mouse.state.right&&o.raiseEvent("mousedrag",{e:o.mouse.delta,source:"right"}));var t=o.canvas.getBoundingClientRect();o.mouse.normalizedPosition.x=(e.clientX-t.left)/o.canvas.width*2-1,o.mouse.normalizedPosition.y=-(e.clientY-t.top)/o.canvas.height*2+1,o.raiseEvent("mousemove",{e:o}),o.mouse.previousPosition.x=e.pageX,o.mouse.previousPosition.y=e.pageY}),this.canvas.addEventListener("touchstart",function(e){o.mouse.touches++;var t=e.touches[0];e.preventDefault(),o.mouse.touched=!0,o.renderer.setMaxFps(o.highFps);var n=o.canvas.getBoundingClientRect();o.mouse.normalizedPosition.x=(t.clientX-n.left)/o.canvas.width*2-1,o.mouse.normalizedPosition.y=-(t.clientY-n.top)/o.canvas.height*2+1,"drag"!==o.touchMode&&o.raiseEvent("mousemove",{e:o}),o.raiseEvent("mousedown",{e:o,source:"touch"})}),this.canvas.addEventListener("touchend",function(e){o.mouse.touches--,e.preventDefault(),o.mouse.touched=!1,o.mouse.previousPosition.x=null,o.mouse.previousPosition.y=null,o.renderer.setMaxFps(o.lowFps),o.raiseEvent("mouseup",{e:o,source:"touch"})}),this.canvas.addEventListener("touchmove",function(e){var t=e.touches[0],n="left";2==o.mouse.touches&&(n="right"),e.preventDefault(),null!==o.mouse.previousPosition.x&&o.mouse.touched&&(o.mouse.delta.x=t.pageX-o.mouse.previousPosition.x,o.mouse.delta.y=t.pageY-o.mouse.previousPosition.y,o.mouse.position.x+=.01*o.mouse.delta.x,o.mouse.position.y+=.01*o.mouse.delta.y,"drag"===o.touchMode&&o.raiseEvent("mousedrag",{e:o.mouse.delta,source:n}));var i=o.canvas.getBoundingClientRect();o.mouse.normalizedPosition.x=(t.clientX-i.left)/o.canvas.width*2-1,o.mouse.normalizedPosition.y=-(t.clientY-i.top)/o.canvas.height*2+1,"drag"!==o.touchMode&&o.raiseEvent("mousemove",{e:o}),o.mouse.previousPosition.x=t.pageX,o.mouse.previousPosition.y=t.pageY});var i="mousewheel";navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(i="DOMMouseScroll"),this.canvas.addEventListener(i,function(e){e.preventDefault();var t="wheelDelta"in e?e.wheelDelta:-40*e.detail;o.raiseEvent("mousewheel",{e:t})}),this.canvas.addEventListener("keydown",function(e){16==e.which?o.keyboard.shift=!0:17==e.which?o.keyboard.ctrl=!0:18==e.which&&(o.keyboard.alt=!0),o.raiseEvent("keydown",{e:e.which})}),this.canvas.addEventListener("keyup",function(e){16==e.which?o.keyboard.shift=!1:17==e.which?o.keyboard.ctrl=!1:18==e.which&&(o.keyboard.alt=!1),o.raiseEvent("keyup",{e:e.which})}),this.canvas.addEventListener("mousedown",function(e){var t=e.button,n="left";0==t?o.mouse.state.left=!0:1==t?(o.mouse.state.middle=!0,n="middle"):2==t&&(o.mouse.state.right=!0,n="right"),o.renderer.setMaxFps(o.highFps),o.raiseEvent("mousedown",{e:o,source:n})}),this.canvas.addEventListener("click",function(e){e.button;o.raiseEvent("click",{e:o,source:"left"})}),this.canvas.addEventListener("dblclick",function(e){e.button;o.raiseEvent("dblclick",{e:o,source:"left"})}),this.canvas.addEventListener("mouseup",function(e){var t=e.button,n="left";0==t?o.mouse.state.left=!1:1==t?(o.mouse.state.middle=!1,n="middle"):2==t&&(o.mouse.state.right=!1,n="right"),o.mouse.previousPosition.x=null,o.mouse.previousPosition.y=null,o.renderer.setMaxFps(o.lowFps),o.raiseEvent("mouseup",{e:o,source:n})}),this.canvas.addEventListener("mouseleave",function(e){o.mouse.state.left=!1,o.mouse.state.middle=!1,o.mouse.state.right=!1,o.mouse.previousPosition.x=null,o.mouse.previousPosition.y=null,o.renderer.setMaxFps(o.lowFps),o.raiseEvent("mouseleave",{e:o,source:o.canvas})})}return _createClass(e,[{key:"initWebVR",value:function(){navigator.getVRDevices&&navigator.getVRDisplays().then(function(e){if(0!==e.length)for(var t=0;t<e.length;++t);})}},{key:"addEventListener",value:function(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){if(console.log("remove event listener called"),this._eventListeners.hasOwnProperty(e)){console.log("removing event listeners ...");for(var n=0;n<this._eventListeners[e].length;n++)console.log(e,this._eventListeners[e][n],t,this._eventListeners[e]==t);var o=this._eventListeners[e].indexOf(t);o>-1&&(this._eventListeners[e].splice(o,1),console.log("removed handler!"))}}},{key:"raiseEvent",value:function(e,t){if(this._eventListeners[e])for(var n=0;n<this._eventListeners[e].length;n++)this._eventListeners[e][n](t)}},{key:"getLookAt",value:function(){return this.lookAt}},{key:"setLookAt",value:function(e){return this.lookAt=e.clone(),this.update(),this}},{key:"update",value:function(e,t){return this}}]),e}(),Lore.OrbitalControls=function(e){function t(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Lore.Vector3f;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o));i.up=Lore.Vector3f.up(),i.radius=n,i.yRotationLimit=Math.PI,i._dPhi=0,i._dTheta=0,i._dPan=new Lore.Vector3f,i.spherical=new Lore.SphericalCoords,i.scale=.95,i.camera.position=new Lore.Vector3f(n,n,n),i.camera.updateProjectionMatrix(),i.camera.updateViewMatrix(),i.rotationLocked=!1;var s=i;return i.addEventListener("mousedrag",function(e){s.update(e.e,e.source)}),i.addEventListener("mousewheel",function(e){s.update({x:0,y:-e.e},"wheel")}),i.update({x:0,y:0},"left"),i}return _inherits(t,e),_createClass(t,[{key:"limitRotationToHorizon",value:function(e){return this.yRotationLimit=e?.5*Math.PI:Math.PI,this}},{key:"setRadius",value:function(e){return this.radius=e,this.camera.position=new Lore.Vector3f(0,0,e),this.camera.updateProjectionMatrix(),this.camera.updateViewMatrix(),this.update(),this}},{key:"update",value:function(e,t){if("left"!=t||this.rotationLocked)if("right"==t||"left"==t&&this.rotationLocked){var n=e.x*(this.camera.right-this.camera.left)/this.camera.zoom/this.canvas.clientWidth,o=e.y*(this.camera.top-this.camera.bottom)/this.camera.zoom/this.canvas.clientHeight,i=this.camera.getUpVector().components,s=this.camera.getRightVector().components;this._dPan.components[0]=s[0]*-n+i[0]*o,this._dPan.components[1]=s[1]*-n+i[1]*o,this._dPan.components[2]=s[2]*-n+i[2]*o}else"middle"!=t&&"wheel"!=t||(e.y>0?(this.camera.zoom=Math.max(0,this.camera.zoom*this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom)):e.y<0&&(this.camera.zoom=Math.max(0,this.camera.zoom/this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom)));else this._dTheta=-2*Math.PI*e.x/(this.canvas.clientWidth*this.camera.zoom),this._dPhi=-2*Math.PI*e.y/(this.canvas.clientHeight*this.camera.zoom);var r=this.camera.position.clone().subtract(this.lookAt);return this.spherical.setFromVector(r),this.spherical.components[1]+=this._dPhi,this.spherical.components[2]+=this._dTheta,this.spherical.limit(0,this.yRotationLimit,-1/0,1/0),this.spherical.secure(),this.lookAt.add(this._dPan),r.setFromSphericalCoords(this.spherical),this.camera.position.copyFrom(this.lookAt).add(r),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this._dPhi=0,this._dTheta=0,this._dPan.set(0,0,0),this.raiseEvent("updated"),this}},{key:"setView",value:function(e,t){var n=this.camera.position.clone().subtract(this.lookAt);return this.spherical.setFromVector(n),this.spherical.components[1]=e,this.spherical.components[2]=t,this.spherical.secure(),n.setFromSphericalCoords(this.spherical),this.camera.position.copyFrom(this.lookAt).add(n),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this.raiseEvent("updated"),this}},{key:"zoomIn",value:function(){return this.camera.zoom=Math.max(0,this.camera.zoom/this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom),this.raiseEvent("updated"),this}},{key:"zoomOut",value:function(){return this.camera.zoom=Math.max(0,this.camera.zoom*this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom),this.raiseEvent("updated"),this}},{key:"setTopView",value:function(){return this.setView(0,2*Math.PI),this.rotationLocked=!0,this}},{key:"setBottomView",value:function(){return this.setView(0,0),this.rotationLocked=!0,this}},{key:"setRightView",value:function(){return this.setView(.5*Math.PI,.5*Math.PI),this.rotationLocked=!0,this}},{key:"setLeftView",value:function(){return this.setView(.5*Math.PI,-.5*Math.PI),this.rotationLocked=!0,this}},{key:"setFrontView",value:function(){return this.setView(.5*Math.PI,2*Math.PI),this.rotationLocked=!0,this}},{key:"setBackView",value:function(){return this.setView(.5*Math.PI,Math.PI),this.rotationLocked=!0,this}},{key:"setFreeView",value:function(){return this.setView(.25*Math.PI,.25*Math.PI),this.rotationLocked=!1,this}}]),t}(Lore.ControlsBase),Lore.FirstPersonControls=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));o.up=Lore.Vector3f.up(),o.renderer=e,o.camera=e.camera,o.canvas=e.canvas,o.lookAt=lookAt||new Lore.Vector3f,o.camera.position=new Lore.Vector3f(n,n,n),o.camera.updateProjectionMatrix(),o.camera.updateViewMatrix(),o.rotationLocked=!1;var i=o;return o.addEventListener("mousedrag",function(e){i.update(e.e,e.source)}),o.update({x:0,y:0},"left"),o}return _inherits(t,e),_createClass(t,[{key:"update",value:function(e,t){var n=this.camera.position.clone().subtract(this.lookAt);return this.camera.position.copyFrom(this.lookAt).add(n),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this.raiseEvent("updated"),this}}]),t}(Lore.ControlsBase),Lore.CameraBase=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.type="Lore.CameraBase",e.renderer=null,e.isProjectionMatrixStale=!1,e.isViewMatrixStale=!1,e.projectionMatrix=new Lore.ProjectionMatrix,e.viewMatrix=new Lore.Matrix4f,e}return _inherits(t,e),_createClass(t,[{key:"init",value:function(e,t){return this.gl=e,this.program=t,this}},{key:"setLookAt",value:function(e){return this.rotation.lookAt(this.position,e,Lore.Vector3f.up()),this}},{key:"updateViewport",value:function(e,t){return this}},{key:"updateProjectionMatrix",value:function(){return this}},{key:"updateViewMatrix",value:function(){this.update();var e=this.modelMatrix.clone();return e.invert(),this.viewMatrix=e,this.isViewMatrixStale=!0,this}},{key:"getProjectionMatrix",value:function(){return this.projectionMatrix.entries}},{key:"getViewMatrix",value:function(){return this.viewMatrix.entries}},{key:"sceneToScreen",value:function(e,t){var n=e.clone(),o=t.canvas;return n.project(this),[Math.round((n.components[0]+1)*o.width/2),Math.round((1-n.components[1])*o.height/2)]}}]),t}(Lore.Node),Lore.OrthographicCamera=function(e){function t(e,n,o,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.1,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2500;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.type="Lore.OrthographicCamera",a.zoom=1,a.left=e,a.right=n,a.top=o,a.bottom=i,a.near=s,a.far=r,a.updateProjectionMatrix(),a}
return _inherits(t,e),_createClass(t,[{key:"updateProjectionMatrix",value:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,o=(this.top+this.bottom)/2,i=n-e,s=n+e,r=o+t,a=o-t;this.projectionMatrix.setOrthographic(i,s,r,a,this.near,this.far),this.isProjectionMatrixStale=!0}},{key:"updateViewport",value:function(e,t){this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2}}]),t}(Lore.CameraBase),Lore.PerspectiveCamera=function(e){function t(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2500;_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return s.type="Lore.PerspectiveCamera",s.fov=e,s.aspect=n,s.near=o,s.far=i,s.updateProjectionMatrix(),s}return _inherits(t,e),_createClass(t,[{key:"updateProjectionMatrix",value:function(){this.projectionMatrix.setPerspective(this.fov,this.aspect,this.near,this.far),this.isProjectionMatrixStale=!0}},{key:"updateViewport",value:function(e,t){this.aspect=e/t}}]),t}(Lore.CameraBase),Lore.Vector3f=function(){function e(t,n,o){_classCallCheck(this,e),1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(3),this.components[0]=t||0,this.components[1]=n||0,this.components[2]=o||0)}return _createClass(e,[{key:"set",value:function(e,t,n){return this.components[0]=e,this.components[1]=t,this.components[2]=n,this}},{key:"getX",value:function(){return this.components[0]}},{key:"getY",value:function(){return this.components[1]}},{key:"getZ",value:function(){return this.components[2]}},{key:"setX",value:function(e){return this.components[0]=e,this}},{key:"setY",value:function(e){return this.components[1]=e,this}},{key:"setZ",value:function(e){return this.components[2]=e,this}},{key:"setFromSphericalCoords",value:function(e){var t=e.components[0],n=e.components[1],o=e.components[2],i=Math.sin(n)*t;return this.components[0]=Math.sin(o)*i,this.components[1]=Math.cos(n)*t,this.components[2]=Math.cos(o)*i,this}},{key:"copyFrom",value:function(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this}},{key:"setLength",value:function(e){return this.multiplyScalar(e/this.length())}},{key:"lengthSq",value:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"multiply",value:function(e){return this.components[0]*=e.components[0],this.components[1]*=e.components[1],this.components[2]*=e.components[2],this}},{key:"multiplyScalar",value:function(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}},{key:"divide",value:function(e){return this.components[0]/=e.components[0],this.components[1]/=e.components[1],this.components[2]/=e.components[2],this}},{key:"divideScalar",value:function(e){return this.components[0]/=e,this.components[1]/=e,this.components[2]/=e,this}},{key:"add",value:function(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}},{key:"subtract",value:function(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}},{key:"dot",value:function(e){return this.components[0]*e.components[0]+this.components[1]*e.components[1]+this.components[2]*e.components[2]}},{key:"cross",value:function(e){return new Lore.Vector3f(this.components[1]*e.components[2]-this.components[2]*e.components[1],this.components[2]*e.components[0]-this.components[0]*e.components[2],this.components[0]*e.components[1]-this.components[1]*e.components[0])}},{key:"project",value:function(e){return this.applyProjection(Lore.Matrix4f.multiply(e.projectionMatrix,Lore.Matrix4f.invert(e.modelMatrix)))}},{key:"unproject",value:function(e){return this.applyProjection(Lore.Matrix4f.multiply(e.modelMatrix,Lore.Matrix4f.invert(e.projectionMatrix)))}},{key:"applyProjection",value:function(e){var t=this.components[0],n=this.components[1],o=this.components[2],i=e.entries,s=1/(i[3]*t+i[7]*n+i[11]*o+i[15]);return this.components[0]=(i[0]*t+i[4]*n+i[8]*o+i[12])*s,this.components[1]=(i[1]*t+i[5]*n+i[9]*o+i[13])*s,this.components[2]=(i[2]*t+i[6]*n+i[10]*o+i[14])*s,this}},{key:"toDirection",value:function(e){var t=this.components[0],n=this.components[1],o=this.components[2],i=e.entries;return this.components[0]=i[0]*t+i[4]*n+i[8]*o,this.components[1]=i[1]*t+i[5]*n+i[9]*o,this.components[2]=i[2]*t+i[6]*n+i[10]*o,this.normalize(),this}},{key:"applyQuaternion",value:function(e){var t=this.components[0],n=this.components[1],o=this.components[2],i=e.components[0],s=e.components[1],r=e.components[2],a=e.components[3],c=a*t+s*o-r*n,u=a*n+r*t-i*o,h=a*o+i*n-s*t,l=-i*t-s*n-r*o;return this.components[0]=c*a+l*-i+u*-r-h*-s,this.components[1]=u*a+l*-s+h*-i-c*-r,this.components[2]=h*a+l*-r+c*-s-u*-i,this}},{key:"distanceToSq",value:function(e){var t=this.components[0]-e.components[0],n=this.components[1]-e.components[1],o=this.components[2]-e.components[2];return t*t+n*n+o*o}},{key:"distanceTo",value:function(e){return Math.sqrt(this.distanceToSq(e))}},{key:"clone",value:function(){return new Lore.Vector3f(this.components[0],this.components[1],this.components[2])}},{key:"equals",value:function(e){return this.components[0]===e.components[0]&&this.components[1]===e.components[1]&&this.components[2]===e.components[2]}},{key:"toString",value:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}}],[{key:"normalize",value:function(e){return Lore.Vector3f.divideScalar(e,e.length())}},{key:"multiply",value:function(e,t){return new Lore.Vector3f(e.components[0]*t.components[0],e.components[1]*t.components[1],e.components[2]*t.components[2])}},{key:"multiplyScalar",value:function(e,t){return new Lore.Vector3f(e.components[0]*t,e.components[1]*t,e.components[2]*t)}},{key:"divide",value:function(e,t){return new Lore.Vector3f(e.components[0]/t.components[0],e.components[1]/t.components[1],e.components[2]/t.components[2])}},{key:"divideScalar",value:function(e,t){return new Lore.Vector3f(e.components[0]/t,e.components[1]/t,e.components[2]/t)}},{key:"add",value:function(e,t){return new Lore.Vector3f(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2])}},{key:"subtract",value:function(e,t){return new Lore.Vector3f(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2])}},{key:"cross",value:function(e,t){return new Lore.Vector3f(e.components[1]*t.components[2]-e.components[2]*t.components[1],e.components[2]*t.components[0]-e.components[0]*t.components[2],e.components[0]*t.components[1]-e.components[1]*t.components[0])}},{key:"dot",value:function(e,t){return e.components[0]*t.components[0]+e.components[1]*t.components[1]+e.components[2]*t.components[2]}},{key:"forward",value:function(){return new Lore.Vector3f(0,0,1)}},{key:"up",value:function(){return new Lore.Vector3f(0,1,0)}},{key:"right",value:function(){return new Lore.Vector3f(1,0,0)}}]),e}(),Lore.Matrix3f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array([1,0,0,0,1,0,0,0,1]);_classCallCheck(this,e),this.entries=t}return _createClass(e,[{key:"clone",value:function(){return new Lore.Matrix3f(new Float32Array(this.entries))}},{key:"equals",value:function(e){for(var t=0;t<this.entries.length;t++)if(this.entries[t]!==e.entries[t])return!1;return!0}}]),e}(),Lore.Matrix4f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);_classCallCheck(this,e),this.entries=t}return _createClass(e,[{key:"set",value:function(e,t,n,o,i,s,r,a,c,u,h,l,f,m,d,p){return this.entries.set([e,t,n,o,i,s,r,a,c,u,h,l,f,m,d,p]),this}},{key:"multiplyA",value:function(e){var t=this.entries[0],n=this.entries[4],o=this.entries[8],i=this.entries[12],s=this.entries[1],r=this.entries[5],a=this.entries[9],c=this.entries[13],u=this.entries[2],h=this.entries[6],l=this.entries[10],f=this.entries[14],m=this.entries[3],d=this.entries[7],p=this.entries[11],v=this.entries[15],y=e.entries[0],g=e.entries[4],x=e.entries[8],b=e.entries[12],L=e.entries[1],P=e.entries[5],_=e.entries[9],A=e.entries[13],k=e.entries[2],N=e.entries[6],w=e.entries[10],S=e.entries[14],E=e.entries[3],M=e.entries[7],C=e.entries[11],F=e.entries[15];return this.entries[0]=t*y+n*L+o*k+i*E,this.entries[1]=s*y+r*L+a*k+c*E,this.entries[2]=m*y+d*L+p*k+v*E,this.entries[3]=t*g+n*P+o*N+i*M,this.entries[4]=u*y+h*L+l*k+f*E,this.entries[5]=s*g+r*P+a*N+c*M,this.entries[6]=u*g+h*P+l*N+f*M,this.entries[7]=m*g+d*P+p*N+v*M,this.entries[8]=t*x+n*_+o*w+i*C,this.entries[9]=s*x+r*_+a*w+c*C,this.entries[10]=u*x+h*_+l*w+f*C,this.entries[11]=m*x+d*_+p*w+v*C,this.entries[12]=t*b+n*A+o*S+i*F,this.entries[13]=s*b+r*A+a*S+c*F,this.entries[14]=u*b+h*A+l*S+f*F,this.entries[15]=m*b+d*A+p*S+v*F,this}},{key:"multiplyB",value:function(e){var t=e.entries[0],n=e.entries[4],o=e.entries[8],i=e.entries[12],s=e.entries[1],r=e.entries[5],a=e.entries[9],c=e.entries[13],u=e.entries[2],h=e.entries[6],l=e.entries[10],f=e.entries[14],m=e.entries[3],d=e.entries[7],p=e.entries[11],v=e.entries[15],y=this.entries[0],g=this.entries[4],x=this.entries[8],b=this.entries[12],L=this.entries[1],P=this.entries[5],_=this.entries[9],A=this.entries[13],k=this.entries[2],N=this.entries[6],w=this.entries[10],S=this.entries[14],E=this.entries[3],M=this.entries[7],C=this.entries[11],F=this.entries[15];return this.entries[0]=t*y+n*L+o*k+i*E,this.entries[1]=s*y+r*L+a*k+c*E,this.entries[2]=m*y+d*L+p*k+v*E,this.entries[3]=t*g+n*P+o*N+i*M,this.entries[4]=u*y+h*L+l*k+f*E,this.entries[5]=s*g+r*P+a*N+c*M,this.entries[6]=u*g+h*P+l*N+f*M,this.entries[7]=m*g+d*P+p*N+v*M,this.entries[8]=t*x+n*_+o*w+i*C,this.entries[9]=s*x+r*_+a*w+c*C,this.entries[10]=u*x+h*_+l*w+f*C,this.entries[11]=m*x+d*_+p*w+v*C,this.entries[12]=t*b+n*A+o*S+i*F,this.entries[13]=s*b+r*A+a*S+c*F,this.entries[14]=u*b+h*A+l*S+f*F,this.entries[15]=m*b+d*A+p*S+v*F,this}},{key:"scale",value:function(e){var t=e.components[0],n=e.components[1],o=e.components[2];return this.entries[0]*=t,this.entries[1]*=t,this.entries[2]*=t,this.entries[3]*=t,this.entries[4]*=n,this.entries[5]*=n,this.entries[6]*=n,this.entries[7]*=n,this.entries[8]*=o,this.entries[9]*=o,this.entries[10]*=o,this.entries[11]*=o,this}},{key:"setPosition",value:function(e){return this.entries[12]=e.components[0],this.entries[13]=e.components[1],this.entries[14]=e.components[2],this}},{key:"setRotation",value:function(e){var t=e.components[0],n=e.components[1],o=e.components[2],i=e.components[3],s=t+t,r=n+n,a=o+o,c=t*s,u=t*r,h=t*a,l=n*r,f=n*a,m=o*a,d=i*s,p=i*r,v=i*a;return this.entries[0]=1-(l+m),this.entries[1]=u+v,this.entries[2]=h-p,this.entries[4]=u-v,this.entries[5]=1-(c+m),this.entries[6]=f+d,this.entries[8]=h+p,this.entries[9]=f-d,this.entries[10]=1-(c+l),this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[12]=0,this.entries[13]=0,this.entries[14]=0,this.entries[15]=1,this}},{key:"determinant",value:function(){var e=a.entries[0],t=a.entries[4],n=a.entries[8],o=a.entries[12],i=a.entries[1],s=a.entries[5],r=a.entries[9],c=a.entries[13],u=a.entries[2],h=a.entries[6],l=a.entries[10],f=a.entries[14];return a.entries[3]*(o*r*h-n*c*h-o*s*l+t*c*l+n*s*f-t*r*f)+a.entries[7]*(e*r*f-e*c*l+o*i*l-n*i*f+n*c*u-o*r*u)+a.entries[11]*(e*c*h-e*s*f-o*i*h+t*i*f+o*s*u-t*c*u)+a.entries[15]*(-n*s*u-e*r*h+e*s*l+n*i*h-t*i*l+t*r*u)}},{key:"decompose",value:function(e,t,n){var o=(new Lore.Vector3f,new Lore.Matrix4f);position.set(this.entries[12],this.entries[13],this.entries[14]);var i=Math.sqrt(this.entries[0]*this.entries[0]+this.entries[1]*this.entries[1]+this.entries[2]*this.entries[2]),s=Math.sqrt(this.entries[4]*this.entries[4]+this.entries[5]*this.entries[5]+this.entries[6]*this.entries[6]),r=Math.sqrt(this.entries[8]*this.entries[8]+this.entries[9]*this.entries[9]+this.entries[10]*this.entries[10]);this.determinant()<0&&(i=-i),n.set(i,s,r);var a=1/i,c=1/s,u=1/r;return o.entries.set(this.entries),o.entries[0]*=a,o.entries[1]*=a,o.entries[2]*=a,o.entries[4]*=c,o.entries[5]*=c,o.entries[6]*=c,o.entries[8]*=u,o.entries[9]*=u,o.entries[10]*=u,t.setFromMatrix(o),this}},{key:"compose",value:function(e,t,n){return this.setRotation(t),this.scale(n),this.setPosition(e),this}},{key:"invert",value:function(){var e=new Lore.Matrix4f,t=this.entries;e.entries[0]=t[5]*t[10]*t[15]-t[5]*t[11]*t[14]-t[9]*t[6]*t[15]+t[9]*t[7]*t[14]+t[13]*t[6]*t[11]-t[13]*t[7]*t[10],e.entries[4]=-t[4]*t[10]*t[15]+t[4]*t[11]*t[14]+t[8]*t[6]*t[15]-t[8]*t[7]*t[14]-t[12]*t[6]*t[11]+t[12]*t[7]*t[10],e.entries[8]=t[4]*t[9]*t[15]-t[4]*t[11]*t[13]-t[8]*t[5]*t[15]+t[8]*t[7]*t[13]+t[12]*t[5]*t[11]-t[12]*t[7]*t[9],e.entries[12]=-t[4]*t[9]*t[14]+t[4]*t[10]*t[13]+t[8]*t[5]*t[14]-t[8]*t[6]*t[13]-t[12]*t[5]*t[10]+t[12]*t[6]*t[9],e.entries[1]=-t[1]*t[10]*t[15]+t[1]*t[11]*t[14]+t[9]*t[2]*t[15]-t[9]*t[3]*t[14]-t[13]*t[2]*t[11]+t[13]*t[3]*t[10],e.entries[5]=t[0]*t[10]*t[15]-t[0]*t[11]*t[14]-t[8]*t[2]*t[15]+t[8]*t[3]*t[14]+t[12]*t[2]*t[11]-t[12]*t[3]*t[10],e.entries[9]=-t[0]*t[9]*t[15]+t[0]*t[11]*t[13]+t[8]*t[1]*t[15]-t[8]*t[3]*t[13]-t[12]*t[1]*t[11]+t[12]*t[3]*t[9],e.entries[13]=t[0]*t[9]*t[14]-t[0]*t[10]*t[13]-t[8]*t[1]*t[14]+t[8]*t[2]*t[13]+t[12]*t[1]*t[10]-t[12]*t[2]*t[9],e.entries[2]=t[1]*t[6]*t[15]-t[1]*t[7]*t[14]-t[5]*t[2]*t[15]+t[5]*t[3]*t[14]+t[13]*t[2]*t[7]-t[13]*t[3]*t[6],e.entries[6]=-t[0]*t[6]*t[15]+t[0]*t[7]*t[14]+t[4]*t[2]*t[15]-t[4]*t[3]*t[14]-t[12]*t[2]*t[7]+t[12]*t[3]*t[6],e.entries[10]=t[0]*t[5]*t[15]-t[0]*t[7]*t[13]-t[4]*t[1]*t[15]+t[4]*t[3]*t[13]+t[12]*t[1]*t[7]-t[12]*t[3]*t[5],e.entries[14]=-t[0]*t[5]*t[14]+t[0]*t[6]*t[13]+t[4]*t[1]*t[14]-t[4]*t[2]*t[13]-t[12]*t[1]*t[6]+t[12]*t[2]*t[5],e.entries[3]=-t[1]*t[6]*t[11]+t[1]*t[7]*t[10]+t[5]*t[2]*t[11]-t[5]*t[3]*t[10]-t[9]*t[2]*t[7]+t[9]*t[3]*t[6],e.entries[7]=t[0]*t[6]*t[11]-t[0]*t[7]*t[10]-t[4]*t[2]*t[11]+t[4]*t[3]*t[10]+t[8]*t[2]*t[7]-t[8]*t[3]*t[6],e.entries[11]=-t[0]*t[5]*t[11]+t[0]*t[7]*t[9]+t[4]*t[1]*t[11]-t[4]*t[3]*t[9]-t[8]*t[1]*t[7]+t[8]*t[3]*t[5],e.entries[15]=t[0]*t[5]*t[10]-t[0]*t[6]*t[9]-t[4]*t[1]*t[10]+t[4]*t[2]*t[9]+t[8]*t[1]*t[6]-t[8]*t[2]*t[5];var n=t[0]*e.entries[0]+t[1]*e.entries[4]+t[2]*e.entries[8]+t[3]*e.entries[12];if(0==n)throw"Determinant is zero.";n=1/n;for(var o=0;o<16;o++)this.entries[o]=e.entries[o]*n;return this}},{key:"clone",value:function(){return new Lore.Matrix4f(new Float32Array(this.entries))}},{key:"equals",value:function(e){for(var t=0;t<this.entries.length;t++)if(this.entries[t]!==e.entries[t])return!1;return!0}},{key:"toString",value:function(){var e=this.entries[0]+", "+this.entries[4]+", "+this.entries[8]+", "+this.entries[12]+"\n";return e+=this.entries[1]+", "+this.entries[5]+", "+this.entries[9]+", "+this.entries[13]+"\n",e+=this.entries[2]+", "+this.entries[6]+", "+this.entries[10]+", "+this.entries[14]+"\n",e+=this.entries[3]+", "+this.entries[7]+", "+this.entries[11]+", "+this.entries[15]+"\n"}}],[{key:"multiply",value:function(e,t){var n=e.entries[0],o=e.entries[4],i=e.entries[8],s=e.entries[12],r=e.entries[1],a=e.entries[5],c=e.entries[9],u=e.entries[13],h=e.entries[2],l=e.entries[6],f=e.entries[10],m=e.entries[14],d=e.entries[3],p=e.entries[7],v=e.entries[11],y=e.entries[15],g=t.entries[0],x=t.entries[4],b=t.entries[8],L=t.entries[12],P=t.entries[1],_=t.entries[5],A=t.entries[9],k=t.entries[13],N=t.entries[2],w=t.entries[6],S=t.entries[10],E=t.entries[14],M=t.entries[3],C=t.entries[7],F=t.entries[11],T=t.entries[15];return new Lore.Matrix4f(new Float32Array([n*g+o*P+i*N+s*M,r*g+a*P+c*N+u*M,h*g+l*P+f*N+m*M,d*g+p*P+v*N+y*M,n*x+o*_+i*w+s*C,r*x+a*_+c*w+u*C,h*x+l*_+f*w+m*C,d*x+p*_+v*w+y*C,n*b+o*A+i*S+s*F,r*b+a*A+c*S+u*F,h*b+l*A+f*S+m*F,d*b+p*A+v*S+y*F,n*L+o*k+i*E+s*T,r*L+a*k+c*E+u*T,h*L+l*k+f*E+m*T,d*L+p*k+v*E+y*T]))}},{key:"fromQuaternion",value:function(e){var t=e.components[0],n=e.components[1],o=e.components[2],i=e.components[3],s=t+t,r=n+n,a=o+o,c=t*s,u=t*r,h=t*a,l=n*r,f=n*a,m=o*a,d=i*s,p=i*r,v=i*a;return new Lore.Matrix4f(new Float32Array([1-(l+m),u+v,h-p,0,u-v,1-(c+m),f+d,0,h+p,f-d,1-(c+l),0,0,0,0,1]))}},{key:"lookAt",value:function(e,t,n){var o=Lore.Vector3f.subtract(e,t).normalize();0===o.lengthSq()&&(o.components[2]=1);var i=Lore.Vector3f.cross(n,o).normalize();0===i.lengthSq()&&(o.components[2]+=1e-4,i=Lore.Vector3f.cross(n,o).normalize());var s=Lore.Vector3f.cross(o,i);return new Lore.Matrix4f(new Float32Array([i.components[0],i.components[1],i.components[2],0,s.components[0],s.components[1],s.components[2],0,o.components[0],o.components[1],o.components[2],0,0,0,0,1]))}},{key:"compose",value:function(e,t,n){var o=new Lore.Matrix4f;return o.setRotation(t),o.scale(n),o.setPosition(e),o}},{key:"invert",value:function(e){var t=new Lore.Matrix4f,n=e.entries;t.entries[0]=n[5]*n[10]*n[15]-n[5]*n[11]*n[14]-n[9]*n[6]*n[15]+n[9]*n[7]*n[14]+n[13]*n[6]*n[11]-n[13]*n[7]*n[10],t.entries[4]=-n[4]*n[10]*n[15]+n[4]*n[11]*n[14]+n[8]*n[6]*n[15]-n[8]*n[7]*n[14]-n[12]*n[6]*n[11]+n[12]*n[7]*n[10],t.entries[8]=n[4]*n[9]*n[15]-n[4]*n[11]*n[13]-n[8]*n[5]*n[15]+n[8]*n[7]*n[13]+n[12]*n[5]*n[11]-n[12]*n[7]*n[9],t.entries[12]=-n[4]*n[9]*n[14]+n[4]*n[10]*n[13]+n[8]*n[5]*n[14]-n[8]*n[6]*n[13]-n[12]*n[5]*n[10]+n[12]*n[6]*n[9],t.entries[1]=-n[1]*n[10]*n[15]+n[1]*n[11]*n[14]+n[9]*n[2]*n[15]-n[9]*n[3]*n[14]-n[13]*n[2]*n[11]+n[13]*n[3]*n[10],t.entries[5]=n[0]*n[10]*n[15]-n[0]*n[11]*n[14]-n[8]*n[2]*n[15]+n[8]*n[3]*n[14]+n[12]*n[2]*n[11]-n[12]*n[3]*n[10],t.entries[9]=-n[0]*n[9]*n[15]+n[0]*n[11]*n[13]+n[8]*n[1]*n[15]-n[8]*n[3]*n[13]-n[12]*n[1]*n[11]+n[12]*n[3]*n[9],t.entries[13]=n[0]*n[9]*n[14]-n[0]*n[10]*n[13]-n[8]*n[1]*n[14]+n[8]*n[2]*n[13]+n[12]*n[1]*n[10]-n[12]*n[2]*n[9],t.entries[2]=n[1]*n[6]*n[15]-n[1]*n[7]*n[14]-n[5]*n[2]*n[15]+n[5]*n[3]*n[14]+n[13]*n[2]*n[7]-n[13]*n[3]*n[6],t.entries[6]=-n[0]*n[6]*n[15]+n[0]*n[7]*n[14]+n[4]*n[2]*n[15]-n[4]*n[3]*n[14]-n[12]*n[2]*n[7]+n[12]*n[3]*n[6],t.entries[10]=n[0]*n[5]*n[15]-n[0]*n[7]*n[13]-n[4]*n[1]*n[15]+n[4]*n[3]*n[13]+n[12]*n[1]*n[7]-n[12]*n[3]*n[5],t.entries[14]=-n[0]*n[5]*n[14]+n[0]*n[6]*n[13]+n[4]*n[1]*n[14]-n[4]*n[2]*n[13]-n[12]*n[1]*n[6]+n[12]*n[2]*n[5],t.entries[3]=-n[1]*n[6]*n[11]+n[1]*n[7]*n[10]+n[5]*n[2]*n[11]-n[5]*n[3]*n[10]-n[9]*n[2]*n[7]+n[9]*n[3]*n[6],t.entries[7]=n[0]*n[6]*n[11]-n[0]*n[7]*n[10]-n[4]*n[2]*n[11]+n[4]*n[3]*n[10]+n[8]*n[2]*n[7]-n[8]*n[3]*n[6],t.entries[11]=-n[0]*n[5]*n[11]+n[0]*n[7]*n[9]+n[4]*n[1]*n[11]-n[4]*n[3]*n[9]-n[8]*n[1]*n[7]+n[8]*n[3]*n[5],t.entries[15]=n[0]*n[5]*n[10]-n[0]*n[6]*n[9]-n[4]*n[1]*n[10]+n[4]*n[2]*n[9]+n[8]*n[1]*n[6]-n[8]*n[2]*n[5];var o=n[0]*t.entries[0]+n[1]*t.entries[4]+n[2]*t.entries[8]+n[3]*t.entries[12];if(0==o)throw"Determinant is zero.";o=1/o;for(var i=0;i<16;i++)t.entries[i]=t.entries[i]*o;return t}}]),e}(),Lore.Quaternion=function(){function e(t,n,o,i){_classCallCheck(this,e),1===arguments.length?this.components=new Float32Array(t):2===arguments.length?(this.components=new Float32Array(4),this.setFromAxisAngle(t,n)):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=n||0,this.components[2]=o||0,this.components[3]=void 0!==i?i:1)}return _createClass(e,[{key:"getX",value:function(){return this.components[0]}},{key:"getY",value:function(){return this.components[1]}},{key:"getZ",value:function(){return this.components[2]}},{key:"getW",value:function(){return this.components[3]}},{key:"set",value:function(e,t,n,o){return this.components[0]=e,this.components[1]=t,this.components[2]=n,this.components[3]=o,this}},{key:"setX",value:function(e){return this.components[0]=e,this}},{key:"setY",value:function(e){return this.components[1]=e,this}},{key:"setZ",value:function(e){return this.components[2]=e,this}},{key:"setW",value:function(e){return this.components[3]=e,this}},{key:"setFromAxisAngle",value:function(e,t){var n=Lore.Vector3f.normalize(e),o=t/2,i=Math.sin(o);return this.components[0]=n.components[0]*i,this.components[1]=n.components[1]*i,this.components[2]=n.components[2]*i,this.components[3]=Math.cos(o),this}},{key:"setFromUnitVectors",value:function(e,t){var n=null,o=e.dot(t)+1;return o<1e-6?(n=new Lore.Vector3f,o=0,Math.abs(e.components[0])>Math.abs(e.components[2])?n.set(-e.components[1],e.components[0],0):n.set(0,-e.components[2],e.components[1])):n=Lore.Vector3f.cross(e,t),this.set(n.components[0],n.components[1],n.components[2],o),this.normalize(),this}},{key:"lookAt",value:function(e,t,n){return this.setFromMatrix(Lore.Matrix4f.lookAt(e,t,n)),this}},{key:"lengthSq",value:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]+this.components[3]*this.components[3]}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"inverse",value:function(){return this.conjugate().normalize()}},{key:"normalize",value:function(){var e=this.length();if(0===e)this.components[0]=0,this.components[1]=0,this.components[2]=0,this.components[3]=1;else{var t=1/e;this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this.components[3]*=t}return this}},{key:"dot",value:function(e){return this.components[0]*e.components[0]+this.components[1]*e.components[1]+this.components[2]*e.components[2]+this.components[3]*e.components[3]}},{key:"multiplyA",value:function(e){var t=this.components[0]*e.components[3]+this.components[3]*e.components[0]+this.components[1]*e.components[2]-this.components[2]*e.components[1],n=this.components[1]*e.components[3]+this.components[3]*e.components[1]+this.components[2]*e.components[0]-this.components[0]*e.components[2],o=this.components[2]*e.components[3]+this.components[3]*e.components[2]+this.components[0]*e.components[1]-this.components[1]*e.components[0],i=this.components[3]*e.components[3]-this.components[0]*e.components[0]-this.components[1]*e.components[1]-this.components[2]*e.components[2];return this.components[0]=t,this.components[1]=n,this.components[2]=o,this.components[3]=i,this}},{key:"multiplyB",value:function(e){var t=e.components[0]*this.components[3]+e.components[3]*this.components[0]+e.components[1]*this.components[2]-e.components[2]*this.components[1],n=e.components[1]*this.components[3]+e.components[3]*this.components[1]+e.components[2]*this.components[0]-e.components[0]*this.components[2],o=e.components[2]*this.components[3]+e.components[3]*this.components[2]+e.components[0]*this.components[1]-e.components[1]*this.components[0],i=e.components[3]*this.components[3]-e.components[0]*this.components[0]-e.components[1]*this.components[1]-e.components[2]*this.components[2];return this.components[0]=t,this.components[1]=n,this.components[2]=o,this.components[3]=i,this}},{key:"multiplyScalar",value:function(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e,this}},{key:"conjugate",value:function(){return this.components[0]*=-1,this.components[1]*=-1,this.components[2]*=-1,this}},{key:"add",value:function(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this.components[3]+=e.components[3],this}},{key:"subtract",value:function(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this.components[3]-=e.components[3],this}},{key:"rotateX",value:function(e){var t=e/2;return this.multiplyA(new Lore.Quaternion(Math.sin(t),0,0,Math.cos(t)))}},{key:"rotateY",value:function(e){var t=e/2;return this.multiplyA(new Lore.Quaternion(0,Math.sin(t),0,Math.cos(t)))}},{key:"rotateZ",value:function(e){var t=e/2;return this.multiplyA(new Lore.Quaternion(0,0,Math.sin(t),Math.cos(t)))}},{key:"toAxisAngle",value:function(){console.warn("The method toAxisAngle() has not been implemented.")}},{key:"toRotationMatrix",value:function(){var e=this.components[0],t=this.components[1],n=this.components[2],o=this.components[3],i=e*e,s=e*t,r=e*n,a=e*o,c=t*o,u=t*t,h=t*n,l=n*n,f=n*o,m=new Lore.Matrix4f;return m.entries[0]=1-2*(u+l),m.entries[1]=2*(s+f),m.entries[2]=2*(r-c),m.entries[4]=2*(h-f),m.entries[5]=1-2*(i+l),m.entries[6]=2*(h+a),m.entries[8]=2*(r+c),m.entries[9]=2*(h-a),m.entries[10]=1-2*(i+u),m}},{key:"setFromMatrix",value:function(e){var t=e.entries[0],n=e.entries[4],o=e.entries[8],i=e.entries[1],s=e.entries[5],r=e.entries[9],a=e.entries[2],c=e.entries[6],u=e.entries[10],h=t+s+u;if(h>0){var l=.5/Math.sqrt(h+1);this.components[0]=(c-r)*l,this.components[1]=(o-a)*l,this.components[2]=(i-n)*l,this.components[3]=.25/l}else if(t>s&&t>u){var f=2*Math.sqrt(1+t-s-u);this.components[0]=.25*f,this.components[1]=(n+i)/f,this.components[2]=(o+a)/f,this.components[3]=(c-r)/f}else if(s>u){var m=2*Math.sqrt(1+s-t-u);this.components[0]=(n+i)/m,this.components[1]=.25*m,this.components[2]=(r+c)/m,this.components[3]=(o-a)/m}else{var d=2*Math.sqrt(1+u-t-s);this.components[0]=(o+a)/d,this.components[1]=(r+c)/d,this.components[2]=.25*d,this.components[3]=(i-n)/d}return this}},{key:"clone",value:function(){return new Lore.Quaternion(this.components[0],this.components[1],this.components[2],this.components[3])}},{key:"equals",value:function(e){return this.components[0]===e.components[0]&&this.components[1]===e.components[1]&&this.components[2]===e.components[2]&&this.components[3]===e.components[3]}},{key:"toString",value:function(){return"x: "+this.getX()+", y: "+this.getY()+", z: "+this.getZ()+", w: "+this.getW()}}],[{key:"dot",value:function(e,t){return new Lore.Quaternion(e.components[0]*t.components[0]+e.components[1]*t.components[1]+e.components[2]*t.components[2]+e.components[3]*t.components[3])}},{key:"multiply",value:function(e,t){return new Lore.Quaternion(e.components[0]*t.components[3]+e.components[3]*t.components[0]+e.components[1]*t.components[2]-e.components[2]*t.components[1],e.components[1]*t.components[3]+e.components[3]*t.components[1]+e.components[2]*t.components[0]-e.components[0]*t.components[2],e.components[2]*t.components[3]+e.components[3]*t.components[2]+e.components[0]*t.components[1]-e.components[1]*t.components[0],e.components[3]*t.components[3]+e.components[0]*t.components[0]+e.components[1]*t.components[1]-e.components[2]*t.components[2])}},{key:"multiplyScalar",value:function(e,t){return new Lore.Quaternion(e.components[0]*t,e.components[1]*t,e.components[2]*t,e.components[3]*t)}},{key:"inverse",value:function(e){return new Lore.Quaternion(e.components).conjugate().normalize()}},{key:"normalize",value:function(e){var t=e.length();if(0===t)return new Lore.Quaternion(0,0,0,1);var n=1/t;return new Lore.Quaternion(e.components[0]*n,e.components[1]*n,e.components[2]*n,e.components[3]*n)}},{key:"conjugate",value:function(e){return new Lore.Quaternion(-1*e.components[0],-1*e.components[1],-1*e.components[2],e.components[3])}},{key:"add",value:function(e,t){return new Lore.Quaternion(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2],e.components[3]+t.components[3])}},{key:"subtract",value:function(e,t){return new Lore.Quaternion(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2],e.components[3]-t.components[3])}},{key:"fromMatrix",value:function(e){var t=new Lore.Quaternion;return t.setFromMatrix(e),t}},{key:"slerp",value:function(e,t,n){if(0===n)return new Lore.Quaternion(e.components);if(1===n)return new Lore.Quaternion(t.components);var o=new Lore.Quaternion(t.components),i=e.components[0]*o.components[0]+e.components[1]*o.components[1]+e.components[2]*o.components[2]+e.components[3]*o.components[3];if(i<0&&(o.multiplyScalar(-1),i=-i),Math.abs(i)>=1)return new Lore.Quaternion(e.components);var s=Math.acos(i),r=sqrt(1-i*i);if(Math.abs(r)<.001)return new Lore.Quaternion(.5*e.components[0]+.5*o.components[0],.5*e.components[1]+.5*o.components[1],.5*e.components[2]+.5*o.components[2],.5*e.components[3]+.5*o.components[3]);var a=Math.sin((1-n)*s)/r,c=Math.sin(n*s)/r;return new Lore.Quaternion(e.components[0]*a+o.components[0]*c,e.components[1]*a+o.components[1]*c,e.components[2]*a+o.components[2]*c,e.components[3]*a+o.components[3]*c)}}]),e}(),Lore.SphericalCoords=function(){function e(t,n,o){_classCallCheck(this,e),this.components=new Float32Array(3),this.radius=void 0!==t?t:1,this.phi=n||0,this.theta=o||0}return _createClass(e,[{key:"set",value:function(e,t,n){return this.components[0]=e,this.components[1]=t,this.components[2]=n,this}},{key:"secure",value:function(){return this.components[1]=Math.max(1e-6,Math.min(Math.PI-1e-6,this.components[1])),this}},{key:"setFromVector",value:function(e){return this.components[0]=e.length(),0===this.components[0]?(this.components[1]=0,this.components[2]=0):(this.components[1]=Math.acos(Math.max(-1,Math.min(1,e.components[1]/this.components[0]))),this.components[2]=Math.atan2(e.components[0],e.components[2])),this}},{key:"limit",value:function(e,t,n,o){return this.components[1]=Math.max(e,Math.min(t,this.components[1])),this.components[2]=Math.max(n,Math.min(o,this.components[2])),this}},{key:"clone",value:function(){return new Lore.SphericalCoords(this.radius,this.phi,this.theta)}},{key:"toString",value:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}}]),e}(),Lore.ProjectionMatrix=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"setOrthographic",value:function(e,t,n,o,i,s){var r=1/(t-e),a=1/(n-o),c=1/(s-i),u=(t+e)*r,h=(n+o)*a,l=(s+i)*c;return this.set(),this.entries[0]=2*r,this.entries[4]=0,this.entries[8]=0,this.entries[12]=-u,this.entries[1]=0,this.entries[5]=2*a,this.entries[9]=0,this.entries[13]=-h,this.entries[2]=0,this.entries[6]=0,this.entries[10]=-2*c,this.entries[14]=-l,this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[15]=1,this}},{key:"setPerspective",value:function(e,t,n,o){var i=Math.tan(Lore.Utils.DEG2RAD*e/2),s=n*i,r=2*s,a=t*r,c=-a/2,u=c+a,h=s-r,l=2*n/(u-c),f=2*n/(s-h),m=(u+c)/(u-c),d=(s+h)/(s-h),p=(o+n)/(o-n),v=-2*o*n/(o-n);return this.set(),this.entries[0]=l,this.entries[4]=0,this.entries[8]=m,this.entries[12]=0,this.entries[1]=0,this.entries[5]=f,this.entries[9]=d,this.entries[13]=0,this.entries[2]=0,this.entries[6]=0,this.entries[10]=p,this.entries[14]=v,this.entries[3]=0,this.entries[7]=0,this.entries[11]=-1,this.entries[15]=0,this}}]),t}(Lore.Matrix4f),Lore.Statistics=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"randomNormal",value:function(){var e=void 0,t=void 0,n=void 0,o=void 0,i=void 0;if(null!==Lore.Statistics.spareRandomNormal)e=Lore.Statistics.spareRandomNormal,Lore.Statistics.spareRandomNormal=null;else{do{t=2*Math.random()-1,n=2*Math.random()-1,o=t*t+n*n}while(0===o||o>=1);i=Math.sqrt(-2*Math.log(o)/o),e=t*i,Lore.Statistics.spareRandomNormal=n*i}return e/14}},{key:"randomNormalInRange",value:function(e,t){var n=void 0;do{n=Lore.Statistics.randomNormal()}while(n<e||n>t);return n}},{key:"randomNormalScaled",value:function(e,t){return Lore.Statistics.randomNormalInRange(-1,1)*t+e}},{key:"normalize",value:function(e){for(var t=Number.MIN_VALUE,n=Number.MAX_VALUE,o=0;o<e.length;o++){var i=e[o];i>t&&(t=i),i<n&&(n=i)}for(var s=t-n,r=0;r<e.length;r++)e[r]=(e[r]-n)/s;return[n,t]}},{key:"scale",value:function(e,t,n,o,i){return(i-o)*(e-t)/(n-t)+o}}]),e}(),Lore.Statistics.spareRandomNormal=null,Lore.Ray=function(){function e(t,n){_classCallCheck(this,e),this.source=t||new Lore.Vector3f,this.direction=n||new Lore.Vector3f}return _createClass(e,[{key:"copyFrom",value:function(e){return this.source.copyFrom(e.source),this.direction.copyFrom(e.direction),this}},{key:"applyProjection",value:function(e){
return this.direction.add(this.source).applyProjection(e),this.source.applyProjection(e),this.direction.subtract(this.source),this.direction.normalize(),this}},{key:"distanceSqToPoint",value:function(e){var t=Lore.Vector3f.subtract(e,this.source),n=t.dot(this.direction);return n<0?this.source.distanceToSq(e):(t.copyFrom(this.direction).multiplyScalar(n).add(this.source),t.distanceToSq(e))}},{key:"closestPointToPoint",value:function(e){var t=Lore.Vector3f.subtract(e,this.source),n=t.dot(this.direction);return n<0?t.copyFrom(this.source):t.copyFrom(this.direction).multiplyScalar(n).add(this.source)}}]),e}();var RadixSort=function(){function e(){_classCallCheck(this,e),this.max=void 0,this.mask=void 0,this.histograms=void 0,this.indices=void 0,this.tmpIndices=void 0}return _createClass(e,[{key:"sort",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=null;t?(n=new e.constructor(e.length),n.set(e)):n=e,this.max=2048,this.mask=this.max-1,this.histograms=new Int32Array(this.max*Math.ceil(64/11));var o=new Int32Array(n.buffer,n.byteOffset,n.byteLength>>2),i=Math.ceil(8*n.BYTES_PER_ELEMENT/11),s=this.max*(i-1),r=1<<(8*n.BYTES_PER_ELEMENT-1)%11,a=(r<<1)-1,c=null,u=new o.constructor(o.length);this.indices=new Uint32Array(o.length),this.tmpIndices=new Uint32Array(o.length);for(var h=(new Uint32Array(o.length),this.max*i),l=0;l<h;l++)this.histograms[l]=0;this.initHistograms(o,s,a);for(var f=0;f<=s;f+=this.max)for(var m=0,d=f;d<f+this.max;d++){var p=this.histograms[d]+m;this.histograms[d]=m-1,m=p}return this.lsbPass(o,u),c=u,u=o,o=c,this.pass(o,u),c=u,u=o,o=c,this.msbPass(o,u,r),{array:new Float32Array(u.buffer,u.byteOffset,n.length),indices:this.indices}}},{key:"lsbPass",value:function(e,t){for(var n=0,o=e.length;n<o;n++){var i=e[n];i^=2147483648|i>>31;var s=++this.histograms[i&this.mask];this.indices[s]=n,t[s]=i}}},{key:"pass",value:function(e,t){for(var n=e.length,o=0;o<n;o++){var i=e[o],s=++this.histograms[this.max+(i>>>11&this.mask)];this.tmpIndices[s]=this.indices[o],t[s]=i}this.indices.set(this.tmpIndices)}},{key:"msbPass",value:function(e,t,n){for(var o=(n<<1)-1,i=e.length,s=2*this.max,r=0;r<i;r++){var a=e[r],c=a>>31,u=++this.histograms[s+(a>>>22&o)];this.tmpIndices[u]=this.indices[r],t[u]=a^(2147483648|~c)}this.indices.set(this.tmpIndices)}},{key:"initHistograms",value:function(e,t,n){for(var o=e.length,i=0;i<o;i++){var s=e[i];s^=2147483648|s>>31;for(var r=0,a=0;r<t;r+=this.max,a+=11)this.histograms[r+(s>>>a&this.mask)]++;this.histograms[r+(s>>>a&n)]++}}}]),e}();Lore.HelperBase=function(e){function t(e,n,o){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.renderer=e,i.shader=Lore.Shaders[o],i.geometry=i.renderer.createGeometry(n,o),i}return _inherits(t,e),_createClass(t,[{key:"setAttribute",value:function(e,t){this.geometry.addAttribute(e,t)}},{key:"getAttribute",value:function(e){return this.geometry.attributes[e].data}},{key:"updateAttribute",value:function(e,t,n){for(var o=this.geometry.attributes[e],i=t*o.attributeLength,s=0;s<o.attributeLength;s++)o.data[i+s]=n[s]||o.data[i+s];o.stale=!0}},{key:"updateAttributeAll",value:function(e,t){for(var n=this.geometry.attributes[e],o=0;o<n.data.length;o++)n.data[o]=t[o];n.stale=!0}},{key:"draw",value:function(){this.geometry.draw(this.renderer)}},{key:"destruct",value:function(){}}]),t}(Lore.Node),Lore.PointHelper=function(e){function t(e,n,o,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,o)),r={octree:!0,octreeThreshold:500,octreeMaxDepth:8,pointScale:1,maxPointSize:100};return s.opts=Lore.Utils.extend(!0,r,i),s.indices=null,s.octree=null,s.geometry.setMode(Lore.DrawModes.points),s.initPointSize(),s.filters={},s.pointSize=1*s.opts.pointScale,s.dimensions={min:new Lore.Vector3f(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),max:new Lore.Vector3f(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)},s}return _inherits(t,e),_createClass(t,[{key:"getMaxLength",value:function(e,t,n){return Math.max(e.length,Math.max(t.length,n.length))}},{key:"getDimensions",value:function(){return this.dimensions}},{key:"getCenter",value:function(){return new Lore.Vector3f((this.dimensions.max.getX()+this.dimensions.min.getX())/2,(this.dimensions.max.getY()+this.dimensions.min.getY())/2,(this.dimensions.max.getZ()+this.dimensions.min.getZ())/2)}},{key:"setPositions",value:function(e){return this.setAttribute("position",e),this}},{key:"setPositionsXYZ",value:function(e,t,n,o){for(var i=new Float32Array(3*o),s=0;s<o;s++){var r=3*s;i[r]=e[s]||0,i[r+1]=t[s]||0,i[r+2]=n[s]||0,e[s]>this.dimensions.max.getX()&&this.dimensions.max.setX(e[s]),e[s]<this.dimensions.min.getX()&&this.dimensions.min.setX(e[s]),t[s]>this.dimensions.max.getY()&&this.dimensions.max.setY(t[s]),t[s]<this.dimensions.min.getY()&&this.dimensions.min.setY(t[s]),n[s]>this.dimensions.max.getZ()&&this.dimensions.max.setZ(n[s]),n[s]<this.dimensions.min.getZ()&&this.dimensions.min.setZ(n[s])}if(this.opts.octree){for(var a=Lore.AABB.fromPoints(i),c=new Uint32Array(o),s=0;s<o;s++)c[s]=s;this.octree=new Lore.Octree(this.opts.octreeThreshold,this.opts.octreeMaxDepth),this.octree.build(c,i,a)}return this.setAttribute("position",i),this}},{key:"setPositionsXYZHSS",value:function(e,t,n,o,i,s){var r=this.getMaxLength(e,t,n);if(this.setPositionsXYZ(e,t,n,r),"number"==typeof o&&"number"==typeof i&&"number"==typeof s)this.setHSS(o,i,s,r);else if("number"!=typeof o&&"number"!=typeof i&&"number"!=typeof s)this.setHSSFromArrays(o,i,s,r);else{if("number"==typeof o){var a=new Float32Array(r);a.fill(o),o=a}if("number"==typeof i){var c=new Float32Array(r);c.fill(i),i=c}if("number"==typeof s){var u=new Float32Array(r);u.fill(s),s=u}this.setHSSFromArrays(o,i,s,r)}return this.renderer.camera.updateProjectionMatrix(),this.renderer.camera.updateViewMatrix(),this}},{key:"setRGB",value:function(e,t,n){for(var o=new Float32Array(3*e.length),i=this.getAttribute("color"),s=0;s<e.length;s++){var r=3*s;o[r]=e[s],o[r+1]=t[s],o[r+2]=n[s]}for(var a=0;a<o.length;a+=3){var c=o[a],u=o[a+1],h=o[a+2];o[a]=Lore.Color.rgbToHsl(c,u,h)[0],o[a+1]=i[1],o[a+2]=i[2]}return this.updateColors(o),this}},{key:"setColors",value:function(e){return this.setAttribute("color",e),this}},{key:"updateColors",value:function(e){return this.updateAttributeAll("color",e),this}},{key:"updateColor",value:function(e,t){return this.updateAttribute("color",e,t.components),this}},{key:"setPointSize",value:function(e){var t=e*this.opts.pointScale;return t>this.opts.maxPointSize?this.pointSize=this.opts.maxPointSize:this.pointSize=t,this.geometry.shader.uniforms.size.value=this.pointSize,t>this.opts.maxPointSize?this.opts.maxPointSize/t*.5:.5}},{key:"getPointSize",value:function(){return this.geometry.shader.uniforms.size.value}},{key:"getPointScale",value:function(){return this.opts.pointScale}},{key:"setFogDistance",value:function(e,t){return this.geometry.shader.uniforms.fogStart.value=e,this.geometry.shader.uniforms.fogEnd.value=t,this}},{key:"initPointSize",value:function(){return this.setPointSize(this.renderer.camera.zoom+.1),this}},{key:"getCutoff",value:function(){return this.geometry.shader.uniforms.cutoff.value}},{key:"setCutoff",value:function(e){return this.geometry.shader.uniforms.cutoff.value=e,this}},{key:"getHue",value:function(e){return this.getAttribute("color")[3*e]}},{key:"getPosition",value:function(e){var t=this.getAttribute("position");return new Lore.Vector3f(t[3*e],t[3*e+1],t[3*e+2])}},{key:"setHSS",value:function(e,t,n,o){for(var i=new Float32Array(3*o),s=0;s<3*o;s+=3)i[s]=e,i[s+1]=t,i[s+2]=n;this.setColors(i)}},{key:"setHSSFromArrays",value:function(e,t,n,o){var i=new Float32Array(3*o),s=0;if(e.length!==o&&t.length!==o&&n.length!==o)throw'Hue, saturation and size have to be arrays of length "length" ('+o+").";for(var r=0;r<3*o;r+=3)i[r]=e[s],i[r+1]=t[s],i[r+2]=n[s],s++;this.setColors(i)}},{key:"addFilter",value:function(e,t){return t.setGeometry(this.geometry),this.filters[e]=t,this}},{key:"removeFilter",value:function(e){return delete this.filters[e],this}},{key:"getFilter",value:function(e){return this.filters[e]}}]),t}(Lore.HelperBase),Lore.TreeHelper=function(e){function t(e,n,o,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,o));return s.defaults={pointScale:1,maxPointSize:100},s.opts=Lore.Utils.extend(!0,s.defaults,i),s.indices=null,s.geometry.setMode(Lore.DrawModes.lines),s.initPointSize(),s.filters={},s}return _inherits(t,e),_createClass(t,[{key:"getMaxLength",value:function(e,t,n){return Math.max(e.length,Math.max(t.length,n.length))}},{key:"setPositions",value:function(e){this.setAttribute("position",e)}},{key:"setPositionsXYZ",value:function(e,t,n,o){for(var i=new Float32Array(3*o),s=0;s<o;s++){var r=3*s;i[r]=e[s]||0,i[r+1]=t[s]||0,i[r+2]=n[s]||0}this.setAttribute("position",i)}},{key:"setPositionsXYZHSS",value:function(e,t,n,o,i,s){var r=this.getMaxLength(e,t,n);this.setPositionsXYZ(e,t,n,r),this.setHSS(o,i,s,r)}},{key:"setColors",value:function(e){this.setAttribute("color",e)}},{key:"updateColors",value:function(e){this.updateAttributeAll("color",e)}},{key:"updateColor",value:function(e,t){this.updateAttribute("color",e,t.components)}},{key:"setPointSize",value:function(e){e*this.opts.pointScale>this.opts.maxPointSize||(this.geometry.shader.uniforms.size.value=e*this.opts.pointScale)}},{key:"getPointSize",value:function(){return this.geometry.shader.uniforms.size.value}},{key:"setFogDistance",value:function(e,t){this.geometry.shader.uniforms.fogStart.value=e,this.geometry.shader.uniforms.fogEnd.value=t}},{key:"initPointSize",value:function(){this.geometry.shader.uniforms.size.value=this.renderer.camera.zoom*this.opts.pointScale}},{key:"getCutoff",value:function(){return this.geometry.shader.uniforms.cutoff.value}},{key:"setCutoff",value:function(e){this.geometry.shader.uniforms.cutoff.value=e}},{key:"getHue",value:function(e){return this.getAttribute("color")[3*e]}},{key:"setHSS",value:function(e,t,n,o){for(var i=new Float32Array(3*o),s=0;s<3*o;s+=3)i[s]=e,i[s+1]=t,i[s+2]=n;this.setColors(i)}},{key:"addFilter",value:function(e,t){t.setGeometry(this.geometry),this.filters[e]=t}},{key:"removeFilter",value:function(e){delete this.filters[e]}},{key:"getFilter",value:function(e){return this.filters[e]}}]),t}(Lore.HelperBase),Lore.CoordinatesHelper=function(e){function t(e,n,o,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,o));return s.defaults={position:new Lore.Vector3f,axis:{x:{length:50,color:Lore.Color.fromHex("#222222")},y:{length:50,color:Lore.Color.fromHex("#222222")},z:{length:50,color:Lore.Color.fromHex("#222222")}},ticks:{enabled:!0,x:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#1f1f1f")},y:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#1f1f1f")},z:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#1f1f1f")}},box:{enabled:!0,x:{color:Lore.Color.fromHex("#222222")},y:{color:Lore.Color.fromHex("#222222")},z:{color:Lore.Color.fromHex("#222222")}}},s.opts=Lore.Utils.extend(!0,s.defaults,i),s.geometry.setMode(Lore.DrawModes.lines),s.init(),s}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){var e=this.opts.position.components,t=this.opts.axis,n=[e[0],e[1],e[2],e[0]+t.x.length,e[1],e[2],e[0],e[1],e[2],e[0],e[1]+t.y.length,e[2],e[0],e[1],e[2],e[0],e[1],e[2]+t.z.length],o=t.x.color.components,i=t.y.color.components,s=t.z.color.components,r=[o[0],o[1],o[2],o[0],o[1],o[2],i[0],i[1],i[2],i[0],i[1],i[2],s[0],s[1],s[2],s[0],s[1],s[2]];if(this.opts.box.enabled){var a=this.opts.box.x.color.components,c=this.opts.box.y.color.components,u=this.opts.box.z.color.components;n.push(e[0]+t.x.length,e[1]+t.y.length,e[2]+t.z.length,e[0],e[1]+t.y.length,e[2]+t.z.length,e[0]+t.x.length,e[1],e[2]+t.z.length,e[0],e[1],e[2]+t.z.length,e[0]+t.x.length,e[1]+t.y.length,e[2],e[0],e[1]+t.y.length,e[2],e[0]+t.x.length,e[1]+t.y.length,e[2]+t.z.length,e[0]+t.x.length,e[1],e[2]+t.z.length,e[0],e[1]+t.y.length,e[2]+t.z.length,e[0],e[1],e[2]+t.z.length,e[0]+t.x.length,e[1]+t.y.length,e[2],e[0]+t.x.length,e[1],e[2],e[0]+t.x.length,e[1]+t.y.length,e[2]+t.z.length,e[0]+t.x.length,e[1]+t.y.length,e[2],e[0],e[1]+t.y.length,e[2]+t.z.length,e[0],e[1]+t.y.length,e[2],e[0]+t.x.length,e[1],e[2]+t.z.length,e[0]+t.x.length,e[1],e[2]),r.push(a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2])}if(this.opts.ticks.enabled){for(var h=this.opts.ticks.x,l=t.x.length/h.count,f=this.opts.ticks.y,m=t.y.length/f.count,d=this.opts.ticks.z,p=t.z.length/d.count,v=e[0],y=h.color.components,g=0;g<h.count-1;g++)v+=l,n.push(v+h.offset.components[0],e[1]+h.offset.components[1],e[2]+h.offset.components[2],v+h.offset.components[0],e[1]+h.offset.components[1]+h.length,e[2]+h.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[0];for(var x=0;x<h.count-1;x++)v+=l,n.push(v+h.offset.components[0],e[1]+h.offset.components[1],e[2]+h.offset.components[2],v+h.offset.components[0],e[1]+h.offset.components[1],e[2]+h.offset.components[2]+h.length),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[1],y=f.color.components;for(var b=0;b<f.count-1;b++)v+=m,n.push(e[0]+h.offset.components[0],v+h.offset.components[1],e[2]+h.offset.components[2],e[0]+h.offset.components[0]+h.length,v+h.offset.components[1],e[2]+h.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[1];for(var L=0;L<f.count-1;L++)v+=m,n.push(e[0]+h.offset.components[0],v+h.offset.components[1],e[2]+h.offset.components[2],e[0]+h.offset.components[0],v+h.offset.components[1],e[2]+h.offset.components[2]+h.length),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[2],y=d.color.components;for(var P=0;P<d.count-1;P++)v+=p,n.push(e[0]+h.offset.components[0],e[1]+h.offset.components[1],v+h.offset.components[2],e[0]+h.offset.components[0],e[1]+h.offset.components[1]+h.length,v+h.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[2];for(var _=0;_<d.count-1;_++)v+=p,n.push(e[0]+h.offset.components[0],e[1]+h.offset.components[1],v+h.offset.components[2],e[0]+h.offset.components[0]+h.length,e[1]+h.offset.components[1],v+h.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2])}this.setAttribute("position",new Float32Array(n)),this.setAttribute("color",new Float32Array(r))}}]),t}(Lore.HelperBase),Lore.OctreeHelper=function(e){function t(e,n,o,i,s){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n,o));r.defaults={visualize:!1,multiSelect:!0},r.opts=Lore.Utils.extend(!0,r.defaults,s),r._eventListeners={},r.target=i,r.renderer=e,r.octree=r.target.octree,r.raycaster=new Lore.Raycaster,r.hovered=null,r.selected=[];var a=r;return r._dblclickHandler=function(e){if(!e.e.mouse.state.middle&&!e.e.mouse.state.right){var t=e.e.mouse.normalizedPosition,n=a.getIntersections(t);if(n.length>0){if(a.selectedContains(n[0].index))return;a.addSelected(n[0])}}},e.controls.addEventListener("dblclick",r._dblclickHandler),r._mousemoveHandler=function(t){if(!(t.e.mouse.state.left||t.e.mouse.state.middle||t.e.mouse.state.right)){var n=t.e.mouse.normalizedPosition,o=a.getIntersections(n);if(o.length>0){if(a.hovered&&a.hovered.index===o[0].index)return;a.hovered=o[0],a.hovered.screenPosition=a.renderer.camera.sceneToScreen(o[0].position,e),a.raiseEvent("hoveredchanged",{e:a.hovered})}else a.hovered=null,a.raiseEvent("hoveredchanged",{e:null})}},e.controls.addEventListener("mousemove",r._mousemoveHandler),r._zoomchangedHandler=function(e){a.setPointSizeFromZoom(e)},e.controls.addEventListener("zoomchanged",r._zoomchangedHandler),r._updatedHandler=function(){for(var t=0;t<a.selected.length;t++)a.selected[t].screenPosition=a.renderer.camera.sceneToScreen(a.selected[t].position,e);a.hovered&&(a.hovered.screenPosition=a.renderer.camera.sceneToScreen(a.hovered.position,e)),a.raiseEvent("updated")},e.controls.addEventListener("updated",r._updatedHandler),r.init(),r}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){"centers"===this.opts.visualize?this.drawCenters():"cubes"===this.opts.visualize?this.drawBoxes():this.geometry.isVisible=!1,this.setPointSizeFromZoom(1)}},{key:"setPointSizeFromZoom",value:function(e){var t=this.target.setPointSize(e+.1);this.setThreshold(t)}},{key:"getScreenPosition",value:function(e){var t=this.target.geometry.attributes.position.data,n=3*e,o=new Lore.Vector3f(t[n],t[n+1],t[n+2]);return this.renderer.camera.sceneToScreen(o,this.renderer)}},{key:"addSelected",value:function(e){if(!isNaN(parseFloat(e))){var t=this.target.geometry.attributes.position.data,n=this.target.geometry.attributes.color.data,o=3*e;e={distance:-1,index:e,locCode:-1,position:new Lore.Vector3f(t[o],t[o+1],t[o+2]),color:n?[n[o],n[o+1],n[o+2]]:null}}var i=this.selected.length;this.opts.multiSelect?this.selected.push(e):(this.selected[0]=e,i=0),this.selected[i].screenPosition=this.renderer.camera.sceneToScreen(e.position,this.renderer),this.raiseEvent("selectedchanged",{e:this.selected})}},{key:"removeSelected",value:function(e){this.selected.splice(e,1),this.raiseEvent("selectedchanged",{e:this.selected})}},{key:"clearSelected",value:function(){this.selected=[],this.raiseEvent("selectedchanged",{e:this.selected})}},{key:"selectedContains",value:function(e){for(var t=0;t<this.selected.length;t++)if(this.selected[t].index===e)return!0;return!1}},{key:"setHovered",value:function(e){if(!that.hovered||that.hovered.index!==result[0].index){var t=3*e,n=this.target.geometry.attributes.position.data,o=null;"color"in this.target.geometry.attributes&&(o=this.target.geometry.attributes.color.data),that.hovered={index:e,position:new Lore.Vector3f(n[t],n[t+1],n[t+2]),color:o?[o[t],o[t+1],o[t+2]]:null},that.hovered.screenPosition=that.renderer.camera.sceneToScreen(that.hovered.position,renderer),that.raiseEvent("hoveredchanged",{e:that.hovered})}}},{key:"selectHovered",value:function(){this.hovered&&!this.selectedContains(this.hovered.index)&&this.addSelected({distance:this.hovered.distance,index:this.hovered.index,locCode:this.hovered.locCode,position:this.hovered.position,color:this.hovered.color})}},{key:"showCenters",value:function(){this.opts.visualize="centers",this.drawCenters(),this.geometry.isVisible=!0}},{key:"showCubes",value:function(){this.opts.visualize="cubes",this.drawBoxes(),this.geometry.isVisible=!0}},{key:"hide",value:function(){this.opts.visualize=!1,this.geometry.isVisible=!1,this.setAttribute("position",new Float32Array([])),this.setAttribute("color",new Float32Array([]))}},{key:"getIntersections",value:function(e){this.raycaster.set(this.renderer.camera,e.x,e.y);var t=this.octree.raySearch(this.raycaster),n=this.rayIntersections(t);return n.sort(function(e,t){return e.distance-t.distance}),n}},{key:"addEventListener",value:function(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)}},{key:"raiseEvent",value:function(e,t){if(this._eventListeners[e])for(var n=0;n<this._eventListeners[e].length;n++)this._eventListeners[e][n](t)}},{key:"drawCenters",value:function(){this.geometry.setMode(Lore.DrawModes.points);var e=this.octree.aabbs,t=Object.keys(e).length,n=new Float32Array(3*t),o=new Float32Array(3*t),i=0;for(key in e){var s=e[key].center.components,r=3*i;n[r]=1,n[r+1]=1,n[r+2]=1,o[r]=s[0],o[r+1]=s[1],o[r+2]=s[2],i++}this.setAttribute("position",new Float32Array(o)),this.setAttribute("color",new Float32Array(n))}},{key:"drawBoxes",value:function(){this.geometry.setMode(Lore.DrawModes.lines);for(var e=this.octree.aabbs,t=Object.keys(e).length,n=new Float32Array(24*t*3),o=new Float32Array(24*t*3),i=0;i<n.length;i++)n[i]=1;var s=0;for(key in e){var r=Lore.AABB.getCorners(e[key]);o[s++]=r[0][0],o[s++]=r[0][1],o[s++]=r[0][2],o[s++]=r[1][0],o[s++]=r[1][1],o[s++]=r[1][2],o[s++]=r[0][0],o[s++]=r[0][1],o[s++]=r[0][2],o[s++]=r[2][0],o[s++]=r[2][1],o[s++]=r[2][2],o[s++]=r[0][0],o[s++]=r[0][1],o[s++]=r[0][2],o[s++]=r[4][0],o[s++]=r[4][1],o[s++]=r[4][2],o[s++]=r[1][0],o[s++]=r[1][1],o[s++]=r[1][2],o[s++]=r[3][0],o[s++]=r[3][1],o[s++]=r[3][2],o[s++]=r[1][0],o[s++]=r[1][1],o[s++]=r[1][2],o[s++]=r[5][0],o[s++]=r[5][1],o[s++]=r[5][2],o[s++]=r[2][0],o[s++]=r[2][1],o[s++]=r[2][2],o[s++]=r[3][0],o[s++]=r[3][1],o[s++]=r[3][2],o[s++]=r[2][0],o[s++]=r[2][1],o[s++]=r[2][2],o[s++]=r[6][0],o[s++]=r[6][1],o[s++]=r[6][2],o[s++]=r[3][0],o[s++]=r[3][1],o[s++]=r[3][2],o[s++]=r[7][0],o[s++]=r[7][1],o[s++]=r[7][2],o[s++]=r[4][0],o[s++]=r[4][1],o[s++]=r[4][2],o[s++]=r[5][0],o[s++]=r[5][1],o[s++]=r[5][2],o[s++]=r[4][0],o[s++]=r[4][1],o[s++]=r[4][2],o[s++]=r[6][0],o[s++]=r[6][1],o[s++]=r[6][2],o[s++]=r[5][0],o[s++]=r[5][1],o[s++]=r[5][2],o[s++]=r[7][0],o[s++]=r[7][1],o[s++]=r[7][2],o[s++]=r[6][0],o[s++]=r[6][1],o[s++]=r[6][2],o[s++]=r[7][0],o[s++]=r[7][1],o[s++]=r[7][2]}this.setAttribute("position",o),this.setAttribute("color",n)}},{key:"setThreshold",value:function(e){this.raycaster.threshold=e}},{key:"rayIntersections",value:function(e){var t=[],n=Lore.Matrix4f.invert(this.target.modelMatrix),o=new Lore.Ray,i=this.raycaster.threshold*this.target.getPointScale(),s=this.target.geometry.attributes.position.data,r=null;"color"in this.target.geometry.attributes&&(r=this.target.geometry.attributes.color.data);var a=this.target.getCutoff();o.copyFrom(this.raycaster.ray).applyProjection(n);for(var c=i,u=c*c,h=0;h<e.length;h++){var l=e[h].index,f=e[h].locCode,m=3*l,d=new Lore.Vector3f(s[m],s[m+1],s[m+2]);if(o.distanceSqToPoint(d)<u){var p=o.closestPointToPoint(d);p.applyProjection(this.target.modelMatrix);var v=this.raycaster.ray.source.distanceTo(p),y=Lore.FilterBase.isVisible(this.target.geometry,l);if(v<this.raycaster.near||v>this.raycaster.far||v<a||!y)continue;t.push({distance:v,index:l,locCode:f,position:d,color:r?[r[m],r[m+1],r[m+2]]:null})}}return t}},{key:"destruct",value:function(){this.renderer.controls.removeEventListener("dblclick",this._dblclickHandler),this.renderer.controls.removeEventListener("mousemove",this._mousemoveHandler),this.renderer.controls.removeEventListener("zoomchanged",this._zoomchangedHandler),this.renderer.controls.removeEventListener("updated",this._updatedHandler)}}]),t}(Lore.HelperBase),Lore.FilterBase=function(){function e(t,n){_classCallCheck(this,e),this.type="Lore.FilterBase",this.geometry=null,this.attribute=t,this.attributeIndex=n,this.active=!1}return _createClass(e,[{key:"getGeometry",value:function(){return this.geometry}},{key:"setGeometry",value:function(e){this.geometry=e}},{key:"filter",value:function(){}},{key:"reset",value:function(){}}],[{key:"isVisible",value:function(e,t){return e.attributes.color.data[3*t+2]>0}}]),e}(),Lore.InRangeFilter=function(e){function t(e,n,o,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return s.min=o,s.max=i,s}return _inherits(t,e),_createClass(t,[{key:"getMin",value:function(){return this.min}},{key:"setMin",value:function(e){this.min=e}},{key:"getMax",value:function(){return this.max}},{key:"setMax",value:function(e){this.max=e}},{key:"filter",value:function(){for(var e=this.geometry.attributes[this.attribute],t=0;t<e.data.length;t+=e.attributeLength){var n=e.data[t+this.attributeIndex],o=this.geometry.attributes.color.data[t+2];n>this.max||n<this.min?this.geometry.attributes.color.data[t+2]=-Math.abs(o):this.geometry.attributes.color.data[t+2]=Math.abs(o)}this.geometry.updateAttribute("color")}},{key:"reset",value:function(){for(var e=this.geometry.attributes[this.attribute],t=0;t<e.data.length;t+=e.attributeLength){var n=this.geometry.attributes.color.data[t+2];this.geometry.attributes.color.data[t+2]=Math.abs(n)}this.geometry.updateAttribute("color")}}]),t}(Lore.FilterBase),Lore.FileReaderBase=function(){function e(t){_classCallCheck(this,e),this.elementId=t,this.element=document.getElementById(this.elementId),this.eventListeners={};var n=this;this.element.addEventListener("click",function(){this.value=null}),this.element.addEventListener("change",function(){var e=new FileReader;e.onload=function(){n.loaded(e.result)},e.readAsBinaryString(this.files[0])})}return _createClass(e,[{key:"addEventListener",value:function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}},{key:"raiseEvent",value:function(e,t){if(this.eventListeners[e])for(var n=0;n<this.eventListeners[e].length;n++)this.eventListeners[e][n](t)}},{key:"loaded",value:function(e){}}]),e}(),Lore.CsvFileReader=function(e){function t(e,n){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return o.defaults={separator:",",cols:[],types:[],header:!0},o.opts=Lore.Utils.extend(!0,o.defaults,n),o.columns={},o.headers=[],o.types=o.opts.types,o.cols=o.opts.cols,o}return _inherits(t,e),_createClass(t,[{key:"loaded",value:function(e){e=e.replace("\n\n","\n"),e=e.replace(/^\s+|\s+$/g,"");var t=e.split("\n"),n=t.length,o=!0,i=this.opts.header?1:0;if(0!==this.cols.length){if(this.types.length!==this.cols.length)throw"Types and cols must have the same number of elements."}else if(this.types.length!==this.cols.length){var s=t[i].split(this.opts.separator);this.types=[];for(var r=0;r<s.length;r++)Lore.Utils.isFloat(parseFloat(s[r],10))?this.types.push("Float32Array"):Lore.Utils.isInt(parseFloat(s[r],10))?this.types.push("Int32Array"):this.types.push("StringArray")}if(0===this.cols.length)for(var a=t[0].split(this.opts.separator),c=0;c<a.length;c++)this.cols.push(c);if(i)for(var u=t[0].split(this.opts.separator),h=0;h<this.cols.length;h++)this.headers[h]=u[this.cols[h]];else for(var l=0;l<this.cols.length;l++)this.headers[l]=l;for(var f=i;f<n;f++){var m=t[f].split(this.opts.separator);if(0==this.cols.length)for(var d=0;d<m.length;d++)this.cols.push[d];if(o){for(var p=0;p<this.cols.length;p++)this.createArray(this.headers[p],this.types[p],n-i);o=!1}for(var v=0;v<this.cols.length;v++)this.columns[this.headers[v]][f-i]=m[this.cols[v]]}return this.raiseEvent("loaded",this.columns),this}},{key:"createArray",value:function(e,t,n){return this.columns[e]="Int8Array"==t?new Int8Array(n):"Uint8Array"==t?new Uint8Array(n):"Uint8ClampedArray"==t?new Uint8ClampedArray(n):"Int16Array"==t?new Int16Array(n):"Uint16Array"==t?new Uint16Array(n):"Int32Array"==t?new Int32Array(n):"Uint32Array"==t?new Uint32Array(n):"Float32Array"==t?new Float32Array(n):"Float64Array"==t?new Float64Array(n):new Array(n),this}}]),t}(Lore.FileReaderBase),Lore.Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"extend",value:function(){var e={},t=!1,n=0,o=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(t=arguments[0],n++);for(;n<o;n++){var i=arguments[n];!function(n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t&&"[object Object]"===Object.prototype.toString.call(n[o])?e[o]=Lore.Utils.extend(!0,e[o],n[o]):e[o]=n[o])}(i)}return e}},{key:"arrayContains",value:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}},{key:"concatTypedArrays",value:function(e,t){var n=new a.constructor(e.length+t.length);return n.set(e),n.set(t,e.length),n}},{key:"msb",value:function(e){return 2147483648&e?31:Lore.Utils.msb(e<<1|1)-1}},{key:"mergePointDistances",value:function(e,t){var n={};return n.indices=Lore.Utils.concatTypedArrays(e.indices,t.indices),n.distancesSq=Lore.Utils.concatTypedArrays(e.distancesSq,t.distancesSq),n}},{key:"isInt",value:function(e){return Number(e)===e&&e%1==0}},{key:"isFloat",value:function(e){return Number(e)===e&&e%1!=0}}]),e}(),Lore.Utils.DEG2RAD=Math.PI/180,Lore.Shaders.default=new Lore.Shader("Default",{size:new Lore.Uniform("size",5,"float"),type:new Lore.Uniform("type",0,"float"),fogStart:new Lore.Uniform("fogStart",0,"float"),fogEnd:new Lore.Uniform("fogEnd",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogStart;","uniform float fogEnd;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","float rand(vec2 co) {","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 1.0);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float dist = abs(mv_pos.z - fogStart);","gl_PointSize = size;","if(fogEnd > 0.0) {","hsv.b = clamp((fogEnd - dist) / (fogEnd - fogStart), 0.0, 1.0);","}","hsv.g = 0.5 + 0.4 * rand(position.xy);","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard > 0.5) discard;","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.defaultAnimated=new Lore.Shader("DefaultAnimated",{size:new Lore.Uniform("size",5,"float"),fogStart:new Lore.Uniform("fogStart",0,"float"),fogEnd:new Lore.Uniform("fogEnd",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float"),time:new Lore.Uniform("time",0,"float")},["uniform float size;","uniform float fogStart;","uniform float fogEnd;","uniform float cutoff;","uniform float time;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 1.0);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float dist = abs(mv_pos.z - fogStart);","gl_PointSize = size;","if(fogEnd > 0.0) {","hsv.b = clamp((fogEnd - dist) / (fogEnd - fogStart), 0.0, 1.0);","}","hsv.g *= max(0.15, abs(sin(time * 0.002)));","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard > 0.5) discard;","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.coordinates=new Lore.Shader("Coordinates",{},["attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","gl_PointSize = 1.0;","vColor = color;","}"],["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.tree=new Lore.Shader("Tree",{size:new Lore.Uniform("size",5,"float"),
fogStart:new Lore.Uniform("fogStart",0,"float"),fogEnd:new Lore.Uniform("fogEnd",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogStart;","uniform float fogEnd;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 0.75);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float dist = abs(mv_pos.z - fogStart);","gl_PointSize = size;","if(fogEnd > 0.0) {","hsv.b = clamp((fogEnd - dist) / (fogEnd - fogStart), 0.0, 1.0);","}","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard > 0.5) discard;","gl_FragColor = vec4(vColor, 0.5);","}"]),Lore.Shaders.sphere=new Lore.Shader("Sphere",{size:new Lore.Uniform("size",5,"float"),fogStart:new Lore.Uniform("fogStart",0,"float"),fogEnd:new Lore.Uniform("fogEnd",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogStart;","uniform float fogEnd;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 1.0);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0 || mv_pos.z > 0.0) {","vDiscard = 1.0;","return;","}","float dist = max(0.0, length(mv_pos) - fogStart);","gl_PointSize = point_size * size;","if(fogEnd > 0.0) {","hsv.b = clamp((fogEnd - dist) / (fogEnd - fogStart), 0.0, 1.0);","}","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","float rand(vec2 co) {","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","if(vDiscard > 0.5) discard;","vec3 N;","N.xy = gl_PointCoord * 2.0 - vec2(1.0);","float mag = dot(N.xy, N.xy);","if (mag > 1.0) discard;   // discard fragments outside circle","N.z = sqrt(1.0 - mag);","vec3 light_dir = vec3(0.25, -0.25, 1.0);","float diffuse = max(0.25, dot(light_dir, N));","vec3 v = normalize(vec3(0.1, -0.2, 1.0));","vec3 h = normalize(light_dir + v);","float specular = pow(max(0.0, dot(N, h)), 100.0);","// specular += 0.1 * rand(gl_PointCoord);","gl_FragColor = vec4(vColor * diffuse + specular * 0.5, 1.0);","}"]),Lore.Shaders.defaultEffect=new Lore.Shader("DefaultEffect",{},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main(void) {","vec4 color = texture2D(fbo_texture, f_texcoord);","gl_FragColor = color;","}"]),Lore.Shaders.fxaaEffect=new Lore.Shader("FXAAEffect",{resolution:new Lore.Uniform("resolution",[500,500],"float_vec2")},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","uniform vec2 resolution;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["#define fxaaTexture2D(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#define fxaaSat(x) clamp(x, 0.0, 1.0)","#define FXAA_QUALITY_PS 8","#define FXAA_QUALITY_P0 1.0","#define FXAA_QUALITY_P1 1.5","#define FXAA_QUALITY_P2 2.0","#define FXAA_QUALITY_P3 2.0","#define FXAA_QUALITY_P4 2.0","#define FXAA_QUALITY_P5 2.0","#define FXAA_QUALITY_P6 4.0","#define FXAA_QUALITY_P7 12.0","vec4 fxaa(vec2 pos, sampler2D tex, vec2 resolution,","float subpixQuality, float edgeThreshold, float edgeThresholdMin) {","vec2 posM;","posM.x = pos.x;","posM.y = pos.y;","vec4 rgbyM = texture2D(tex, posM);","vec3 luma = vec3(0.299, 0.587, 0.114);","float lumaM = dot(rgbyM.xyz, luma);","float lumaS = dot(fxaaTexture2D(tex, posM, vec2(0, 1), resolution.xy).xyz, luma);","float lumaE = dot(fxaaTexture2D(tex, posM, vec2(1, 0), resolution.xy).xyz, luma);","float lumaN = dot(fxaaTexture2D(tex, posM, vec2(0, -1), resolution.xy).xyz, luma);","float lumaW = dot(fxaaTexture2D(tex, posM, vec2(-1, 0), resolution.xy).xyz, luma);","float maxSM = max(lumaS, lumaM);","float minSM = min(lumaS, lumaM);","float maxESM = max(lumaE, maxSM);","float minESM = min(lumaE, minSM);","float maxWN = max(lumaN, lumaW);","float minWN = min(lumaN, lumaW);","float rangeMax = max(maxWN, maxESM);","float rangeMin = min(minWN, minESM);","float rangeMaxScaled = rangeMax * edgeThreshold;","float range = rangeMax - rangeMin;","float rangeMaxClamped = max(edgeThresholdMin, rangeMaxScaled);","bool earlyExit = range < rangeMaxClamped;","// maybe return rgbyM -> leave unchanged","if(earlyExit) return rgbyM;","float lumaNW = dot(fxaaTexture2D(tex, posM, vec2(-1, -1), resolution.xy).xyz, luma);","float lumaSE = dot(fxaaTexture2D(tex, posM, vec2(1, 1), resolution.xy).xyz, luma);","float lumaNE = dot(fxaaTexture2D(tex, posM, vec2(1, -1), resolution.xy).xyz, luma);","float lumaSW = dot(fxaaTexture2D(tex, posM, vec2(-1, 1), resolution.xy).xyz, luma);","float lumaNS = lumaN + lumaS;","float lumaWE = lumaW + lumaE;","float subpixRcpRange = 1.0 / range;","float subpixNSWE = lumaNS + lumaWE;","float edgeHorz1 = (-2.0 * lumaM) + lumaNS;","float edgeVert1 = (-2.0 * lumaM) + lumaWE;","float lumaNESE = lumaNE + lumaSE;","float lumaNWNE = lumaNW + lumaNE;","float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","float lumaNWSW = lumaNW + lumaSW;","float lumaSWSE = lumaSW + lumaSE;","float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","float edgeHorz = abs(edgeHorz3) + edgeHorz4;","float edgeVert = abs(edgeVert3) + edgeVert4;","float subpixNWSWNESE = lumaNWSW + lumaNESE;","float lengthSign = resolution.x;","bool horzSpan = edgeHorz >= edgeVert;","float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","if(!horzSpan) lumaN = lumaW;","if(!horzSpan) lumaS = lumaE;","if(horzSpan) lengthSign = resolution.y;","float subpixB = (subpixA * (1.0/12.0)) - lumaM;","float gradientN = lumaN - lumaM;","float gradientS = lumaS - lumaM;","float lumaNN = lumaN + lumaM;","float lumaSS = lumaS + lumaM;","bool pairN = abs(gradientN) >= abs(gradientS);","float gradient = max(abs(gradientN), abs(gradientS));","if(pairN) lengthSign = -lengthSign;","float subpixC = fxaaSat(abs(subpixB) * subpixRcpRange);","vec2 posB;","posB.x = posM.x;","posB.y = posM.y;","vec2 offNP;","offNP.x = (!horzSpan) ? 0.0 : resolution.x;","offNP.y = ( horzSpan) ? 0.0 : resolution.y;","if(!horzSpan) posB.x += lengthSign * 0.5;","if( horzSpan) posB.y += lengthSign * 0.5;","vec2 posN;","posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","vec2 posP;","posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","float subpixD = ((-2.0)*subpixC) + 3.0;","float lumaEndN = texture2D(tex, posN).w;","float subpixE = subpixC * subpixC;","float lumaEndP = texture2D(tex, posP).w;","if(!pairN) lumaNN = lumaSS;","float gradientScaled = gradient * 1.0/4.0;","float lumaMM = lumaM - lumaNN * 0.5;","float subpixF = subpixD * subpixE;","bool lumaMLTZero = lumaMM < 0.0;","lumaEndN -= lumaNN * 0.5;","lumaEndP -= lumaNN * 0.5;","bool doneN = abs(lumaEndN) >= gradientScaled;","bool doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","bool doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","#if (FXAA_QUALITY_PS > 3)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","#if (FXAA_QUALITY_PS > 4)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","#if (FXAA_QUALITY_PS > 5)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","#if (FXAA_QUALITY_PS > 6)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","#if (FXAA_QUALITY_PS > 7)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","#if (FXAA_QUALITY_PS > 8)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","#if (FXAA_QUALITY_PS > 9)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","#if (FXAA_QUALITY_PS > 10)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","#if (FXAA_QUALITY_PS > 11)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","#if (FXAA_QUALITY_PS > 12)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","float dstN = posM.x - posN.x;","float dstP = posP.x - posM.x;","if(!horzSpan) dstN = posM.y - posN.y;","if(!horzSpan) dstP = posP.y - posM.y;","bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","float spanLength = (dstP + dstN);","bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","float spanLengthRcp = 1.0 / spanLength;","bool directionN = dstN < dstP;","float dst = min(dstN, dstP);","bool goodSpan = directionN ? goodSpanN : goodSpanP;","float subpixG = subpixF * subpixF;","float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","float subpixH = subpixG * subpixQuality;","float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","// maybe return vec4(texture2D(tex, posM).xyz, lumaM);","return texture2D(tex, posM);","}","uniform sampler2D fbo_texture;","uniform vec2 resolution;","varying vec2 f_texcoord;","void main(void) {","gl_FragColor = fxaa(f_texcoord, fbo_texture, vec2(1.0 / resolution.x, 1.0 / resolution.y), 0.75, 0.166, 0.0833);","}"]),Lore.Octree=function(){function e(t,n){_classCallCheck(this,e),this.threshold=t||500,this.maxDepth=n||8,this.points={},this.aabbs={},this.offsets=[[-.5,-.5,-.5],[-.5,-.5,.5],[-.5,.5,-.5],[-.5,.5,.5],[.5,-.5,-.5],[.5,-.5,.5],[.5,.5,-.5],[.5,.5,.5]]}return _createClass(e,[{key:"build",value:function(e,t,n,o){o=o||1,n.setLocCode(o),this.points[o]=null,this.aabbs[o]=n;var i=this.getDepth(o);if(e.length<=this.threshold||i>=this.maxDepth){this.points[o]=new Uint32Array(e.length);for(var s=0;s<e.length;s++)this.points[o][s]=e[s];return!0}for(var r=new Uint32Array(8),a=new Float32Array(e.length),s=0;s<e.length;s++){var c=3*e[s];t[c+0]>=n.center.components[0]&&(a[s]|=4),t[c+1]>=n.center.components[1]&&(a[s]|=2),t[c+2]>=n.center.components[2]&&(a[s]|=1),r[a[s]]++}for(var u=new Array(8),h=new Array(8),s=0;s<8;s++)if(0!=r[s]){u[s]=new Uint32Array(r[s]);for(var l=0,f=0;l<e.length;l++)a[l]==s&&(u[s][f++]=e[l]);var m=this.offsets[s],d=new Lore.Vector3f(m[0],m[1],m[2]);d.multiplyScalar(n.radius),h[s]=new Lore.AABB(n.center.clone().add(d),.5*n.radius)}for(var s=0;s<8;s++)if(0!=r[s]){var p=this.generateLocCode(o,s);this.build(u[s],t,h[s],p)}return this}},{key:"getLocCodes",value:function(){return Object.keys(this.aabbs)}},{key:"getDepth",value:function(e){return Lore.Utils.msb(e)/3}},{key:"generateLocCode",value:function(e,t){return-1==Lore.Utils.msb(e)?8|t:(e=e<<=3)|t}},{key:"traverse",value:function(e,t){t=t||1;for(var n=0;n<8;n++){var o=t<<3|n;this.aabbs[o]&&(e(this.points[o],this.aabbs[o],o),this.traverse(e,o))}}},{key:"traverseIf",value:function(e,t,n){n=n||1;for(var o=0;o<8;o++){var i=n<<3|o;if(this.aabbs[i]){if(!t(this.aabbs[i],i))continue;e(this.points[i],this.aabbs[i],i),this.traverseIf(e,t,i)}}}},{key:"raySearch",value:function(e){var t=[];if(this.points[1])for(var n=0;n<this.points[1].length;n++)t.push({index:this.points[1][n],locCode:1});var o=e.ray.direction.clone();o.normalize();var i=new Lore.Vector3f(1,1,1);return i.divide(o),this.traverseIf(function(e,n,o){if(e)for(var i=0;i<e.length;i++)t.push({index:e[i],locCode:o})},function(t,n){return t.cylinderTest(e.ray.source,i,e.far,e.threshold)}),t}},{key:"getCenters",value:function(e){e=e||0;var t=new Array;return this.traverse(function(n,o,i){n&&n.length>e&&t.push(o.center)}),t}},{key:"getClosestBox",value:function(e,t,n){n=n||1;for(var o=-1,i=Number.MAX_VALUE,s=0;s<8;s++){var r=n<<3|s;if(this.aabbs[r]){if(this.points[r]&&this.points[r].length<t)continue;var a=this.aabbs[r].distanceToPointSq(e.components[0],e.components[1],e.components[2]);a<i&&(i=a,o=r)}}return o<0?this.aabbs[n]:this.getClosestBox(e,t,o)}},{key:"getClosestBoxFromCenter",value:function(e,t,n){n=n||1;for(var o=-1,i=Number.MAX_VALUE,s=0;s<8;s++){var r=n<<3|s;if(this.aabbs[r]){if(this.points[r]&&this.points[r].length<t)continue;var a=this.aabbs[r].distanceFromCenterToPointSq(e.components[0],e.components[1],e.components[2]);a<i&&(i=a,o=r)}}return o<0?this.aabbs[n]:this.getClosestBox(e,t,o)}},{key:"getFarthestBox",value:function(e,t,n){n=n||1;for(var o=-1,i=Number.MIN_VALUE,s=0;s<8;s++){var r=n<<3|s;if(this.aabbs[r]){if(this.points[r]&&this.points[r].length<t)continue;var a=this.aabbs[r].distanceToPointSq(e.components[0],e.components[1],e.components[2]);a>i&&(i=a,o=r)}}return o<0?this.aabbs[n]:this.getFarthestBox(e,t,o)}},{key:"getClosestPoint",value:function(e,t,n,o){n=n||0;var i=Number.MAX_VALUE,s=null,r=null;r=o?this.aabbs[o]:this.getClosestBox(e,n);var a=this.points[r.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var u=a[c];u*=3;var h=t[u],l=t[u+1],f=t[u+2],m=e.components,d=Math.pow(m[0]-h,2)+Math.pow(m[1]-l,2)+Math.pow(m[2]-f,2);d<i&&(i=d,s={x:h,y:l,z:f})}return s?new Lore.Vector3f(s.x,s.y,s.z):null}},{key:"getFarthestPoint",value:function(e,t,n,o){n=n||0;var i=Number.MIN_VALUE,s=null,r=null;r=o?this.aabbs[o]:this.getFArthestBox(e,n);var a=this.points[r.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var u=a[c];u*=3;var h=t[u],l=t[u+1],f=t[u+2],m=e.components,d=Math.pow(m[0]-h,2)+Math.pow(m[1]-l,2)+Math.pow(m[2]-f,2);d>i&&(i=d,s={x:h,y:l,z:f})}return s?new Lore.Vector3f(s.x,s.y,s.z):null}},{key:"getParent",value:function(e){return e>>>3}},{key:"getNeighbours",value:function(e){var t=this,n=new Array;return this.traverseIf(function(t,o,i){t&&t.length>0&&i!=e&&n.push(i)},function(n,o){return n.testAABB(t.aabbs[e])}),n}},{key:"kNearestNeighbours",value:function(e,t,n,o,i){e+=1;var s=o/3,r=t;if(!isNaN(parseFloat(t)))var a={x:o[3*a],y:o[3*a+1],z:o[3*a+2]};null===n&&(n=this.getClosestBoxFromCenter(new Lore.Vector3f(r.x,r.y,r.z),0).locCode);for(var c=this.getCellDistancesToPoint(r.x,r.y,r.z,n),u=this.pointDistancesSq(r.x,r.y,r.z,n,o),h=new RadixSort,l=h.sort(u.distancesSq,!0),f=h.sort(c.distancesSq,!0),m=0,d=0,p=new Uint32Array(e),v=0;d<e&&v<l.array.length;v++){if(l.array[v]>f.array[0]){m=v;break}p[v]=u.indices[l.indices[v]],d++}if(d==e)return p;for(var v=0;v<f.array.length;v++){var y=c.locCodes[f.indices[v]],g=this.pointDistancesSq(r.x,r.y,r.z,y,o);u=Lore.Octree.mergePointDistances(u,g);for(var x=h.sort(u.distancesSq,!0),b=m;d<e&&b<x.array.length;b++){if(x.array[b]>f.array[v+1]){m=b;break}p[b]=u.indices[x.indices[b]],d++}if(d==e||d>=s-1)return p}return p}},{key:"getCellDistancesToPoint",value:function(e,t,n,o){var i=new Array;this.traverse(function(e,t,n){e&&e.length>0&&n!=o&&i.push(n)});for(var s=new Float32Array(i.length),r=0;r<i.length;r++)s[r]=this.aabbs[i[r]].distanceToPointSq(e,t,n);return{locCodes:i,distancesSq:s}}},{key:"expandNeighbourhood",value:function(e,t,n,o,i){for(var s=i.locCodes,r=i.distancesSq,a=s.length,c=a-1;c>=0;c--)for(var u=this.getNeighbours(s[c]),h=0;h<u.length;h++)u[h]===o||Lore.Utils.arrayContains(s,u[h])||s.push(u[h]);var l=s.length,f=r.length;if(l!==f){for(var m=new Float32Array(l-f),c=f,d=0;c<l;c++,d++)m[d]=this.aabbs[s[c]].distanceToPointSq(e,t,n);return i.distancesSq=Lore.Utils.concatTypedArrays(r,m),s.length-a}}},{key:"cellDistancesSq",value:function(e,t,n,o){for(var i=this.getNeighbours(o),s=new Float32Array(i.length),r=0;r<i.length;r++)s[r]=this.aabbs[i[r]].distanceToPointSq(e,t,n);return{locCodes:i,distancesSq:s}}},{key:"pointDistancesSq",value:function(e,t,n,o,i){for(var s=this.points[o],r=new Uint32Array(s.length),a=new Float32Array(s.length),c=0;c<s.length;c++){var u=3*s[c],h=i[u],l=i[u+1],f=i[u+2];r[c]=s[c],a[c]=Math.pow(h-e,2)+Math.pow(l-t,2)+Math.pow(f-n,2)}return{indices:r,distancesSq:a}}}],[{key:"concatTypedArrays",value:function(e,t){var n=new e.constructor(e.length+t.length);return n.set(e),n.set(t,e.length),n}},{key:"mergePointDistances",value:function(e,t){var n={};return n.indices=Lore.Octree.concatTypedArrays(e.indices,t.indices),n.distancesSq=Lore.Octree.concatTypedArrays(e.distancesSq,t.distancesSq),n}},{key:"mergeCellDistances",value:function(e,t){var n={};return n.locCodes=Lore.Octree.concatTypedArrays(e.locCodes,t.locCodes),n.distancesSq=Lore.Octree.concatTypedArrays(e.distancesSq,t.distancesSq),n}},{key:"clone",value:function(e){var t=new Lore.Octree;t.threshold=e.threshold,t.maxDepth=e.maxDepth,t.points=e.points;for(var n in e.aabbs)e.aabbs.hasOwnProperty(n)&&(t.aabbs[n]=Lore.AABB.clone(e.aabbs[n]));return t}}]),e}(),Lore.AABB=function(){function e(t,n){_classCallCheck(this,e),this.center=t||new Lore.Vector3f,this.radius=n||0,this.locCode=0,this.left=0,this.right=0,this.back=0,this.front=0,this.bottom=0,this.top=0,this.neighbours=new Array(6),this.min=new Float32Array(3),this.max=new Float32Array(3),this.updateDimensions()}return _createClass(e,[{key:"updateDimensions",value:function(){var e=this.center.components[0],t=this.center.components[1],n=this.center.components[2];return this.min[0]=e-this.radius,this.min[1]=t-this.radius,this.min[2]=n-this.radius,this.max[0]=e+this.radius,this.max[1]=t+this.radius,this.max[2]=n+this.radius,this.left=e-this.radius,this.right=e+this.radius,this.back=n-this.radius,this.front=n+this.radius,this.bottom=t-this.radius,this.top=t+this.radius,this}},{key:"setLocCode",value:function(e){return this.locCode=e,this}},{key:"getLocCode",value:function(){return this.locCode}},{key:"rayTest",value:function(e,t,n){var o=e.components,i=t.components,s=(this.left-o[0])*i[0],r=(this.right-o[0])*i[0],a=(this.bottom-o[1])*i[1],c=(this.top-o[1])*i[1],u=(this.back-o[2])*i[2],h=(this.front-o[2])*i[2],l=Math.min(Math.max(s,r),Math.max(a,c),Math.max(u,h));if(l<0)return!1;var f=Math.max(Math.min(s,r),Math.min(a,c),Math.min(u,h));return!(f>l||f>n)}},{key:"cylinderTest",value:function(e,t,n,o){this.radius+=o,this.updateDimensions();var i=this.rayTest(e,t,n);return this.radius-=o,this.updateDimensions(),i}},{key:"distanceToPointSq",value:function(e,t,n){for(var o=0,i=[e,t,n],s=0;s<3;s++)i[s]<this.min[s]&&(o+=Math.pow(this.min[s]-i[s],2)),i[s]>this.max[s]&&(o+=Math.pow(i[s]-this.max[s],2));return o}},{key:"distanceFromCenterToPointSq",value:function(e,t,n){var o=this.center.components;return Math.pow(o[0]-e,2)+Math.pow(o[1]-t,2)+Math.pow(o[2]-n,2)}},{key:"testAABB",value:function(e){for(var t=0;t<3;t++)if(this.max[t]<e.min[t]||this.min[t]>e.max[t])return!1;return!0}}],[{key:"fromPoints",value:function(e){for(var t=e[0],n=e[1],o=e[2],i=new Lore.Vector3f(t,n,o),s=new Lore.Vector3f(t,n,o),r=i.components,a=s.components,c=1;c<e.length/3;c++)e[3*c+0]<r[0]&&(r[0]=e[3*c+0]),e[3*c+1]<r[1]&&(r[1]=e[3*c+1]),e[3*c+2]<r[2]&&(r[2]=e[3*c+2]),e[3*c+0]>a[0]&&(a[0]=e[3*c+0]),e[3*c+1]>a[1]&&(a[1]=e[3*c+1]),e[3*c+2]>a[2]&&(a[2]=e[3*c+2]);var u=new Lore.Vector3f.subtract(s,i);u.multiplyScalar(.5);var h=u.components[0],l=u.components[1],f=u.components[2],m=new Lore.Vector3f(h,l,f);m.add(i);var d=Math.max(h,l,f);return new Lore.AABB(m,d)}},{key:"getCorners",value:function(e){var t=e.center.components,n=t[0],o=t[1],i=t[2],s=e.radius;return[[n-s,o-s,i-s],[n-s,o-s,i+s],[n-s,o+s,i-s],[n-s,o+s,i+s],[n+s,o-s,i-s],[n+s,o-s,i+s],[n+s,o+s,i-s],[n+s,o+s,i+s]]}},{key:"clone",value:function(e){var t=new Lore.AABB;return t.back=e.back,t.bottom=e.bottom,t.center=new Lore.Vector3f(e.center.components[0],e.center.components[1],e.center.components[2]),t.front=e.front,t.left=e.left,t.locCode=e.locCode,t.max=e.max,t.min=e.min,t.radius=e.radius,t.right=e.right,t.top=e.top,t}}]),e}(),Lore.Raycaster=function(){function e(){_classCallCheck(this,e),this.ray=new Lore.Ray,this.near=0,this.far=1e3,this.threshold=.1}return _createClass(e,[{key:"set",value:function(e,t,n){return this.near=e.near,this.far=e.far,this.ray.source.set(t,n,(e.near+e.far)/(e.near-e.far)),this.ray.source.unproject(e),this.ray.direction.set(0,0,-1),this.ray.direction.toDirection(e.modelMatrix),this}}]),e}(),Lore.UI=function(e){this.canvas=document.createElement("canvas"),this.renderCanvasElement=document.getElementById(e),this.init(),this.resize()},Lore.UI.prototype={constructor:Lore.UI,init:function(){this.canvas.style.cssText="position: absolute; pointer-events: none;",this.renderCanvasElement.parentNode.insertBefore(this.canvas,this.renderCanvasElement)},setWidth:function(e){this.canvas.width=e},setHeight:function(e){this.canvas.height=e},setTop:function(e){this.canvas.style.top=e},setLeft:function(e){this.canvas.style.left=e},resize:function(){this.setWidth(this.renderCanvasElement.width),this.setHeight(this.renderCanvasElement.height),this.setTop(this.renderCanvasElement.offsetTop),this.setLeft(this.renderCanvasElement.offsetLeft)}};