var Lore={Version:"0.0.1"};"function"==typeof define&&define.amd?define("lore",Lore):"undefined"!=typeof exports&&"undefined"!=typeof module&&(module.exports=Lore),Lore.Mouse={Left:0,Middle:1,Right:2},Lore.Keyboard={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Esc:27},Lore.Shaders={},Lore.init=function(t,e){this.opts=Lore.Utils.extend(!0,Lore.defaults,e);var o=(new Lore.UI(t),Lore.Color.fromHex(this.opts.clearColor)),n=new Lore.Renderer(t,{clearColor:o,verbose:!0,fps:document.getElementById("fps"),antialiasing:!1,center:new Lore.Vector3f(125,125,125)});new Lore.CoordinatesHelper(n,"Coordinates","coordinates",{position:new Lore.Vector3f(0,0,0),axis:{x:{length:250,color:Lore.Color.fromHex("#097692")},y:{length:250,color:Lore.Color.fromHex("#097692")},z:{length:250,color:Lore.Color.fromHex("#097692")}},ticks:{x:{length:10,color:Lore.Color.fromHex("#097692")},y:{length:10,color:Lore.Color.fromHex("#097692")},z:{length:10,color:Lore.Color.fromHex("#097692")}},box:{enabled:!1,x:{color:Lore.Color.fromHex("#004F6E")},y:{color:Lore.Color.fromHex("#004F6E")},z:{color:Lore.Color.fromHex("#004F6E")}}});return n.render=function(t,e){for(key in e)e[key].draw(n)},n},Lore.defaults={clearColor:"#001821"},Lore.DrawModes={points:0,lines:1,lineStrip:2,lineLoop:3,triangles:4,traingleStrip:5,triangleFan:6},Lore.Color=function(t,e,o,n){1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=e||0,this.components[2]=o||0,this.components[3]=n||1)},Lore.Color.prototype={constructor:Lore.Color,set:function(t,e,o,n){this.components[0]=t,this.components[1]=e,this.components[2]=o,4==arguments.length&&(this.components[3]=n)}},Lore.Color.fromHex=function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,o,n){return e+e+o+o+n+n});var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t),n=parseInt(o[1],16),s=parseInt(o[2],16),r=parseInt(o[3],16);return o?new Lore.Color(n/255,s/255,r/255,1):null},Lore.Color.hueToRgb=function(t,e,o){return 0>o&&(o+=1),o>1&&(o-=1),.1667>o?t+6*(e-t)*o:.5>o?e:.6667>o?t+(e-t)*(.6667-o)*6:t},Lore.Color.hslToRgb=function(t,e,o){var n,s,r;if(0==e)n=s=r=o;else{var i=.5>o?o*(1+e):o+e-o*e,a=2*o-i;n=Lore.Color.hueToRgb(a,i,t+.3333),s=Lore.Color.hueToRgb(a,i,t),r=Lore.Color.hueToRgb(a,i,t-.3333)}return[n,s,r]},Lore.Renderer=function(t,e){this.canvas=document.getElementById(t),this.parent=this.canvas.parentElement,this.antialiasing=e.antialiasing!==!1,this.verbose=e.verbose===!0,this.fpsElement=e.fps,this.fps=0,this.clearColor=e.clearColor||new Lore.Color,this.clearDepth="clearDepth"in e?e.clearDepth:1,this.enableDepthTest="enableDepthTest"in e?e.enableDepthTest:!0,this.camera=e.camera||new Lore.OrthographicCamera(this.getWidth()/-2,this.getWidth()/2,this.getHeight()/2,this.getHeight()/-2),this.shaders=[],this.geometries={},this.render=function(t,e){},this.effect=null,this.lastTiming=performance.now(),this.canvas.addEventListener("contextmenu",function(t){return(t.button=2)?(t.preventDefault(),!1):void 0}),this.init();var o=e.center?e.center:new Lore.Vector3f;this.controls=e.controls||new Lore.OrbitalControls(this,1200,o)},Lore.Renderer.prototype={constructor:Lore.Renderer,ready:!1,gl:null,init:function(){var t=this,e={antialias:this.antialiasing};if(this.gl=this.canvas.getContext("webgl",e)||this.canvas.getContext("experimental-webgl",e),!this.gl)return void console.error("Could not initialize the WebGL context.");var o=this.gl;if(console.log(o.getParameter(o.ALIASED_LINE_WIDTH_RANGE)),this.verbose){var n=o.getContextAttributes().antialias,s=o.getParameter(o.SAMPLES);console.info("Antialiasing: "+n+" ("+s+"x)");var r=o.getShaderPrecisionFormat(o.FRAGMENT_SHADER,o.HIGH_FLOAT),i=0!=r.precision;console.info("High precision support: "+i)}var a="OES_standard_derivatives",c=o.getExtension(a);null===c&&console.warn("Could not load extension: "+a+".");var h="WEBGL_draw_buffers",u=o.getExtension(h);null===u&&console.warn("Could not load extension: "+h+".");var l="WEBGL_depth_texture",m=o.getExtension(l);null===m&&console.warn("Could not load extension: "+l+"."),this.setClearColor(this.clearColor),o.clearDepth(this.clearDepth),this.enableDepthTest&&(o.enable(o.DEPTH_TEST),o.depthFunc(o.LESS),console.log("enable depth test")),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.enable(o.BLEND),setTimeout(function(){t.updateViewport(0,0,t.getWidth(),t.getHeight())},200),window.addEventListener("resize",function(e){var o=t.getWidth(),n=t.getHeight();t.updateViewport(0,0,o,n)}),this.effect=new Lore.Effect(this,"fxaaEffect"),this.ready=!0,this.animate()},setClearColor:function(t){this.clearColor=t;var e=this.clearColor.components;this.gl.clearColor(e[0],e[1],e[2],e[3])},getWidth:function(){return this.canvas.offsetWidth},getHeight:function(){return this.canvas.offsetHeight},updateViewport:function(t,e,o,n){this.canvas.width=o,this.canvas.height=n,this.gl.viewport(t,e,o,n),this.camera.left=-o/2,this.camera.right=o/2,this.camera.top=n/2,this.camera.bottom=-n/2,this.camera.updateProjectionMatrix(),this.effect=new Lore.Effect(this,"fxaaEffect"),this.effect.shader.uniforms.resolution.setValue([o,n])},animate:function(){var t=this;if(requestAnimationFrame(function(){t.animate()}),this.fpsElement){var e=performance.now(),o=e-this.lastTiming;this.lastTiming=e,this.fps=Math.round(1e3/o),this.fpsElement.innerHTML=this.fps}this.effect.bind(),this.render(this.camera,this.geometries),this.effect.unbind(),this.camera.isProjectionMatrixStale=!1,this.camera.isViewMatrixStale=!1},createProgram:function(t){t.init(this.gl);return this.shaders.push(t),this.shaders.length-1},createGeometry:function(t,e){var o=new Lore.Geometry(t,this.gl,this.shaders[e]);return this.geometries[t]=o,o}},Lore.Shader=function(t,e,o,n){this.name=t,this.uniforms=e||{},this.vertexShader=o||[],this.fragmentShader=n||[],this.gl=null,this.program=null,this.initialized=!1,this.uniforms.modelViewMatrix=new Lore.Uniform("modelViewMatrix",(new Lore.Matrix4f).entries,"float_mat4"),this.uniforms.projectionMatrix=new Lore.Uniform("projectionMatrix",(new Lore.Matrix4f).entries,"float_mat4")},Lore.Shader.prototype={constructor:Lore.Shader,getVertexShaderCode:function(){return this.vertexShader.join("\n")},getFragmentShaderCode:function(){return this.fragmentShader.join("\n")},getVertexShader:function(t){var e=t.createShader(t.VERTEX_SHADER),o="uniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\n"+this.getVertexShaderCode();return t.shaderSource(e,o),t.compileShader(e),Lore.Shader.showCompilationInfo(t,e,this.name,"Vertex Shader"),e},getFragmentShader:function(t){var e=t.createShader(t.FRAGMENT_SHADER),o="#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#ifdef GL_ES\nprecision highp float;\n#endif\n\n"+this.getFragmentShaderCode();return t.shaderSource(e,o),t.compileShader(e),Lore.Shader.showCompilationInfo(t,e,this.name,"Fragment Shader"),e},init:function(t){this.gl=t,this.program=this.gl.createProgram();var e=this.getVertexShader(this.gl),o=this.getFragmentShader(this.gl);return e&&o?(this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,o),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)?void(this.initialized=!0):(console.error("Could not link program.\nVALIDATE_STATUS: "+this.gl.getProgramParameter(program,this.gl.VALIDATE_STATUS)+"\nERROR: "+this.gl.getError()),null)):(console.error("Failed to create the fragment or the vertex shader."),null)},updateUniforms:function(){for(var t in this.uniforms){var e=this.uniforms[t];e.stale&&Lore.Uniform.Set(this.gl,this.program,e)}},use:function(){this.gl.useProgram(this.program),this.updateUniforms()}},Lore.Shader.showCompilationInfo=function(t,e,o,n){n=n||"Shader",t.getShaderParameter(e,t.COMPILE_STATUS)===!1&&console.error(n+" "+o+" did not compile."),""!==t.getShaderInfoLog(e)&&console.warn(n+" "+o+" info log: "+t.getShaderInfoLog(e))},Lore.Uniform=function(t,e,o){this.name=t,this.value=e,this.type=o,this.stale=!0},Lore.Uniform.prototype={constructor:Lore.Uniform,setValue:function(t){this.value=t,this.stale=!0}},Lore.Uniform.Set=function(t,e,o){var n=t.getUniformLocation(e,o.name);"int"===o.type?t.uniform1i(n,o.value):"int_vec2"===o.type?t.uniform2iv(n,o.value):"int_vec3"===o.type?t.uniform3iv(n,o.value):"int_vec4"===o.type?t.uniform4iv(n,o.value):"int_array"===o.type?t.uniform1iv(n,o.value):"float"===o.type?t.uniform1f(n,o.value):"float_vec2"===o.type?t.uniform2fv(n,o.value):"float_vec3"===o.type?t.uniform3fv(n,o.value):"float_vec4"===o.type?t.uniform4fv(n,o.value):"float_array"===o.type?t.uniform1fv(n,o.value):"float_mat2"===o.type?t.uniformMatrix2fv(n,!1,o.value):"float_mat3"===o.type?t.uniformMatrix3fv(n,!1,o.value):"float_mat4"===o.type&&t.uniformMatrix4fv(n,!1,o.value),o.stale=!0},Lore.Node=function(){this.type="Lore.Node",this.id=Lore.Node.createGUID(),this.isVisible=!0,this.position=new Lore.Vector3f,this.rotation=new Lore.Quaternion,this.scale=new Lore.Vector3f(1,1,1),this.up=new Lore.Vector3f(0,1,0),this.normalMatrix=new Lore.Matrix3f,this.modelMatrix=new Lore.Matrix4f,this.isStale=!1,this.children=new Array,this.parent=null},Lore.Node.prototype={constructor:Lore.Node,applyMatrix:function(t){this.modelMatrix.multiplyB(t)},getUpVector:function(){var t=new Lore.Vector3f(0,1,0);return t.applyQuaternion(this.rotation)},getForwardVector:function(){var t=new Lore.Vector3f(0,0,1);return t.applyQuaternion(this.rotation)},getRightVector:function(){var t=new Lore.Vector3f(1,0,0);return t.applyQuaternion(this.rotation)},translateOnAxis:function(t,e){var o=new Lore.Vector3f(t.components[0],t.components[1],t.components[2]);return o.applyQuaternion(this.rotation),o.multiplyScalar(e),this.position.add(o),this},translateX:function(t){return this.position.components[0]=this.position.components[0]+t,this},translateY:function(t){return this.position.components[1]=this.position.components[1]+t,this},translateZ:function(t){return this.position.components[2]=this.position.components[2]+t,this},setTranslation:function(t){return this.position=t,this},setRotation:function(t,e){return this.rotation.setFromAxisAngle(t,e),this},rotate:function(t,e){var o=new Lore.Quaternion(t,e);return this.rotation.multiplyA(o),this},rotateX:function(t){return this.rotation.rotateX(t),this},rotateY:function(t){return this.rotation.rotateY(t),this},rotateZ:function(t){return this.rotation.rotateZ(t),this},getRotationMatrix:function(){return this.rotation.toRotationMatrix()},update:function(){this.modelMatrix.compose(this.position,this.rotation,this.scale),this.isStale=!0},getModelMatrix:function(){return this.modelMatrix.entries}},Lore.Node.createGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,o="x"==t?e:3&e|8;return o.toString(16)})},Lore.Geometry=function(t,e,o){Lore.Node.call(this),this.type="Lore.Geometry",this.name=t,this.gl=e,this.shader=o,this.attributes={},this.drawMode=this.gl.POINTS,this.isVisible=!0},Lore.Geometry.prototype=Object.assign(Object.create(Lore.Node.prototype),{constructor:Lore.Geometry,addAttribute:function(t,e,o){return this.attributes[t]=new Lore.Attribute(e,o,t),this.attributes[t].createBuffer(this.gl,this.shader.program),this},updateAttribute:function(t,e){this.attributes[t].update(this.gl,e)},getAttribute:function(t){return this.attributes[t]},removeAttribute:function(t){return delete this.attributes[t],this},setMode:function(t){switch(t){case Lore.DrawModes.points:this.drawMode=this.gl.POINTS;break;case Lore.DrawModes.lines:this.drawMode=this.gl.LINES;break;case Lore.DrawModes.lineStrip:this.drawMode=this.gl.LINE_STRIP;break;case Lore.DrawModes.lineLoop:this.drawMode=this.gl.LINE_LOOP;break;case Lore.DrawModes.triangles:this.drawMode=this.gl.TRIANGLES;break;case Lore.DrawModes.triangleStrip:this.drawMode=this.gl.TRIANGLE_STRIP;break;case Lore.DrawModes.triangleFan:this.drawMode=this.gl.TRIANGLE_FAN}},size:function(){return Object.keys(this.attributes).length>0?this.attributes[Object.keys(this.attributes)[0]].size:0},draw:function(t){if(this.isVisible){for(var e in this.attributes)this.attributes[e].stale&&this.attributes[e].update(this.gl);if(this.shader.use(),t.camera.isProjectionMatrixStale&&this.shader.uniforms.projectionMatrix.setValue(t.camera.getProjectionMatrix()),t.camera.isViewMatrixStale){var o=Lore.Matrix4f.multiply(t.camera.viewMatrix,this.modelMatrix);this.shader.uniforms.modelViewMatrix.setValue(o.entries)}this.shader.updateUniforms();for(e in this.attributes)this.attributes[e].bind(this.gl);this.gl.drawArrays(this.drawMode,0,this.size())}}}),Lore.Attribute=function(t,e,o){this.type="Lore.Attribute",this.data=t,this.attributeLength=e||3,this.name=o,this.size=this.data.length/this.attributeLength,this.buffer=null,this.attributeLocation,this.bufferType=null,this.drawMode=null,this.stale=!1},Lore.Attribute.prototype={constructor:Lore.Attribute,setFromVector:function(t,e){this.data.set(e.components,t*this.attributeLength,e.components.length)},setFromVectorArray:function(t){if(this.attributeLength!==t[0].components.length)throw"The attribute has a length of "+this.attributeLength+". But the vectors have "+t[0].components.length+" components.";for(var e=0;e<t.length;e++)this.data.set(t[e].components,e*this.attributeLength,t[e].components.length)},getX:function(t){return this.data[t*this.attributeLength]},setX:function(t,e){this.data[t*this.attributeLength]},getY:function(t){return this.data[t*this.attributeLength+1]},setY:function(t,e){this.data[t*this.attributeLength+1]},getZ:function(t){return this.data[t*this.attributeLength+2]},setZ:function(t,e){this.data[t*this.attributeLength+2]},getW:function(t){return this.data[t*this.attributeLength+3]},setW:function(t,e){this.data[t*this.attributeLength+3]},getGlType:function(t){return t.FLOAT},update:function(t){t.bindBuffer(this.bufferType,this.buffer),t.bufferData(this.bufferType,this.data,this.drawMode),this.stale=!1},createBuffer:function(t,e,o,n){this.buffer=t.createBuffer(),this.bufferType=o||t.ARRAY_BUFFER,this.drawMode=n||t.STATIC_DRAW,t.bindBuffer(this.bufferType,this.buffer),t.bufferData(this.bufferType,this.data,this.drawMode),this.buffer.itemSize=this.attributeLength,this.buffer.numItems=this.size,this.attributeLocation=t.getAttribLocation(e,this.name),t.bindBuffer(this.bufferType,null)},bind:function(t){t.bindBuffer(this.bufferType,this.buffer),this.attributeLocation>=0&&(t.vertexAttribPointer(this.attributeLocation,this.attributeLength,this.getGlType(t),t.FALSE,0,0),t.enableVertexAttribArray(this.attributeLocation))}},Lore.Effect=function(t,e){this.renderer=t,this.gl=this.renderer.gl,this.framebuffer=this.initFramebuffer(),this.texture=this.initTexture(),this.renderbuffer=this.initRenderbuffer(),this.shader=this.renderer.shaders[this.renderer.createProgram(Lore.Shaders[e])],this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},Lore.Effect.prototype={constructor:Lore.Effect,initBuffer:function(){var t=this.gl,e=t.getAttribLocation(this.shader.program,"v_coord"),o=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,-1,-1,1,-1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,2,t.FLOAT,!1,0,0),o},initTexture:function(){var t=this.gl,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.renderer.getWidth(),this.renderer.getHeight(),0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),e},initFramebuffer:function(){var t=this.gl,e=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,e),e},initRenderbuffer:function(){var t=this.gl,e=t.createRenderbuffer();return t.bindRenderbuffer(t.RENDERBUFFER,e),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.renderer.getWidth(),this.renderer.getHeight()),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e),e},bind:function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},unbind:function(){var t=this.gl;t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),this.initBuffer(),this.shader.use(),t.drawArrays(t.TRIANGLES,0,6)}},Lore.ControlsBase=function(t){this.canvas=t.canvas,this.eventListeners={},this.mouse={previousPosition:{x:null,y:null},delta:{x:0,y:0},position:{x:0,y:0},state:{left:!1,middle:!1,right:!1},normalizedPosition:{x:0,y:0},touches:0},this.keyboard={alt:!1,ctrl:!1,shift:!1};var e=this;this.canvas.addEventListener("mousemove",function(t){(null!==e.mouse.previousPosition.x&&e.mouse.state.left||e.mouse.state.middle||e.mouse.state.right)&&(e.mouse.delta.x=t.pageX-e.mouse.previousPosition.x,e.mouse.delta.y=t.pageY-e.mouse.previousPosition.y,e.mouse.position.x+=.01*e.mouse.delta.x,e.mouse.position.y+=.01*e.mouse.delta.y,e.mouse.state.left?e.raiseEvent("mousedrag",{e:e.mouse.delta,source:"left"}):e.mouse.state.middle?e.raiseEvent("mousedrag",{e:e.mouse.delta,source:"middle"}):e.mouse.state.right&&e.raiseEvent("mousedrag",{e:e.mouse.delta,source:"right"}));var o=e.canvas.getBoundingClientRect();e.mouse.normalizedPosition.x=(t.clientX-o.left)/e.canvas.width*2-1,e.mouse.normalizedPosition.y=2*-((t.clientY-o.top)/e.canvas.height)+1,e.raiseEvent("mousemove",{e:e}),e.mouse.previousPosition.x=t.pageX,e.mouse.previousPosition.y=t.pageY}),this.canvas.addEventListener("touchstart",function(t){e.mouse.touches++;t.touches[0];t.preventDefault(),e.mouse.touched=!0,e.raiseEvent("mousedown",{e:e,source:"touch"})}),this.canvas.addEventListener("touchend",function(t){e.mouse.touches--,t.preventDefault(),e.mouse.touched=!1,e.mouse.previousPosition.x=null,e.mouse.previousPosition.y=null,e.raiseEvent("mouseup",{e:e,source:"touch"})}),this.canvas.addEventListener("touchmove",function(t){var o=t.touches[0],n="left";2==e.mouse.touches&&(n="right"),t.preventDefault(),null!==e.mouse.previousPosition.x&&e.mouse.touched&&(e.mouse.delta.x=o.pageX-e.mouse.previousPosition.x,e.mouse.delta.y=o.pageY-e.mouse.previousPosition.y,e.mouse.position.x+=.01*e.mouse.delta.x,e.mouse.position.y+=.01*e.mouse.delta.y,e.raiseEvent("mousedrag",{e:e.mouse.delta,source:n})),e.mouse.previousPosition.x=o.pageX,e.mouse.previousPosition.y=o.pageY});var o="mousewheel";navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(o="DOMMouseScroll"),this.canvas.addEventListener(o,function(t){t.preventDefault(),e.raiseEvent("mousewheel",{e:t.wheelDelta})}),this.canvas.addEventListener("keydown",function(t){16==t.which?e.keyboard.shift=!0:17==t.which?e.keyboard.ctrl=!0:18==t.which&&(e.keyboard.alt=!0),e.raiseEvent("keydown",{e:t.which})}),this.canvas.addEventListener("keyup",function(t){16==t.which?e.keyboard.shift=!1:17==t.which?e.keyboard.ctrl=!1:18==t.which&&(e.keyboard.alt=!1),e.raiseEvent("keyup",{e:t.which})}),this.canvas.addEventListener("mousedown",function(t){var o=t.button,n="left";0==o?e.mouse.state.left=!0:1==o?(e.mouse.state.middle=!0,n="middle"):2==o&&(e.mouse.state.right=!0,n="right"),e.raiseEvent("mousedown",{e:e,source:n})}),this.canvas.addEventListener("click",function(t){var o=(t.button,"left");e.raiseEvent("click",{e:e,source:o})}),this.canvas.addEventListener("dblclick",function(t){var o=(t.button,"left");e.raiseEvent("dblclick",{e:e,source:o})}),this.canvas.addEventListener("mouseup",function(t){var o=t.button,n="left";0==o?e.mouse.state.left=!1:1==o?(e.mouse.state.middle=!1,n="middle"):2==o&&(e.mouse.state.right=!1,n="right"),e.mouse.previousPosition.x=null,e.mouse.previousPosition.y=null,e.raiseEvent("mouseup",{e:e,source:n})})},Lore.ControlsBase.prototype={constructor:Lore.ControlsBase,addEventListener:function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},raiseEvent:function(t,e){if(this.eventListeners[t])for(var o=0;o<this.eventListeners[t].length;o++)this.eventListeners[t][o](e)}},Lore.OrbitalControls=function(t,e,o){Lore.ControlsBase.call(this,t),this.up=Lore.Vector3f.up(),this.radius=e,this.camera=t.camera,this.canvas=t.canvas,this.dPhi=0,this.dTheta=0,this.dPan=new Lore.Vector3f,this.spherical=new Lore.SphericalCoords,this.lookAt=o||new Lore.Vector3f,this.scale=.95,this.zoomed=!1,this.camera.position=new Lore.Vector3f(e,e,e),this.camera.updateProjectionMatrix(),this.camera.updateViewMatrix();var n=this;this.addEventListener("mousedrag",function(t){n.update(t.e,t.source)}),this.addEventListener("mousewheel",function(t){n.update({x:0,y:-t.e},"wheel")}),this.update({x:0,y:0},"left")},Lore.OrbitalControls.prototype=Object.assign(Object.create(Lore.ControlsBase.prototype),{constructor:Lore.OrbitalControls,setRadius:function(t){this.radius=t,this.camera.position=new Lore.Vector3f(0,0,t),this.camera.updateProjectionMatrix(),this.camera.updateViewMatrix(),this.update()},setLookAt:function(t){this.camera.position=new Lore.Vector3f(this.radius,this.radius,this.radius),this.lookAt=t.clone(),this.update()},update:function(t,e){if("left"==e)this.dTheta=-2*Math.PI*t.x/(this.canvas.clientWidth*this.camera.zoom),this.dPhi=-2*Math.PI*t.y/(this.canvas.clientHeight*this.camera.zoom);else if("right"==e){var o=t.x*(this.camera.right-this.camera.left)/this.camera.zoom/this.canvas.clientWidth,n=t.y*(this.camera.top-this.camera.bottom)/this.camera.zoom/this.canvas.clientHeight,s=this.camera.getUpVector().components,r=this.camera.getRightVector().components;this.dPan.components[0]=r[0]*-o+s[0]*n,this.dPan.components[1]=r[1]*-o+s[1]*n,this.dPan.components[2]=r[2]*-o+s[2]*n}else"middle"!=e&&"wheel"!=e||(t.y>0?(this.camera.zoom=Math.max(0,this.camera.zoom*this.scale),this.camera.updateProjectionMatrix(),this.zoomed=!0,this.raiseEvent("zoomchanged",this.camera.zoom)):t.y<0&&(this.camera.zoom=Math.max(0,this.camera.zoom/this.scale),this.camera.updateProjectionMatrix(),this.zoomed=!0,this.raiseEvent("zoomchanged",this.camera.zoom)));var i=this.camera.position.clone().subtract(this.lookAt);this.spherical.setFromVector(i),this.spherical.components[1]+=this.dPhi,this.spherical.components[2]+=this.dTheta,this.spherical.limit(0,.5*Math.PI,-(1/0),1/0),this.spherical.secure(),this.lookAt.add(this.dPan),i.setFromSphericalCoords(this.spherical),this.camera.position.copyFrom(this.lookAt).add(i),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this.dPhi=0,this.dTheta=0,this.dPan.set(0,0,0),this.zoomed&&(this.zoomed=!1),this.raiseEvent("updated")}}),Lore.CameraBase=function(){Lore.Node.call(this),this.type="Lore.CameraBase",this.renderer=null,this.isProjectionMatrixStale=!1,this.isViewMatrixStale=!1,this.projectionMatrix=new Lore.ProjectionMatrix,this.viewMatrix=new Lore.Matrix4f},Lore.CameraBase.prototype=Object.assign(Object.create(Lore.Node.prototype),{constructor:Lore.CameraBase,init:function(t,e){this.gl=t,this.program=e},setLookAt:function(t){this.rotation.lookAt(this.position,t,Lore.Vector3f.up())},updateProjectionMatrix:function(){},updateViewMatrix:function(){this.update();var t=this.modelMatrix.clone();t.invert(),this.viewMatrix=t,this.isViewMatrixStale=!0},getProjectionMatrix:function(){return this.projectionMatrix.entries},getViewMatrix:function(){return this.viewMatrix.entries},sceneToScreen:function(t,e){var o=t.clone(),n=e.canvas;o.project(this);var s=Math.round((o.components[0]+1)*n.width/2),r=Math.round((-o.components[1]+1)*n.height/2);return[s,r]}}),Lore.OrthographicCamera=function(t,e,o,n,s,r){Lore.CameraBase.call(this),this.type="Lore.OrthographicCamera",this.zoom=1,this.left=t,this.right=e,this.top=o,this.bottom=n,this.near=s||.1,this.far=r||2500,this.updateProjectionMatrix()},Lore.OrthographicCamera.prototype=Object.assign(Object.create(Lore.CameraBase.prototype),{constructor:Lore.OrthographicCamera,updateProjectionMatrix:function(){var t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),o=(this.right+this.left)/2,n=(this.top+this.bottom)/2,s=o-t,r=o+t,i=n+e,a=n-e;this.projectionMatrix.setOrthographic(s,r,i,a,this.near,this.far),this.isProjectionMatrixStale=!0}}),Lore.Array2=function(t){this.arr=t},Lore.Array2.prototype={constructor:Lore.Array2,multiply:function(t,e,o){t<<=1,this.arr[t]*=e,this.arr[t+1]*=o},multiplyScalar:function(t,e){t<<=1,this.arr[t]*=e,this.arr[t+1]*=e},divide:function(t,e,o){t<<=1,this.arr[t]/=e,this.arr[t+1]/=o},divideScalar:function(t,e){t<<=1,this.arr[t]/=e,this.arr[t+1]/=e},add:function(t,e,o){t<<=1,this.arr[t]+=e,this.arr[t+1]+=o},subtract:function(t,e,o){t<<=1,this.arr[t]-=e,this.arr[t+1]-=o}},Lore.Array3=function(t){this.arr=t},Lore.Array3.prototype={constructor:Lore.Array3,multiply:function(t,e,o,n){t*=3,this.arr[t]*=e,this.arr[t+1]*=o,this.arr[t+2]*=n},multiplyScalar:function(t,e){t*=3,this.arr[t]*=e,this.arr[t+1]*=e,this.arr[t+2]*=e},divide:function(t,e,o,n){t*=3,this.arr[t]/=e,this.arr[t+1]/=o,this.arr[t+2]/=n},divideScalar:function(t,e){t*=3,this.arr[t]/=e,this.arr[t+1]/=e,this.arr[t+2]/=e},add:function(t,e,o,n){t*=3,this.arr[t]+=e,this.arr[t+1]+=o,this.arr[t+2]+=n},subtract:function(t,e,o,n){t*=3,this.arr[t]-=e,this.arr[t+1]-=o,this.arr[t+2]-=n}},Lore.Vector2f=function(t,e){this.components=new Float32Array(2),this.components[0]=t||0,this.components[1]=e||0},Lore.Vector2f.prototype={constructor:Lore.Vector2f,set:function(t,e){return this.components[0]=t,this.components[1]=e,this},getX:function(){return this.components[0]},getY:function(){return this.components[1]},setX:function(t){this.components[0]=t},setY:function(t){this.components[1]=t},lengthSq:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]},length:function(){return Math.sqrt(this.lengthSq())},multiply:function(t){return this.components[0]*=t.components[0],this.components[1]*=t.components[1],this},multiplyScalar:function(t){return this.components[0]*=t,this.components[1]*=t,this},divide:function(t){return this.components[0]/=t.components[0],this.components[1]/=t.components[1],this},divideScalar:function(t){return this.components[0]/=t,this.components[1]/=t,this},add:function(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this},subtract:function(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this},clone:function(){return new Lore.Vector2f(this.components[0],this.components[1])},equals:function(t){return this.components[0]===t.components[0]&&this.components[1]===t.components[1]}},Lore.Vector2f.multiply=function(t,e){return new Lore.Vector2f(t.components[0]*e.components[0],t.components[1]*e.components[1])},Lore.Vector2f.multiplyScalar=function(t,e){return new Lore.Vector2f(t.components[0]*e,t.components[1]*e)},Lore.Vector2f.divide=function(t,e){return new Lore.Vector2f(t.components[0]/e.components[0],t.components[1]/e.components[1])},Lore.Vector2f.divideScalar=function(t,e){return new Lore.Vector2f(t.components[0]/e,t.components[1]/e)},Lore.Vector2f.add=function(t,e){return new Lore.Vector2f(t.components[0]+e.components[0],t.components[1]+e.components[1])},Lore.Vector2f.subtract=function(t,e){return new Lore.Vector2f(t.components[0]-e.components[0],t.components[1]-e.components[1])},Lore.Vector3f=function(t,e,o){1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(3),this.components[0]=t||0,this.components[1]=e||0,this.components[2]=o||0)},Lore.Vector3f.prototype={constructor:Lore.Vector3f,set:function(t,e,o){return this.components[0]=t,this.components[1]=e,this.components[2]=o,this},getX:function(){return this.components[0]},getY:function(){return this.components[1]},getZ:function(){return this.components[2]},setX:function(t){return this.components[0]=t,this},setY:function(t){return this.components[1]=t,this},setZ:function(t){return this.components[2]=t,this},setFromSphericalCoords:function(t){var e=t.components[0],o=t.components[1],n=t.components[2],s=Math.sin(o)*e;return this.components[0]=Math.sin(n)*s,this.components[1]=Math.cos(o)*e,this.components[2]=Math.cos(n)*s,this},copyFrom:function(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this},setLength:function(t){return this.multiplyScalar(t/this.length())},lengthSq:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},multiply:function(t){return this.components[0]*=t.components[0],this.components[1]*=t.components[1],this.components[2]*=t.components[2],this},multiplyScalar:function(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this},divide:function(t){return this.components[0]/=t.components[0],this.components[1]/=t.components[1],this.components[2]/=t.components[2],this},divideScalar:function(t){return this.components[0]/=t,this.components[1]/=t,this.components[2]/=t,this},add:function(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this},subtract:function(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this},dot:function(t){return this.components[0]*t.components[0]+this.components[1]*t.components[1]+this.components[2]*t.components[2]},cross:function(t){return new Lore.Vector3f(this.components[1]*t.components[2]-this.components[2]*t.components[1],this.components[2]*t.components[0]-this.components[0]*t.components[2],this.components[0]*t.components[1]-this.components[1]*t.components[0])},project:function(t){return this.applyProjection(Lore.Matrix4f.multiply(t.projectionMatrix,Lore.Matrix4f.invert(t.modelMatrix)))},unproject:function(t){return this.applyProjection(Lore.Matrix4f.multiply(t.modelMatrix,Lore.Matrix4f.invert(t.projectionMatrix)))},applyProjection:function(t){var e=this.components[0],o=this.components[1],n=this.components[2],s=t.entries,r=1/(s[3]*e+s[7]*o+s[11]*n+s[15]);return this.components[0]=(s[0]*e+s[4]*o+s[8]*n+s[12])*r,this.components[1]=(s[1]*e+s[5]*o+s[9]*n+s[13])*r,this.components[2]=(s[2]*e+s[6]*o+s[10]*n+s[14])*r,this},toDirection:function(t){var e=this.components[0],o=this.components[1],n=this.components[2],s=t.entries;this.components[0]=s[0]*e+s[4]*o+s[8]*n,this.components[1]=s[1]*e+s[5]*o+s[9]*n,this.components[2]=s[2]*e+s[6]*o+s[10]*n,this.normalize()},applyQuaternion:function(t){var e=this.components[0],o=this.components[1],n=this.components[2],s=t.components[0],r=t.components[1],i=t.components[2],a=t.components[3],c=a*e+r*n-i*o,h=a*o+i*e-s*n,u=a*n+s*o-r*e,l=-s*e-r*o-i*n;return this.components[0]=c*a+l*-s+h*-i-u*-r,this.components[1]=h*a+l*-r+u*-s-c*-i,this.components[2]=u*a+l*-i+c*-r-h*-s,this},distanceToSq:function(t){var e=this.components[0]-t.components[0],o=this.components[1]-t.components[1],n=this.components[2]-t.components[2];return e*e+o*o+n*n},distanceTo:function(t){return Math.sqrt(this.distanceToSq(t))},clone:function(){return new Lore.Vector3f(this.components[0],this.components[1],this.components[2])},equals:function(t){return this.components[0]===t.components[0]&&this.components[1]===t.components[1]&&this.components[2]===t.components[2]},toString:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}},Lore.Vector3f.normalize=function(t){return Lore.Vector3f.divideScalar(t,t.length())},Lore.Vector3f.multiply=function(t,e){return new Lore.Vector3f(t.components[0]*e.components[0],t.components[1]*e.components[1],t.components[2]*e.components[2])},Lore.Vector3f.multiplyScalar=function(t,e){return new Lore.Vector3f(t.components[0]*e,t.components[1]*e,t.components[2]*e)},Lore.Vector3f.divide=function(t,e){return new Lore.Vector3f(t.components[0]/e.components[0],t.components[1]/e.components[1],t.components[2]/e.components[2]);
},Lore.Vector3f.divideScalar=function(t,e){return new Lore.Vector3f(t.components[0]/e,t.components[1]/e,t.components[2]/e)},Lore.Vector3f.add=function(t,e){return new Lore.Vector3f(t.components[0]+e.components[0],t.components[1]+e.components[1],t.components[2]+e.components[2])},Lore.Vector3f.subtract=function(t,e){return new Lore.Vector3f(t.components[0]-e.components[0],t.components[1]-e.components[1],t.components[2]-e.components[2])},Lore.Vector3f.cross=function(t,e){return new Lore.Vector3f(t.components[1]*e.components[2]-t.components[2]*e.components[1],t.components[2]*e.components[0]-t.components[0]*e.components[2],t.components[0]*e.components[1]-t.components[1]*e.components[0])},Lore.Vector3f.dot=function(t,e){return t.components[0]*e.components[0]+t.components[1]*e.components[1]+t.components[2]*e.components[2]},Lore.Vector3f.forward=function(){return new Lore.Vector3f(0,0,1)},Lore.Vector3f.up=function(){return new Lore.Vector3f(0,1,0)},Lore.Vector3f.right=function(){return new Lore.Vector3f(1,0,0)},Lore.Matrix3f=function(t){this.entries=t||new Float32Array([1,0,0,0,1,0,0,0,1])},Lore.Matrix3f.prototype={constructor:Lore.Matrix3f,clone:function(){return new Lore.Matrix3f(new Float32Array(this.entries))},equals:function(t){for(var e=0;e<this.entries.length;e++)if(this.entries[e]!==t.entries[e])return!1;return!0}},Lore.Matrix4f=function(t){this.entries=t||new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Lore.Matrix4f.prototype={constructor:Lore.Matrix4f,set:function(t,e,o,n,s,r,i,a,c,h,u,l,m,f,p,d){this.entries.set([t,e,o,n,s,r,i,a,c,h,u,l,m,f,p,d])},multiplyA:function(t){var e=this.entries[0],o=this.entries[4],n=this.entries[8],s=this.entries[12],r=this.entries[1],i=this.entries[5],a=this.entries[9],c=this.entries[13],h=this.entries[2],u=this.entries[6],l=this.entries[10],m=this.entries[14],f=this.entries[3],p=this.entries[7],d=this.entries[11],g=this.entries[15],v=t.entries[0],x=t.entries[4],L=t.entries[8],y=t.entries[12],P=t.entries[1],A=t.entries[5],b=t.entries[9],N=t.entries[13],w=t.entries[2],S=t.entries[6],E=t.entries[10],M=t.entries[14],_=t.entries[3],T=t.entries[7],F=t.entries[11],C=t.entries[15];return this.entries[0]=e*v+o*P+n*w+s*_,this.entries[1]=r*v+i*P+a*w+c*_,this.entries[2]=f*v+p*P+d*w+g*_,this.entries[3]=e*x+o*A+n*S+s*T,this.entries[4]=h*v+u*P+l*w+m*_,this.entries[5]=r*x+i*A+a*S+c*T,this.entries[6]=h*x+u*A+l*S+m*T,this.entries[7]=f*x+p*A+d*S+g*T,this.entries[8]=e*L+o*b+n*E+s*F,this.entries[9]=r*L+i*b+a*E+c*F,this.entries[10]=h*L+u*b+l*E+m*F,this.entries[11]=f*L+p*b+d*E+g*F,this.entries[12]=e*y+o*N+n*M+s*C,this.entries[13]=r*y+i*N+a*M+c*C,this.entries[14]=h*y+u*N+l*M+m*C,this.entries[15]=f*y+p*N+d*M+g*C,this},multiplyB:function(t){var e=t.entries[0],o=t.entries[4],n=t.entries[8],s=t.entries[12],r=t.entries[1],i=t.entries[5],a=t.entries[9],c=t.entries[13],h=t.entries[2],u=t.entries[6],l=t.entries[10],m=t.entries[14],f=t.entries[3],p=t.entries[7],d=t.entries[11],g=t.entries[15],v=this.entries[0],x=this.entries[4],L=this.entries[8],y=this.entries[12],P=this.entries[1],A=this.entries[5],b=this.entries[9],N=this.entries[13],w=this.entries[2],S=this.entries[6],E=this.entries[10],M=this.entries[14],_=this.entries[3],T=this.entries[7],F=this.entries[11],C=this.entries[15];return this.entries[0]=e*v+o*P+n*w+s*_,this.entries[1]=r*v+i*P+a*w+c*_,this.entries[2]=f*v+p*P+d*w+g*_,this.entries[3]=e*x+o*A+n*S+s*T,this.entries[4]=h*v+u*P+l*w+m*_,this.entries[5]=r*x+i*A+a*S+c*T,this.entries[6]=h*x+u*A+l*S+m*T,this.entries[7]=f*x+p*A+d*S+g*T,this.entries[8]=e*L+o*b+n*E+s*F,this.entries[9]=r*L+i*b+a*E+c*F,this.entries[10]=h*L+u*b+l*E+m*F,this.entries[11]=f*L+p*b+d*E+g*F,this.entries[12]=e*y+o*N+n*M+s*C,this.entries[13]=r*y+i*N+a*M+c*C,this.entries[14]=h*y+u*N+l*M+m*C,this.entries[15]=f*y+p*N+d*M+g*C,this},scale:function(t){var e=t.components[0],o=t.components[1],n=t.components[2];return this.entries[0]*=e,this.entries[1]*=e,this.entries[2]*=e,this.entries[3]*=e,this.entries[4]*=o,this.entries[5]*=o,this.entries[6]*=o,this.entries[7]*=o,this.entries[8]*=n,this.entries[9]*=n,this.entries[10]*=n,this.entries[11]*=n,this},setPosition:function(t){return this.entries[12]=t.components[0],this.entries[13]=t.components[1],this.entries[14]=t.components[2],this},setRotation:function(t){var e=t.components[0],o=t.components[1],n=t.components[2],s=t.components[3],r=e+e,i=o+o,a=n+n,c=e*r,h=e*i,u=e*a,l=o*i,m=o*a,f=n*a,p=s*r,d=s*i,g=s*a;return this.entries[0]=1-(l+f),this.entries[1]=h+g,this.entries[2]=u-d,this.entries[4]=h-g,this.entries[5]=1-(c+f),this.entries[6]=m+p,this.entries[8]=u+d,this.entries[9]=m-p,this.entries[10]=1-(c+l),this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[12]=0,this.entries[13]=0,this.entries[14]=0,this.entries[15]=1,this},determinant:function(){var t=a.entries[0],e=a.entries[4],o=a.entries[8],n=a.entries[12],s=a.entries[1],r=a.entries[5],i=a.entries[9],c=a.entries[13],h=a.entries[2],u=a.entries[6],l=a.entries[10],m=a.entries[14],f=a.entries[3],p=a.entries[7],d=a.entries[11],g=a.entries[15];return f*(n*i*u-o*c*u-n*r*l+e*c*l+o*r*m-e*i*m)+p*(t*i*m-t*c*l+n*s*l-o*s*m+o*c*h-n*i*h)+d*(t*c*u-t*r*m-n*s*u+e*s*m+n*r*h-e*c*h)+g*(-o*r*h-t*i*u+t*r*l+o*s*u-e*s*l+e*i*h)},decompose:function(t,e,o){var n=(new Lore.Vector3f,new Lore.Matrix4f);position.set(this.entries[12],this.entries[13],this.entries[14]);var s=Math.sqrt(this.entries[0]*this.entries[0]+this.entries[1]*this.entries[1]+this.entries[2]*this.entries[2]),r=Math.sqrt(this.entries[4]*this.entries[4]+this.entries[5]*this.entries[5]+this.entries[6]*this.entries[6]),i=Math.sqrt(this.entries[8]*this.entries[8]+this.entries[9]*this.entries[9]+this.entries[10]*this.entries[10]),a=this.determinant();0>a&&(s=-s),o.set(s,r,i);var c=1/s,h=1/r,u=1/i;return n.entries.set(this.entries),n.entries[0]*=c,n.entries[1]*=c,n.entries[2]*=c,n.entries[4]*=h,n.entries[5]*=h,n.entries[6]*=h,n.entries[8]*=u,n.entries[9]*=u,n.entries[10]*=u,e.setFromMatrix(n),this},compose:function(t,e,o){return this.setRotation(e),this.scale(o),this.setPosition(t),this},invert:function(){var t=new Lore.Matrix4f,e=this.entries;t.entries[0]=e[5]*e[10]*e[15]-e[5]*e[11]*e[14]-e[9]*e[6]*e[15]+e[9]*e[7]*e[14]+e[13]*e[6]*e[11]-e[13]*e[7]*e[10],t.entries[4]=-e[4]*e[10]*e[15]+e[4]*e[11]*e[14]+e[8]*e[6]*e[15]-e[8]*e[7]*e[14]-e[12]*e[6]*e[11]+e[12]*e[7]*e[10],t.entries[8]=e[4]*e[9]*e[15]-e[4]*e[11]*e[13]-e[8]*e[5]*e[15]+e[8]*e[7]*e[13]+e[12]*e[5]*e[11]-e[12]*e[7]*e[9],t.entries[12]=-e[4]*e[9]*e[14]+e[4]*e[10]*e[13]+e[8]*e[5]*e[14]-e[8]*e[6]*e[13]-e[12]*e[5]*e[10]+e[12]*e[6]*e[9],t.entries[1]=-e[1]*e[10]*e[15]+e[1]*e[11]*e[14]+e[9]*e[2]*e[15]-e[9]*e[3]*e[14]-e[13]*e[2]*e[11]+e[13]*e[3]*e[10],t.entries[5]=e[0]*e[10]*e[15]-e[0]*e[11]*e[14]-e[8]*e[2]*e[15]+e[8]*e[3]*e[14]+e[12]*e[2]*e[11]-e[12]*e[3]*e[10],t.entries[9]=-e[0]*e[9]*e[15]+e[0]*e[11]*e[13]+e[8]*e[1]*e[15]-e[8]*e[3]*e[13]-e[12]*e[1]*e[11]+e[12]*e[3]*e[9],t.entries[13]=e[0]*e[9]*e[14]-e[0]*e[10]*e[13]-e[8]*e[1]*e[14]+e[8]*e[2]*e[13]+e[12]*e[1]*e[10]-e[12]*e[2]*e[9],t.entries[2]=e[1]*e[6]*e[15]-e[1]*e[7]*e[14]-e[5]*e[2]*e[15]+e[5]*e[3]*e[14]+e[13]*e[2]*e[7]-e[13]*e[3]*e[6],t.entries[6]=-e[0]*e[6]*e[15]+e[0]*e[7]*e[14]+e[4]*e[2]*e[15]-e[4]*e[3]*e[14]-e[12]*e[2]*e[7]+e[12]*e[3]*e[6],t.entries[10]=e[0]*e[5]*e[15]-e[0]*e[7]*e[13]-e[4]*e[1]*e[15]+e[4]*e[3]*e[13]+e[12]*e[1]*e[7]-e[12]*e[3]*e[5],t.entries[14]=-e[0]*e[5]*e[14]+e[0]*e[6]*e[13]+e[4]*e[1]*e[14]-e[4]*e[2]*e[13]-e[12]*e[1]*e[6]+e[12]*e[2]*e[5],t.entries[3]=-e[1]*e[6]*e[11]+e[1]*e[7]*e[10]+e[5]*e[2]*e[11]-e[5]*e[3]*e[10]-e[9]*e[2]*e[7]+e[9]*e[3]*e[6],t.entries[7]=e[0]*e[6]*e[11]-e[0]*e[7]*e[10]-e[4]*e[2]*e[11]+e[4]*e[3]*e[10]+e[8]*e[2]*e[7]-e[8]*e[3]*e[6],t.entries[11]=-e[0]*e[5]*e[11]+e[0]*e[7]*e[9]+e[4]*e[1]*e[11]-e[4]*e[3]*e[9]-e[8]*e[1]*e[7]+e[8]*e[3]*e[5],t.entries[15]=e[0]*e[5]*e[10]-e[0]*e[6]*e[9]-e[4]*e[1]*e[10]+e[4]*e[2]*e[9]+e[8]*e[1]*e[6]-e[8]*e[2]*e[5];var o=e[0]*t.entries[0]+e[1]*t.entries[4]+e[2]*t.entries[8]+e[3]*t.entries[12];if(0==o)throw"Determinant is zero.";o=1/o;for(var n=0;16>n;n++)this.entries[n]=t.entries[n]*o;return this},clone:function(){return new Lore.Matrix4f(new Float32Array(this.entries))},equals:function(t){for(var e=0;e<this.entries.length;e++)if(this.entries[e]!==t.entries[e])return!1;return!0},toString:function(){console.log(this.entries[0]+", "+this.entries[4]+", "+this.entries[8]+", "+this.entries[12]),console.log(this.entries[1]+", "+this.entries[5]+", "+this.entries[9]+", "+this.entries[13]),console.log(this.entries[2]+", "+this.entries[6]+", "+this.entries[10]+", "+this.entries[14]),console.log(this.entries[3]+", "+this.entries[7]+", "+this.entries[11]+", "+this.entries[15])}},Lore.Matrix4f.multiply=function(t,e){var o=t.entries[0],n=t.entries[4],s=t.entries[8],r=t.entries[12],i=t.entries[1],a=t.entries[5],c=t.entries[9],h=t.entries[13],u=t.entries[2],l=t.entries[6],m=t.entries[10],f=t.entries[14],p=t.entries[3],d=t.entries[7],g=t.entries[11],v=t.entries[15],x=e.entries[0],L=e.entries[4],y=e.entries[8],P=e.entries[12],A=e.entries[1],b=e.entries[5],N=e.entries[9],w=e.entries[13],S=e.entries[2],E=e.entries[6],M=e.entries[10],_=e.entries[14],T=e.entries[3],F=e.entries[7],C=e.entries[11],z=e.entries[15];return new Lore.Matrix4f(new Float32Array([o*x+n*A+s*S+r*T,i*x+a*A+c*S+h*T,u*x+l*A+m*S+f*T,p*x+d*A+g*S+v*T,o*L+n*b+s*E+r*F,i*L+a*b+c*E+h*F,u*L+l*b+m*E+f*F,p*L+d*b+g*E+v*F,o*y+n*N+s*M+r*C,i*y+a*N+c*M+h*C,u*y+l*N+m*M+f*C,p*y+d*N+g*M+v*C,o*P+n*w+s*_+r*z,i*P+a*w+c*_+h*z,u*P+l*w+m*_+f*z,p*P+d*w+g*_+v*z]))},Lore.Matrix4f.fromQuaternion=function(t){var e=t.components[0],o=t.components[1],n=t.components[2],s=t.components[3],r=e+e,i=o+o,a=n+n,c=e*r,h=e*i,u=e*a,l=o*i,m=o*a,f=n*a,p=s*r,d=s*i,g=s*a;return new Lore.Matrix4f(new Float32Array([1-(l+f),h+g,u-d,0,h-g,1-(c+f),m+p,0,u+d,m-p,1-(c+l),0,0,0,0,1]))},Lore.Matrix4f.lookAt=function(t,e,o){var n=Lore.Vector3f.subtract(t,e).normalize();0===n.lengthSq()&&(n.components[2]=1);var s=Lore.Vector3f.cross(o,n).normalize();0===s.lengthSq()&&(n.components[2]+=1e-4,s=Lore.Vector3f.cross(o,n).normalize());var r=Lore.Vector3f.cross(n,s);return new Lore.Matrix4f(new Float32Array([s.components[0],s.components[1],s.components[2],0,r.components[0],r.components[1],r.components[2],0,n.components[0],n.components[1],n.components[2],0,0,0,0,1]))},Lore.Matrix4f.compose=function(t,e,o){var n=new Lore.Matrix4f;return n.setRotation(e),n.scale(o),n.setPosition(t),n},Lore.Matrix4f.invert=function(t){var e=new Lore.Matrix4f,o=t.entries;e.entries[0]=o[5]*o[10]*o[15]-o[5]*o[11]*o[14]-o[9]*o[6]*o[15]+o[9]*o[7]*o[14]+o[13]*o[6]*o[11]-o[13]*o[7]*o[10],e.entries[4]=-o[4]*o[10]*o[15]+o[4]*o[11]*o[14]+o[8]*o[6]*o[15]-o[8]*o[7]*o[14]-o[12]*o[6]*o[11]+o[12]*o[7]*o[10],e.entries[8]=o[4]*o[9]*o[15]-o[4]*o[11]*o[13]-o[8]*o[5]*o[15]+o[8]*o[7]*o[13]+o[12]*o[5]*o[11]-o[12]*o[7]*o[9],e.entries[12]=-o[4]*o[9]*o[14]+o[4]*o[10]*o[13]+o[8]*o[5]*o[14]-o[8]*o[6]*o[13]-o[12]*o[5]*o[10]+o[12]*o[6]*o[9],e.entries[1]=-o[1]*o[10]*o[15]+o[1]*o[11]*o[14]+o[9]*o[2]*o[15]-o[9]*o[3]*o[14]-o[13]*o[2]*o[11]+o[13]*o[3]*o[10],e.entries[5]=o[0]*o[10]*o[15]-o[0]*o[11]*o[14]-o[8]*o[2]*o[15]+o[8]*o[3]*o[14]+o[12]*o[2]*o[11]-o[12]*o[3]*o[10],e.entries[9]=-o[0]*o[9]*o[15]+o[0]*o[11]*o[13]+o[8]*o[1]*o[15]-o[8]*o[3]*o[13]-o[12]*o[1]*o[11]+o[12]*o[3]*o[9],e.entries[13]=o[0]*o[9]*o[14]-o[0]*o[10]*o[13]-o[8]*o[1]*o[14]+o[8]*o[2]*o[13]+o[12]*o[1]*o[10]-o[12]*o[2]*o[9],e.entries[2]=o[1]*o[6]*o[15]-o[1]*o[7]*o[14]-o[5]*o[2]*o[15]+o[5]*o[3]*o[14]+o[13]*o[2]*o[7]-o[13]*o[3]*o[6],e.entries[6]=-o[0]*o[6]*o[15]+o[0]*o[7]*o[14]+o[4]*o[2]*o[15]-o[4]*o[3]*o[14]-o[12]*o[2]*o[7]+o[12]*o[3]*o[6],e.entries[10]=o[0]*o[5]*o[15]-o[0]*o[7]*o[13]-o[4]*o[1]*o[15]+o[4]*o[3]*o[13]+o[12]*o[1]*o[7]-o[12]*o[3]*o[5],e.entries[14]=-o[0]*o[5]*o[14]+o[0]*o[6]*o[13]+o[4]*o[1]*o[14]-o[4]*o[2]*o[13]-o[12]*o[1]*o[6]+o[12]*o[2]*o[5],e.entries[3]=-o[1]*o[6]*o[11]+o[1]*o[7]*o[10]+o[5]*o[2]*o[11]-o[5]*o[3]*o[10]-o[9]*o[2]*o[7]+o[9]*o[3]*o[6],e.entries[7]=o[0]*o[6]*o[11]-o[0]*o[7]*o[10]-o[4]*o[2]*o[11]+o[4]*o[3]*o[10]+o[8]*o[2]*o[7]-o[8]*o[3]*o[6],e.entries[11]=-o[0]*o[5]*o[11]+o[0]*o[7]*o[9]+o[4]*o[1]*o[11]-o[4]*o[3]*o[9]-o[8]*o[1]*o[7]+o[8]*o[3]*o[5],e.entries[15]=o[0]*o[5]*o[10]-o[0]*o[6]*o[9]-o[4]*o[1]*o[10]+o[4]*o[2]*o[9]+o[8]*o[1]*o[6]-o[8]*o[2]*o[5];var n=o[0]*e.entries[0]+o[1]*e.entries[4]+o[2]*e.entries[8]+o[3]*e.entries[12];if(0==n)throw"Determinant is zero.";n=1/n;for(var s=0;16>s;s++)e.entries[s]=e.entries[s]*n;return e},Lore.Quaternion=function(t,e,o,n){1===arguments.length?this.components=new Float32Array(t):2===arguments.length?(this.components=new Float32Array(4),this.setFromAxisAngle(t,e)):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=e||0,this.components[2]=o||0,this.components[3]=void 0!==n?n:1)},Lore.Quaternion.prototype={constructor:Lore.Quaternion,getX:function(){return this.components[0]},getY:function(){return this.components[1]},getZ:function(){return this.components[2]},getW:function(){return this.components[3]},set:function(t,e,o,n){this.components[0]=t,this.components[1]=e,this.components[2]=o,this.components[3]=n},setX:function(t){this.components[0]=t},setY:function(t){this.components[1]=t},setZ:function(t){this.components[2]=t},setW:function(t){this.components[3]=t},setFromAxisAngle:function(t,e){var o=Lore.Vector3f.normalize(t),n=e/2,s=Math.sin(n);this.components[0]=o.components[0]*s,this.components[1]=o.components[1]*s,this.components[2]=o.components[2]*s,this.components[3]=Math.cos(n)},setFromUnitVectors:function(t,e){var o=null,n=t.dot(e)+1;1e-6>n?(o=new Lore.Vector3f,n=0,Math.abs(t.components[0])>Math.abs(t.components[2])?o.set(-t.components[1],t.components[0],0):o.set(0,-t.components[2],t.components[1])):o=Lore.Vector3f.cross(t,e),this.set(o.components[0],o.components[1],o.components[2],n),this.normalize()},lookAt:function(t,e,o){return this.setFromMatrix(Lore.Matrix4f.lookAt(t,e,o)),this},lengthSq:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]+this.components[3]*this.components[3]},length:function(){return Math.sqrt(this.lengthSq())},inverse:function(){return this.conjugate().normalize()},normalize:function(){var t=this.length();if(0===t)this.components[0]=0,this.components[1]=0,this.components[2]=0,this.components[3]=1;else{var e=1/t;this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e}return this},dot:function(t){return this.components[0]*t.components[0]+this.components[1]*t.components[1]+this.components[2]*t.components[2]+this.components[3]*t.components[3]},multiplyA:function(t){var e=this.components[0]*t.components[3]+this.components[3]*t.components[0]+this.components[1]*t.components[2]-this.components[2]*t.components[1],o=this.components[1]*t.components[3]+this.components[3]*t.components[1]+this.components[2]*t.components[0]-this.components[0]*t.components[2],n=this.components[2]*t.components[3]+this.components[3]*t.components[2]+this.components[0]*t.components[1]-this.components[1]*t.components[0],s=this.components[3]*t.components[3]-this.components[0]*t.components[0]-this.components[1]*t.components[1]-this.components[2]*t.components[2];return this.components[0]=e,this.components[1]=o,this.components[2]=n,this.components[3]=s,this},multiplyB:function(t){var e=t.components[0]*this.components[3]+t.components[3]*this.components[0]+t.components[1]*this.components[2]-t.components[2]*this.components[1],o=t.components[1]*this.components[3]+t.components[3]*this.components[1]+t.components[2]*this.components[0]-t.components[0]*this.components[2],n=t.components[2]*this.components[3]+t.components[3]*this.components[2]+t.components[0]*this.components[1]-t.components[1]*this.components[0],s=t.components[3]*this.components[3]-t.components[0]*this.components[0]-t.components[1]*this.components[1]-t.components[2]*this.components[2];return this.components[0]=e,this.components[1]=o,this.components[2]=n,this.components[3]=s,this},multiplyScalar:function(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this.components[3]*=t,this},conjugate:function(){return this.components[0]*=-1,this.components[1]*=-1,this.components[2]*=-1,this},add:function(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this.components[3]+=t.components[3],this},subtract:function(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this.components[3]-=t.components[3],this},rotateX:function(t){var e=t/2;return this.multiplyA(new Lore.Quaternion(Math.sin(e),0,0,Math.cos(e)))},rotateY:function(t){var e=t/2;return this.multiplyA(new Lore.Quaternion(0,Math.sin(e),0,Math.cos(e)))},rotateZ:function(t){var e=t/2;return this.multiplyA(new Lore.Quaternion(0,0,Math.sin(e),Math.cos(e)))},toAxisAngle:function(){console.warn("The method toAxisAngle() has not been implemented.")},toRotationMatrix:function(){var t=this.components[0],e=this.components[1],o=this.components[2],n=this.components[3],s=t*t,r=t*e,i=t*o,a=t*n,c=e*n,h=e*e,u=e*o,l=o*o,m=o*n,f=new Lore.Matrix4f;return f.entries[0]=1-2*(h+l),f.entries[1]=2*(r+m),f.entries[2]=2*(i-c),f.entries[4]=2*(u-m),f.entries[5]=1-2*(s+l),f.entries[6]=2*(u+a),f.entries[8]=2*(i+c),f.entries[9]=2*(u-a),f.entries[10]=1-2*(s+h),f},setFromMatrix:function(t){var e=t.entries[0],o=t.entries[4],n=t.entries[8],s=t.entries[1],r=t.entries[5],i=t.entries[9],a=t.entries[2],c=t.entries[6],h=t.entries[10],u=e+r+h;if(u>0){var l=.5/Math.sqrt(u+1);this.components[0]=(c-i)*l,this.components[1]=(n-a)*l,this.components[2]=(s-o)*l,this.components[3]=.25/l}else if(e>r&&e>h){var l=2*Math.sqrt(1+e-r-h);this.components[0]=.25*l,this.components[1]=(o+s)/l,this.components[2]=(n+a)/l,this.components[3]=(c-i)/l}else if(r>h){var l=2*Math.sqrt(1+r-e-h);this.components[0]=(o+s)/l,this.components[1]=.25*l,this.components[2]=(i+c)/l,this.components[3]=(n-a)/l}else{var l=2*Math.sqrt(1+h-e-r);this.components[0]=(n+a)/l,this.components[1]=(i+c)/l,this.components[2]=.25*l,this.components[3]=(s-o)/l}return this},clone:function(){return new Lore.Quaternion(this.components[0],this.components[1],this.components[2],this.components[3])},equals:function(t){return this.components[0]===t.components[0]&&this.components[1]===t.components[1]&&this.components[2]===t.components[2]&&this.components[3]===t.components[3]},toString:function(){return"x: "+this.getX()+", y: "+this.getY()+", z: "+this.getZ()+", w: "+this.getW()}},Lore.Quaternion.dot=function(t,e){return new Lore.Quaternion(t.components[0]*e.components[0]+t.components[1]*e.components[1]+t.components[2]*e.components[2]+t.components[3]*e.components[3])},Lore.Quaternion.multiply=function(t,e){return new Lore.Quaternion(t.components[0]*e.components[3]+t.components[3]*e.components[0]+t.components[1]*e.components[2]-t.components[2]*e.components[1],t.components[1]*e.components[3]+t.components[3]*e.components[1]+t.components[2]*e.components[0]-t.components[0]*e.components[2],t.components[2]*e.components[3]+t.components[3]*e.components[2]+t.components[0]*e.components[1]-t.components[1]*e.components[0],t.components[3]*e.components[3]+t.components[0]*e.components[0]+t.components[1]*e.components[1]-t.components[2]*e.components[2])},Lore.Quaternion.multiplyScalar=function(t,e){return new Lore.Quaternion(t.components[0]*e,t.components[1]*e,t.components[2]*e,t.components[3]*e)},Lore.Quaternion.inverse=function(t){var e=new Lore.Quaternion(t.components);return e.conjugate().normalize()},Lore.Quaternion.normalize=function(t){var e=t.length();if(0===e)return new Lore.Quaternion(0,0,0,1);var o=1/e;return new Lore.Quaternion(t.components[0]*o,t.components[1]*o,t.components[2]*o,t.components[3]*o)},Lore.Quaternion.conjugate=function(t){return new Lore.Quaternion(-1*t.components[0],-1*t.components[1],-1*t.components[2],t.components[3])},Lore.Quaternion.add=function(t,e){return new Lore.Quaternion(t.components[0]+e.components[0],t.components[1]+e.components[1],t.components[2]+e.components[2],t.components[3]+e.components[3])},Lore.Quaternion.subtract=function(t,e){return new Lore.Quaternion(t.components[0]-e.components[0],t.components[1]-e.components[1],t.components[2]-e.components[2],t.components[3]-e.components[3])},Lore.Quaternion.fromMatrix=function(t){var e=new Lore.Quaternion;return e.setFromMatrix(t),e},Lore.Quaternion.slerp=function(t,e,o){if(0===o)return new Lore.Quaternion(t.components);if(1===o)return new Lore.Quaternion(e.components);var n=new Lore.Quaternion(e.components),s=t.components[0]*n.components[0]+t.components[1]*n.components[1]+t.components[2]*n.components[2]+t.components[3]*n.components[3];if(0>s&&(n.multiplyScalar(-1),s=-s),Math.abs(s)>=1)return new Lore.Quaternion(t.components);var r=Math.acos(s),i=sqrt(1-s*s);if(Math.abs(i)<.001)return new Lore.Quaternion(.5*t.components[0]+.5*n.components[0],.5*t.components[1]+.5*n.components[1],.5*t.components[2]+.5*n.components[2],.5*t.components[3]+.5*n.components[3]);var a=Math.sin((1-o)*r)/i,c=Math.sin(o*r)/i;return new Lore.Quaternion(t.components[0]*a+n.components[0]*c,t.components[1]*a+n.components[1]*c,t.components[2]*a+n.components[2]*c,t.components[3]*a+n.components[3]*c)},Lore.SphericalCoords=function(t,e,o){this.components=new Float32Array(3),this.radius=void 0!==t?t:1,this.phi=e?e:0,this.theta=o?o:0},Lore.SphericalCoords.prototype={constructor:Lore.SphericalCoords,set:function(t,e,o){return this.components[0]=t,this.components[1]=e,this.components[2]=o,this},secure:function(){return this.components[1]=Math.max(1e-6,Math.min(Math.PI-1e-6,this.components[1])),this},setFromVector:function(t){return this.components[0]=t.length(),0===this.components[0]?(this.components[1]=0,this.components[2]=0):(this.components[1]=Math.acos(Math.max(-1,Math.min(1,t.components[1]/this.components[0]))),this.components[2]=Math.atan2(t.components[0],t.components[2])),this},limit:function(t,e,o,n){this.components[1]=Math.max(t,Math.min(e,this.components[1])),this.components[2]=Math.max(o,Math.min(n,this.components[2]))},clone:function(){return new Lore.SphericalCoords(this.radius,this.phi,this.theta)},toString:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}},Lore.ProjectionMatrix=function(){Lore.Matrix4f.call(this)},Lore.ProjectionMatrix.prototype=Object.assign(Object.create(Lore.Matrix4f.prototype),{constructor:Lore.ProjectionMatrix,setOrthographic:function(t,e,o,n,s,r){var i=1/(e-t),a=1/(o-n),c=1/(r-s),h=(e+t)*i,u=(o+n)*a,l=(r+s)*c;return this.set(),this.entries[0]=2*i,this.entries[4]=0,this.entries[8]=0,this.entries[12]=-h,this.entries[1]=0,this.entries[5]=2*a,this.entries[9]=0,this.entries[13]=-u,this.entries[2]=0,this.entries[6]=0,this.entries[10]=-2*c,this.entries[14]=-l,this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[15]=1,this}}),Lore.Statistics=function(){},Lore.Statistics.prototype={constructor:Lore.Vector2f},Lore.Statistics.spareRandomNormal=null,Lore.Statistics.randomNormal=function(){var t,e,o,n,s;if(null!==Lore.Statistics.spareRandomNormal)t=Lore.Statistics.spareRandomNormal,Lore.Statistics.spareRandomNormal=null;else{do e=2*Math.random()-1,o=2*Math.random()-1,n=e*e+o*o;while(0===n||n>=1);s=Math.sqrt(-2*Math.log(n)/n),t=e*s,Lore.Statistics.spareRandomNormal=o*s}return t/14},Lore.Statistics.randomNormalInRange=function(t,e){var o;do o=Lore.Statistics.randomNormal();while(t>o||o>e);return o},Lore.Statistics.randomNormalScaled=function(t,e){var o=Lore.Statistics.randomNormalInRange(-1,1);return o*e+t},Lore.Statistics.normalize=function(t){for(var e=Number.MIN_VALUE,o=Number.MAX_VALUE,n=0;n<t.length;n++){var s=t[n];s>e&&(e=s),o>s&&(o=s)}for(var r=e-o,n=0;n<t.length;n++)t[n]=(t[n]-o)/r;return[o,e]},Lore.Statistics.scale=function(t,e,o,n,s){return(s-n)*(t-e)/(o-e)+n},Lore.Ray=function(t,e){this.source=t||new Lore.Vector3f,this.direction=e||new Lore.Vector3f},Lore.Ray.prototype={constructor:Lore.Ray,copyFrom:function(t){return this.source.copyFrom(t.source),this.direction.copyFrom(t.direction),this},applyProjection:function(t){return this.direction.add(this.source).applyProjection(t),this.source.applyProjection(t),this.direction.subtract(this.source),this.direction.normalize(),this},distanceSqToPoint:function(t){var e=Lore.Vector3f.subtract(t,this.source),o=e.dot(this.direction);return 0>o?this.source.distanceToSq(t):(e.copyFrom(this.direction).multiplyScalar(o).add(this.source),e.distanceToSq(t))},closestPointToPoint:function(t){var e=Lore.Vector3f.subtract(t,this.source),o=e.dot(this.direction);return 0>o?e.copyFrom(this.source):e.copyFrom(this.direction).multiplyScalar(o).add(this.source)}},Lore.HelperBase=function(t,e,o){Lore.Node.call(this),this.renderer=t,this.shader=Lore.Shaders[o],this.program=this.renderer.createProgram(this.shader),this.geometry=this.renderer.createGeometry(e,this.program)},Lore.HelperBase.prototype=Object.assign(Object.create(Lore.Node.prototype),{constructor:Lore.HelperBase,setAttribute:function(t,e){this.geometry.addAttribute(t,e)},updateAttribute:function(t,e,o){for(var n=this.geometry.attributes[t],s=e*n.attributeLength,r=0;r<n.attributeLength;r++)n.data[s+r]=o[r]||n.data[s+r];n.stale=!0},updateAttributeAll:function(t,e){for(var o=this.geometry.attributes[t],n=0;n<o.data.length;n++)o.data[n]=e[n];o.stale=!0},draw:function(){this.geometry.draw(this.renderer)}}),Lore.PointHelper=function(t,e,o,n){Lore.HelperBase.call(this,t,e,o),this.opts=Lore.Utils.extend(!0,Lore.PointHelper.defaults,n),this.indices=null,this.octree=null,this.geometry.setMode(Lore.DrawModes.points),this.initPointSize()},Lore.PointHelper.prototype=Object.assign(Object.create(Lore.HelperBase.prototype),{constructor:Lore.PointHelper,getMaxLength:function(t,e,o){return Math.max(t.length,Math.max(e.length,o.length))},setPositions:function(t){this.setAttribute("position",t)},setPositionsXYZ:function(t,e,o,n){for(var s=new Float32Array(3*n),r=0;n>r;r++){var i=3*r;s[i]=t[r]||0,s[i+1]=e[r]||0,s[i+2]=o[r]||0}if(this.opts.octree){for(var a=Lore.AABB.fromPoints(s),c=new Uint32Array(n),r=0;n>r;r++)c[r]=r;this.octree=new Lore.Octree,this.octree.build(c,s,a)}this.setAttribute("position",s)},setPositionsXYZColor:function(t,e,o,n){var s=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,s),this.setColor(n,s)},setPositionsXYZRGB:function(t,e,o,n,s,r,i){i=!!i;var a=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,a),this.setRGB(n,s,r,a,i)},setPositionsXYZHues:function(t,e,o,n){var s=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,s),this.setHues(n,s)},setPositionsXYZHSL:function(t,e,o,n,s,r){var i=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,i),this.setHSL(n,s,r,i)},setHues:function(t,e){for(var o=new Float32Array(3*e),n=0;e>n;n++){var s=t[n]||0;s=Lore.Statistics.scale(s,0,1,.2,1),s=1-s,s=this.shiftHue(s,-.2);var r=Lore.Color.hslToRgb(s,.5,.5);o[3*n]=r[0],o[3*n+1]=r[1],o[3*n+2]=r[2]}this.setColors(o)},setHSL:function(t,e,o,n){for(var s=new Float32Array(3*n),r=0;n>r;r++){var i=t[r]||0;i=Lore.Statistics.scale(i,0,1,.2,1),i=1-i,i=this.shiftHue(i,-.2);var a=Lore.Color.hslToRgb(i,e[r],o[r]);s[3*r]=a[0],s[3*r+1]=a[1],s[3*r+2]=a[2]}this.setColors(s)},shiftHue:function(t,e){return t+=e,t>1&&(t-=1),0>t&&(t=1+t),t},setColors:function(t){this.setAttribute("color",t)},updateColors:function(t){this.updateAttributeAll("color",t)},updateColor:function(t,e){this.updateAttribute("color",t,e.components)},setPointSize:function(t){this.geometry.shader.uniforms.size.value=t*this.opts.pointScale},getPointSize:function(){return this.geometry.shader.uniforms.size.value},setFogDistance:function(t){this.geometry.shader.uniforms.fogDistance.value=t},initPointSize:function(){this.geometry.shader.uniforms.size.value=this.renderer.camera.zoom*this.opts.pointScale},getCutoff:function(){return this.geometry.shader.uniforms.cutoff.value},setCutoff:function(t){this.geometry.shader.uniforms.cutoff.value=t},setRGB:function(t,e,o,n,s){var r=new Float32Array(3*n);if(s)for(var i=0;n>i;i++){var a=3*i;r[a]=t[i]/255,r[a+1]=e[i]/255,r[a+2]=o[i]/255}else for(var i=0;n>i;i++){var a=3*i;r[a]=t[i],r[a+1]=e[i],r[a+2]=o[i]}this.setColors(r)},updateRGB:function(t,e,o){for(var n=new Float32Array(3*t.length),s=0;s<t.length;s++){var r=3*s;n[r]=t[s],n[r+1]=e[s],n[r+2]=o[s]}this.updateColors(n)},setColor:function(t,e){for(var o=new Float32Array(3*e),n=0;3*e>n;n+=3)o[n]=t.components[0],o[n+1]=t.components[1],o[n+2]=t.components[2];this.setColors(o)}}),Lore.PointHelper.defaults={octree:!0,pointScale:1},Lore.CoordinatesHelper=function(t,e,o,n){Lore.HelperBase.call(this,t,e,o),this.opts=Lore.Utils.extend(!0,Lore.CoordinatesHelper.defaults,n),this.geometry.setMode(Lore.DrawModes.lines),this.init()},Lore.CoordinatesHelper.prototype=Object.assign(Object.create(Lore.HelperBase.prototype),{constructor:Lore.CoordinatesHelper,init:function(){var t=this.opts.position.components,e=this.opts.axis,o=[t[0],t[1],t[2],t[0]+e.x.length,t[1],t[2],t[0],t[1],t[2],t[0],t[1]+e.y.length,t[2],t[0],t[1],t[2],t[0],t[1],t[2]+e.z.length],n=e.x.color.components,s=e.y.color.components,r=e.z.color.components,i=[n[0],n[1],n[2],n[0],n[1],n[2],s[0],s[1],s[2],s[0],s[1],s[2],r[0],r[1],r[2],r[0],r[1],r[2]];if(this.opts.box.enabled){var a=this.opts.box.x.color.components,c=this.opts.box.y.color.components,h=this.opts.box.z.color.components;o.push(t[0]+e.x.length,t[1]+e.y.length,t[2]+e.z.length,t[0],t[1]+e.y.length,t[2]+e.z.length,t[0]+e.x.length,t[1],t[2]+e.z.length,t[0],t[1],t[2]+e.z.length,t[0]+e.x.length,t[1]+e.y.length,t[2],t[0],t[1]+e.y.length,t[2],t[0]+e.x.length,t[1]+e.y.length,t[2]+e.z.length,t[0]+e.x.length,t[1],t[2]+e.z.length,t[0],t[1]+e.y.length,t[2]+e.z.length,t[0],t[1],t[2]+e.z.length,t[0]+e.x.length,t[1]+e.y.length,t[2],t[0]+e.x.length,t[1],t[2],t[0]+e.x.length,t[1]+e.y.length,t[2]+e.z.length,t[0]+e.x.length,t[1]+e.y.length,t[2],t[0],t[1]+e.y.length,t[2]+e.z.length,t[0],t[1]+e.y.length,t[2],t[0]+e.x.length,t[1],t[2]+e.z.length,t[0]+e.x.length,t[1],t[2]),i.push(a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2])}for(var u=this.opts.ticks.x,l=e.x.length/u.count,m=this.opts.ticks.y,f=e.y.length/m.count,p=this.opts.ticks.z,d=e.z.length/p.count,g=t[0],v=u.color.components,x=0;x<u.count-1;x++)g+=l,o.push(g+u.offset.components[0],t[1]+u.offset.components[1],t[2]+u.offset.components[2],g+u.offset.components[0],t[1]+u.offset.components[1]+u.length,t[2]+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[0];for(var x=0;x<u.count-1;x++)g+=l,o.push(g+u.offset.components[0],t[1]+u.offset.components[1],t[2]+u.offset.components[2],g+u.offset.components[0],t[1]+u.offset.components[1],t[2]+u.offset.components[2]+u.length),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[1],v=m.color.components;for(var x=0;x<m.count-1;x++)g+=f,o.push(t[0]+u.offset.components[0],g+u.offset.components[1],t[2]+u.offset.components[2],t[0]+u.offset.components[0]+u.length,g+u.offset.components[1],t[2]+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[1];for(var x=0;x<m.count-1;x++)g+=f,o.push(t[0]+u.offset.components[0],g+u.offset.components[1],t[2]+u.offset.components[2],t[0]+u.offset.components[0],g+u.offset.components[1],t[2]+u.offset.components[2]+u.length),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[2],v=p.color.components;for(var x=0;x<p.count-1;x++)g+=d,o.push(t[0]+u.offset.components[0],t[1]+u.offset.components[1],g+u.offset.components[2],t[0]+u.offset.components[0],t[1]+u.offset.components[1]+u.length,g+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[2];for(var x=0;x<p.count-1;x++)g+=d,o.push(t[0]+u.offset.components[0],t[1]+u.offset.components[1],g+u.offset.components[2],t[0]+u.offset.components[0]+u.length,t[1]+u.offset.components[1],g+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);this.setAttribute("position",new Float32Array(o)),this.setAttribute("color",new Float32Array(i))}}),Lore.CoordinatesHelper.defaults={
position:new Lore.Vector3f,axis:{x:{length:50,color:Lore.Color.fromHex("#222222")},y:{length:50,color:Lore.Color.fromHex("#222222")},z:{length:50,color:Lore.Color.fromHex("#222222")}},ticks:{x:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")},y:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")},z:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")}},box:{enabled:!0,x:{color:Lore.Color.fromHex("#999999")},y:{color:Lore.Color.fromHex("#999999")},z:{color:Lore.Color.fromHex("#999999")}}},Lore.OctreeHelper=function(t,e,o,n,s){Lore.HelperBase.call(this,t,e,o),this.opts=Lore.Utils.extend(!0,Lore.OctreeHelper.defaults,s),this.eventListeners={},this.target=n,this.renderer=t,this.octree=this.target.octree,this.raycaster=new Lore.Raycaster,this.hovered=null,this.selected=null;var r=this;t.controls.addEventListener("dblclick",function(e){if(!e.e.mouse.state.middle&&!e.e.mouse.state.right){var o=e.e.mouse.normalizedPosition,n=r.getIntersections(o);n.length>0?(r.selected=n[0],r.selected.screenPosition=r.renderer.camera.sceneToScreen(n[0].position,t),r.raiseEvent("selectedchanged",{e:r.selected})):(r.selected=null,r.raiseEvent("selectedchanged",{e:null}))}}),t.controls.addEventListener("mousemove",function(e){if(!(e.e.mouse.state.left||e.e.mouse.state.middle||e.e.mouse.state.right)){var o=e.e.mouse.normalizedPosition,n=r.getIntersections(o);n.length>0?(r.hovered=n[0],r.hovered.screenPosition=r.renderer.camera.sceneToScreen(n[0].position,t),r.raiseEvent("hoveredchanged",{e:r.hovered})):(r.hovered=null,r.raiseEvent("hoveredchanged",{e:null}))}}),t.controls.addEventListener("zoomchanged",function(t){r.target.setPointSize(t*window.devicePixelRatio+.05)}),t.controls.addEventListener("updated",function(){r.selected&&(r.selected.screenPosition=r.renderer.camera.sceneToScreen(r.selected.position,t)),r.hovered&&(r.hovered.screenPosition=r.renderer.camera.sceneToScreen(r.hovered.position,t)),r.raiseEvent("updated")}),this.init()},Lore.OctreeHelper.prototype=Object.assign(Object.create(Lore.HelperBase.prototype),{constructor:Lore.OctreeHelper,init:function(){"centers"===this.opts.visualize?this.drawCenters():"cubes"===this.opts.visualize?this.drawBoxes():this.geometry.isVisible=!1},showCenters:function(){this.opts.visualize="centers",this.drawCenters(),this.geometry.isVisible=!0},showCubes:function(){this.opts.visualize="cubes",this.drawBoxes(),this.geometry.isVisible=!0},hide:function(){this.opts.visualize=!1,this.geometry.isVisible=!1,this.setAttribute("position",new Float32Array([])),this.setAttribute("color",new Float32Array([]))},getIntersections:function(t){this.raycaster.set(this.renderer.camera,t.x,t.y);var e=this.octree.raySearch(this.raycaster),o=this.rayIntersections(e);return o.sort(function(t,e){return t.distance-e.distance}),o},addEventListener:function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},raiseEvent:function(t,e){if(this.eventListeners[t])for(var o=0;o<this.eventListeners[t].length;o++)this.eventListeners[t][o](e)},drawCenters:function(){this.geometry.setMode(Lore.DrawModes.points);var t=this.octree.aabbs,e=Object.keys(t).length,o=new Float32Array(3*e),n=new Float32Array(3*e),s=0;for(key in t){var r=t[key].center.components,i=3*s;o[i]=1,o[i+1]=1,o[i+2]=1,n[i]=r[0],n[i+1]=r[1],n[i+2]=r[2],s++}this.setAttribute("position",new Float32Array(n)),this.setAttribute("color",new Float32Array(o))},drawBoxes:function(){this.geometry.setMode(Lore.DrawModes.lines);for(var t=this.octree.aabbs,e=Object.keys(t).length,o=new Float32Array(24*e*3),n=new Float32Array(24*e*3),s=0;s<o.length;s++)o[s]=1;var r=0;for(key in t){var i=Lore.AABB.getCorners(t[key]);n[r++]=i[0][0],n[r++]=i[0][1],n[r++]=i[0][2],n[r++]=i[1][0],n[r++]=i[1][1],n[r++]=i[1][2],n[r++]=i[0][0],n[r++]=i[0][1],n[r++]=i[0][2],n[r++]=i[2][0],n[r++]=i[2][1],n[r++]=i[2][2],n[r++]=i[0][0],n[r++]=i[0][1],n[r++]=i[0][2],n[r++]=i[4][0],n[r++]=i[4][1],n[r++]=i[4][2],n[r++]=i[1][0],n[r++]=i[1][1],n[r++]=i[1][2],n[r++]=i[3][0],n[r++]=i[3][1],n[r++]=i[3][2],n[r++]=i[1][0],n[r++]=i[1][1],n[r++]=i[1][2],n[r++]=i[5][0],n[r++]=i[5][1],n[r++]=i[5][2],n[r++]=i[2][0],n[r++]=i[2][1],n[r++]=i[2][2],n[r++]=i[3][0],n[r++]=i[3][1],n[r++]=i[3][2],n[r++]=i[2][0],n[r++]=i[2][1],n[r++]=i[2][2],n[r++]=i[6][0],n[r++]=i[6][1],n[r++]=i[6][2],n[r++]=i[3][0],n[r++]=i[3][1],n[r++]=i[3][2],n[r++]=i[7][0],n[r++]=i[7][1],n[r++]=i[7][2],n[r++]=i[4][0],n[r++]=i[4][1],n[r++]=i[4][2],n[r++]=i[5][0],n[r++]=i[5][1],n[r++]=i[5][2],n[r++]=i[4][0],n[r++]=i[4][1],n[r++]=i[4][2],n[r++]=i[6][0],n[r++]=i[6][1],n[r++]=i[6][2],n[r++]=i[5][0],n[r++]=i[5][1],n[r++]=i[5][2],n[r++]=i[7][0],n[r++]=i[7][1],n[r++]=i[7][2],n[r++]=i[6][0],n[r++]=i[6][1],n[r++]=i[6][2],n[r++]=i[7][0],n[r++]=i[7][1],n[r++]=i[7][2]}this.setAttribute("position",n),this.setAttribute("color",o)},rayIntersections:function(t){var e=[],o=Lore.Matrix4f.invert(this.target.modelMatrix),n=new Lore.Ray,s=this.raycaster.threshold,r=this.target.geometry.attributes.position.data,i=null;"color"in this.target.geometry.attributes&&(i=this.target.geometry.attributes.color.data);var a=this.target.getCutoff();n.copyFrom(this.raycaster.ray).applyProjection(o);for(var c=s,h=c*c,u=0;u<t.length;u++){var l=t[u].index,m=t[u].locCode,f=3*l,p=new Lore.Vector3f(r[f],r[f+1],r[f+2]),d=n.distanceSqToPoint(p);if(h>d){var g=n.closestPointToPoint(p);g.applyProjection(this.target.modelMatrix);var v=this.raycaster.ray.source.distanceTo(g);if(v<this.raycaster.near||v>this.raycaster.far||a>v)continue;e.push({distance:v,index:l,locCode:m,position:p,color:i?[i[f],i[f+1],i[f+2]]:null})}}return e}}),Lore.OctreeHelper.defaults={visualize:!1},Lore.FileReaderBase=function(t){this.elementId=t,this.element=document.getElementById(this.elementId),this.eventListeners={};var e=this;this.element.addEventListener("change",function(){var t=new FileReader;t.onload=function(){e.loaded(t.result)},t.readAsBinaryString(this.files[0])})},Lore.FileReaderBase.prototype={constructor:Lore.FileReaderBase,addEventListener:function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},raiseEvent:function(t,e){if(this.eventListeners[t])for(var o=0;o<this.eventListeners[t].length;o++)this.eventListeners[t][o](e)},loaded:function(t){}},Lore.CsvFileReader=function(t,e){Lore.FileReaderBase.call(this,t),this.opts=Lore.Utils.extend(!0,Lore.CsvFileReader.defaults,e),this.columns=[]},Lore.CsvFileReader.prototype=Object.assign(Object.create(Lore.FileReaderBase.prototype),{constructor:Lore.CsvFileReader,loaded:function(t){t=t.replace("\n\n","\n"),t=t.replace(/^\s+|\s+$/g,"");for(var e=t.split("\n"),o=e.length,n=!0,s=this.opts.cols,r=this.opts.header?1:0,i=r;o>i;i++){var a=e[i].split(this.opts.separator);if(0==s.length)for(var c=0;c<a.length;c++)s.push[c];if(n){for(var c=0;c<s.length;c++)this.createArray(c,this.opts.types[c],o-r);n=!1}for(var c=0;c<s.length;c++)this.columns[c][i-r]=a[s[c]]}this.raiseEvent("loaded",this.columns)},createArray:function(t,e,o){"Int8Array"==e?this.columns[t]=new Int8Array(o):"Uint8Array"==e?this.columns[t]=new Uint8Array(o):"Uint8ClampedArray"==e?this.columns[t]=new Uint8ClampedArray(o):"Int16Array"==e?this.columns[t]=new Int16Array(o):"Uint16Array"==e?this.columns[t]=new Uint16Array(o):"Int32Array"==e?this.columns[t]=new Int32Array(o):"Uint32Array"==e?this.columns[t]=new Uint32Array(o):"Float32Array"==e?this.columns[t]=new Float32Array(o):"Float64Array"==e?this.columns[t]=new Float64Array(o):this.columns[t]=new Array(o)}}),Lore.CsvFileReader.defaults={separator:",",cols:[],types:[],header:!0},Lore.Utils={},Lore.Utils.extend=function(){var t={},e=!1,o=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(e=arguments[0],o++);for(var s=function(o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e&&"[object Object]"===Object.prototype.toString.call(o[n])?t[n]=Lore.Utils.extend(!0,t[n],o[n]):t[n]=o[n])};n>o;o++){var r=arguments[o];s(r)}return t},Lore.Utils.arrayContains=function(t,e){for(var o=0;o<t.length;o++)if(t[o]===e)return!0;return!1},Lore.Utils.concatTypedArrays=function(t,e){var o=new t.constructor(t.length+e.length);return o.set(t),o.set(e,t.length),o},Lore.Utils.msb=function(t){return 2147483648&t?31:Lore.Utils.msb(t<<1|1)-1},Lore.Utils.mergePointDistances=function(t,e){var o={};return o.indices=Lore.Utils.concatTypedArrays(t.indices,e.indices),o.distancesSq=Lore.Utils.concatTypedArrays(t.distancesSq,e.distancesSq),o},Lore.Shaders["default"]=new Lore.Shader("Default",{size:new Lore.Uniform("size",5,"float"),fogDistance:new Lore.Uniform("fogDistance",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogDistance;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff) {","vDiscard = 1.0;","return;","}","float fog_start = cutoff;","float fog_end = fogDistance + cutoff;","float dist = abs(mv_pos.z - fog_start);","gl_PointSize = size;","if(fogDistance > 0.0) {","vec3 hsv = rgb2hsv(color);","hsv.b = clamp((fog_end - dist) / (fog_end - fog_start), 0.0, 1.0);","vColor = hsv2rgb(hsv);","}","else {","vColor = color;","}","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard == 1.0) discard;","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.coordinates=new Lore.Shader("Coordinates",{},["attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","gl_PointSize = 1.0;","vColor = color;","}"],["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.circle=new Lore.Shader("Circle",{size:new Lore.Uniform("size",5,"float")},["uniform float size;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","gl_PointSize = size;","vColor = color;","}"],["varying vec3 vColor;","void main() {","float r = 1.0, delta = 0.0, alpha = 1.0;","vec2 cxy = 2.0 * gl_PointCoord - 1.0;","r = dot(cxy, cxy);","#ifdef GL_OES_standard_derivatives","delta = fwidth(r);","alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);","#endif","gl_FragColor = vec4(vColor, alpha);","}"]),Lore.Shaders.sphere=new Lore.Shader("Sphere",{size:new Lore.Uniform("size",5,"float"),fogDistance:new Lore.Uniform("fogDistance",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogDistance;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff) {","vDiscard = 1.0;","return;","}","float fog_start = cutoff;","float fog_end = fogDistance + cutoff;","float dist = abs(mv_pos.z - fog_start);","gl_PointSize = size;","if(fogDistance > 0.0) {","vec3 hsv = rgb2hsv(color);","hsv.b = clamp((fog_end - dist) / (fog_end - fog_start), 0.0, 1.0);","vColor = hsv2rgb(hsv);","}","else {","vColor = color;","}","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard == 1.0) discard;","vec3 N;","N.xy = gl_PointCoord * 2.0 - vec2(1.0);","float mag = dot(N.xy, N.xy);","if (mag > 1.0) discard;   // kill pixels outside circle","N.z = sqrt(1.0 - mag);","float diffuse = max(0.5, dot(vec3(0.25, -0.25, 1.0), N));","gl_FragColor = vec4(vColor * diffuse, 1.0);","}"]),Lore.Shaders.defaultEffect=new Lore.Shader("DefaultEffect",{},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main(void) {","vec4 color = texture2D(fbo_texture, f_texcoord);","gl_FragColor = color;","}"]),Lore.Shaders.fxaaEffect=new Lore.Shader("FXAAEffect",{resolution:new Lore.Uniform("resolution",[500,500],"float_vec2")},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","uniform vec2 resolution;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["#define fxaaTexture2D(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#define fxaaSat(x) clamp(x, 0.0, 1.0)","#define FXAA_QUALITY_PS 8","#define FXAA_QUALITY_P0 1.0","#define FXAA_QUALITY_P1 1.5","#define FXAA_QUALITY_P2 2.0","#define FXAA_QUALITY_P3 2.0","#define FXAA_QUALITY_P4 2.0","#define FXAA_QUALITY_P5 2.0","#define FXAA_QUALITY_P6 4.0","#define FXAA_QUALITY_P7 12.0","vec4 fxaa(vec2 pos, sampler2D tex, vec2 resolution,","float subpixQuality, float edgeThreshold, float edgeThresholdMin) {","vec2 posM;","posM.x = pos.x;","posM.y = pos.y;","vec4 rgbyM = texture2D(tex, posM);","vec3 luma = vec3(0.299, 0.587, 0.114);","float lumaM = dot(rgbyM.xyz, luma);","float lumaS = dot(fxaaTexture2D(tex, posM, vec2(0, 1), resolution.xy).xyz, luma);","float lumaE = dot(fxaaTexture2D(tex, posM, vec2(1, 0), resolution.xy).xyz, luma);","float lumaN = dot(fxaaTexture2D(tex, posM, vec2(0, -1), resolution.xy).xyz, luma);","float lumaW = dot(fxaaTexture2D(tex, posM, vec2(-1, 0), resolution.xy).xyz, luma);","float maxSM = max(lumaS, lumaM);","float minSM = min(lumaS, lumaM);","float maxESM = max(lumaE, maxSM);","float minESM = min(lumaE, minSM);","float maxWN = max(lumaN, lumaW);","float minWN = min(lumaN, lumaW);","float rangeMax = max(maxWN, maxESM);","float rangeMin = min(minWN, minESM);","float rangeMaxScaled = rangeMax * edgeThreshold;","float range = rangeMax - rangeMin;","float rangeMaxClamped = max(edgeThresholdMin, rangeMaxScaled);","bool earlyExit = range < rangeMaxClamped;","// maybe return rgbyM -> leave unchanged","if(earlyExit) return rgbyM;","float lumaNW = dot(fxaaTexture2D(tex, posM, vec2(-1, -1), resolution.xy).xyz, luma);","float lumaSE = dot(fxaaTexture2D(tex, posM, vec2(1, 1), resolution.xy).xyz, luma);","float lumaNE = dot(fxaaTexture2D(tex, posM, vec2(1, -1), resolution.xy).xyz, luma);","float lumaSW = dot(fxaaTexture2D(tex, posM, vec2(-1, 1), resolution.xy).xyz, luma);","float lumaNS = lumaN + lumaS;","float lumaWE = lumaW + lumaE;","float subpixRcpRange = 1.0 / range;","float subpixNSWE = lumaNS + lumaWE;","float edgeHorz1 = (-2.0 * lumaM) + lumaNS;","float edgeVert1 = (-2.0 * lumaM) + lumaWE;","float lumaNESE = lumaNE + lumaSE;","float lumaNWNE = lumaNW + lumaNE;","float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","float lumaNWSW = lumaNW + lumaSW;","float lumaSWSE = lumaSW + lumaSE;","float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","float edgeHorz = abs(edgeHorz3) + edgeHorz4;","float edgeVert = abs(edgeVert3) + edgeVert4;","float subpixNWSWNESE = lumaNWSW + lumaNESE;","float lengthSign = resolution.x;","bool horzSpan = edgeHorz >= edgeVert;","float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","if(!horzSpan) lumaN = lumaW;","if(!horzSpan) lumaS = lumaE;","if(horzSpan) lengthSign = resolution.y;","float subpixB = (subpixA * (1.0/12.0)) - lumaM;","float gradientN = lumaN - lumaM;","float gradientS = lumaS - lumaM;","float lumaNN = lumaN + lumaM;","float lumaSS = lumaS + lumaM;","bool pairN = abs(gradientN) >= abs(gradientS);","float gradient = max(abs(gradientN), abs(gradientS));","if(pairN) lengthSign = -lengthSign;","float subpixC = fxaaSat(abs(subpixB) * subpixRcpRange);","vec2 posB;","posB.x = posM.x;","posB.y = posM.y;","vec2 offNP;","offNP.x = (!horzSpan) ? 0.0 : resolution.x;","offNP.y = ( horzSpan) ? 0.0 : resolution.y;","if(!horzSpan) posB.x += lengthSign * 0.5;","if( horzSpan) posB.y += lengthSign * 0.5;","vec2 posN;","posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","vec2 posP;","posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","float subpixD = ((-2.0)*subpixC) + 3.0;","float lumaEndN = texture2D(tex, posN).w;","float subpixE = subpixC * subpixC;","float lumaEndP = texture2D(tex, posP).w;","if(!pairN) lumaNN = lumaSS;","float gradientScaled = gradient * 1.0/4.0;","float lumaMM = lumaM - lumaNN * 0.5;","float subpixF = subpixD * subpixE;","bool lumaMLTZero = lumaMM < 0.0;","lumaEndN -= lumaNN * 0.5;","lumaEndP -= lumaNN * 0.5;","bool doneN = abs(lumaEndN) >= gradientScaled;","bool doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","bool doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","#if (FXAA_QUALITY_PS > 3)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","#if (FXAA_QUALITY_PS > 4)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","#if (FXAA_QUALITY_PS > 5)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","#if (FXAA_QUALITY_PS > 6)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","#if (FXAA_QUALITY_PS > 7)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","#if (FXAA_QUALITY_PS > 8)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","#if (FXAA_QUALITY_PS > 9)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","#if (FXAA_QUALITY_PS > 10)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","#if (FXAA_QUALITY_PS > 11)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","#if (FXAA_QUALITY_PS > 12)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","float dstN = posM.x - posN.x;","float dstP = posP.x - posM.x;","if(!horzSpan) dstN = posM.y - posN.y;","if(!horzSpan) dstP = posP.y - posM.y;","bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","float spanLength = (dstP + dstN);","bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","float spanLengthRcp = 1.0 / spanLength;","bool directionN = dstN < dstP;","float dst = min(dstN, dstP);","bool goodSpan = directionN ? goodSpanN : goodSpanP;","float subpixG = subpixF * subpixF;","float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","float subpixH = subpixG * subpixQuality;","float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","// maybe return vec4(texture2D(tex, posM).xyz, lumaM);","return texture2D(tex, posM);","}","uniform sampler2D fbo_texture;","uniform vec2 resolution;","varying vec2 f_texcoord;","void main(void) {","gl_FragColor = fxaa(f_texcoord, fbo_texture, vec2(1.0 / resolution.x, 1.0 / resolution.y), 0.75, 0.166, 0.0833);","}"]),Lore.Octree=function(t,e){this.threshold=t||500,this.maxDepth=e||8,this.points={},this.aabbs={}},Lore.Octree.prototype={constructor:Lore.Octree,build:function(t,e,o,n){n=n||1,o.setLocCode(n),this.points[n]=null,this.aabbs[n]=o;var s=this.getDepth(n);if(t.length<=this.threshold||s>=this.maxDepth){this.points[n]=new Uint32Array(t.length);for(var r=0;r<t.length;r++)this.points[n][r]=t[r];return!0}for(var i=new Uint32Array(8),a=new Float32Array(t.length),r=0;r<t.length;r++){var c=3*t[r];e[c+0]>=o.center.components[0]&&(a[r]|=4),e[c+1]>=o.center.components[1]&&(a[r]|=2),e[c+2]>=o.center.components[2]&&(a[r]|=1),i[a[r]]++}for(var h=new Array(8),u=new Array(8),r=0;8>r;r++)if(0!=i[r]){h[r]=new Uint32Array(i[r]);for(var l=0,c=0;l<t.length;l++)a[l]==r&&(h[r][c++]=t[l]);var m=Lore.Octree.OctreeOffsets[r],f=new Lore.Vector3f(m[0],m[1],m[2]);f.multiplyScalar(o.radius),u[r]=new Lore.AABB(o.center.clone().add(f),.5*o.radius)}for(var r=0;8>r;r++)if(0!=i[r]){var p=this.generateLocCode(n,r);this.build(h[r],e,u[r],p)}},getLocCodes:function(){return Object.keys(this.aabbs)},getDepth:function(t){return Lore.Utils.msb(t)/3},generateLocCode:function(t,e){var o=Lore.Utils.msb(t);return-1==o?8|e:(t=t<<=3,t|e)},traverse:function(t,e){e=e||1;for(var o=0;8>o;o++){var n=e<<3|o;this.aabbs[n]&&(t(this.points[n],this.aabbs[n],n),this.traverse(t,n))}},traverseIf:function(t,e,o){o=o||1;for(var n=0;8>n;n++){var s=o<<3|n;if(this.aabbs[s]){if(!e(this.aabbs[s],s))continue;t(this.points[s],this.aabbs[s],s),this.traverseIf(t,e,s)}}},raySearch:function(t){var e=[],o=t.ray.direction.clone();o.normalize();var n=new Lore.Vector3f(1,1,1);return n.divide(o),this.traverseIf(function(t,o,n){if(t)for(var s=0;s<t.length;s++)e.push({index:t[s],locCode:n})},function(e,o){return e.cylinderTest(t.ray.source,n,t.far,t.threshold)}),e},getCenters:function(t){t=t||0;var e=new Array;return this.traverse(function(o,n,s){o&&o.length>t&&e.push(n.center)}),e},getClosestBox:function(t,e,o){o=o||1;for(var n=-1,s=Number.MAX_VALUE,r=0;8>r;r++){var i=o<<3|r;if(this.aabbs[i]){if(this.points[i]&&this.points[i].length<e)continue;var a=this.aabbs[i].distanceToPointSq(t.components[0],t.components[1],t.components[2]);s>a&&(s=a,n=i)}}return 0>n?this.aabbs[o]:this.getClosestBox(t,e,n)},getFarthestBox:function(t,e,o){o=o||1;for(var n=-1,s=Number.MIN_VALUE,r=0;8>r;r++){var i=o<<3|r;if(this.aabbs[i]){if(this.points[i]&&this.points[i].length<e)continue;var a=this.aabbs[i].distanceToPointSq(t.components[0],t.components[1],t.components[2]);a>s&&(s=a,n=i)}}return 0>n?this.aabbs[o]:this.getFarthestBox(t,e,n)},getClosestPoint:function(t,e,o,n){o=o||0;var s=Number.MAX_VALUE,r=null,i=null;i=n?this.aabbs[n]:this.getClosestBox(t,o);var a=this.points[i.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var h=a[c];h*=3;var u=e[h],l=e[h+1],m=e[h+2],f=t.components,p=Math.pow(f[0]-u,2)+Math.pow(f[1]-l,2)+Math.pow(f[2]-m,2);s>p&&(s=p,r={x:u,y:l,z:m})}return r?new Lore.Vector3f(r.x,r.y,r.z):null},getFarthestPoint:function(t,e,o,n){o=o||0;var s=Number.MIN_VALUE,r=null,i=null;i=n?this.aabbs[n]:this.getFArthestBox(t,o);var a=this.points[i.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var h=a[c];h*=3;var u=e[h],l=e[h+1],m=e[h+2],f=t.components,p=Math.pow(f[0]-u,2)+Math.pow(f[1]-l,2)+Math.pow(f[2]-m,2);p>s&&(s=p,r={x:u,y:l,z:m})}return r?new Lore.Vector3f(r.x,r.y,r.z):null},getParent:function(t){return t>>>3},getNeighbours:function(t){var e=this,o=new Array;return this.traverseIf(function(e,n,s){e&&e.length>0&&s!=t&&o.push(s)},function(o,n){return o.testAABB(e.aabbs[t])}),o},kNearestNeighbours:function(t,e,o,n,s){t+=1;for(var r=this.positions/3,i=3*e,a={x:n[i],y:n[i+1],z:n[i+2]},c=a.components[0],h=a.components[1],u=a.components[2],l=this.getCellDistancesToPoint(c,h,u,o),m=this.pointDistancesSq(c,h,u,o,n),f=new RadixSort,p=f.sort(m.distancesSq,!0),d=f.sort(l.distancesSq,!0),g=0,v=0,x=new Uint32Array(t),L=0;t>v&&L<p.array.length;L++){if(p.array[L]>d.array[0]){g=L;break}x[L]=m.indices[p.indices[L]],v++}if(v==t)return x;for(var L=0;L<d.array.length;L++){var o=l.locCodes[d.indices[L]],y=this.pointDistancesSq(c,h,u,o,n);m=Lore.Utils.mergePointDistances(m,y);for(var P=f.sort(m.distancesSq,!0),A=g;t>v&&A<P.array.length;A++){if(P.array[A]>d.array[L+1]){g=A;break}x[A]=m.indices[P.indices[A]],v++}if(v==t||v>=r-1)return x}return x},getCellDistancesToPoint:function(t,e,o,n){var s=new Array;this.traverse(function(t,e,o){t&&t.length>0&&o!=n&&s.push(o)});for(var r=new Float32Array(s.length),i=0;i<s.length;i++)r[i]=this.aabbs[s[i]].distanceToPointSq(t,e,o);return{locCodes:s,distancesSq:r}},expandNeighbourhood:function(t,e,o,n,s){for(var r=s.locCodes,i=s.distancesSq,a=r.length,c=a-1;c>=0;c--)for(var h=this.getNeighbours(r[c]),u=0;u<h.length;u++)h[u]==n&&console.log(n),h[u]==n||Lore.Utils.arrayContains(r,h[u])||r.push(h[u]);var l=r.length,m=i.length;if(l!=m){for(var f=new Float32Array(l-m),c=m,p=0;l>c;c++,p++)f[p]=this.aabbs[r[c]].distanceToPointSq(t,e,o);return s.distancesSq=Lore.Utils.concatTypedArrays(i,f),r.length-a}},cellDistancesSq:function(t,e,o,n){for(var s=this.getNeighbours(n),r=new Float32Array(s.length),i=0;i<s.length;i++)r[i]=this.aabbs[s[i]].distanceToPointSq(t,e,o);return{locCodes:s,distancesSq:r}},pointDistancesSq:function(t,e,o,n,s){for(var r=this.points[n],i=new Uint32Array(r.length),a=new Float32Array(r.length),c=0;c<r.length;c++){var h=3*r[c],u=s[h],l=s[h+1],m=s[h+2];i[c]=r[c],a[c]=Math.pow(u-t,2)+Math.pow(l-e,2)+Math.pow(m-o,2)}return{indices:i,distancesSq:a}}},Lore.Octree.clone=function(t){var e=new Lore.Octree;e.threshold=t.threshold,e.maxDepth=t.maxDepth,e.points=t.points;for(var o in t.aabbs)t.aabbs.hasOwnProperty(o)&&(e.aabbs[o]=Lore.AABB.clone(t.aabbs[o]));return e},Lore.Octree.OctreeOffsets=[[-.5,-.5,-.5],[-.5,-.5,.5],[-.5,.5,-.5],[-.5,.5,.5],[.5,-.5,-.5],[.5,-.5,.5],[.5,.5,-.5],[.5,.5,.5]],Lore.AABB=function(t,e){this.center=t||new Lore.Vector3f,this.radius=e||0,this.locCode=0,this.left=0,this.right=0,this.back=0,this.front=0,this.bottom=0,this.top=0,this.neighbours=new Array(6),this.min=new Float32Array(3),
this.max=new Float32Array(3),this.updateDimensions()},Lore.AABB.prototype={constructor:Lore.AABB,updateDimensions:function(){var t=this.center.components[0],e=this.center.components[1],o=this.center.components[2];this.min[0]=t-this.radius,this.min[1]=e-this.radius,this.min[2]=o-this.radius,this.max[0]=t+this.radius,this.max[1]=e+this.radius,this.max[2]=o+this.radius,this.left=t-this.radius,this.right=t+this.radius,this.back=o-this.radius,this.front=o+this.radius,this.bottom=e-this.radius,this.top=e+this.radius},setLocCode:function(t){this.locCode=t},getLocCode:function(){return this.locCode},rayTest:function(t,e,o){var n=t.components,s=e.components,r=(this.left-n[0])*s[0],i=(this.right-n[0])*s[0],a=(this.bottom-n[1])*s[1],c=(this.top-n[1])*s[1],h=(this.back-n[2])*s[2],u=(this.front-n[2])*s[2],l=Math.min(Math.max(r,i),Math.max(a,c),Math.max(h,u));if(0>l)return!1;var m=Math.max(Math.min(r,i),Math.min(a,c),Math.min(h,u));return!(m>l||m>o)},cylinderTest:function(t,e,o,n){this.radius+=n,this.updateDimensions();var s=this.rayTest(t,e,o);return this.radius-=n,this.updateDimensions(),s},distanceToPointSq:function(t,e,o){for(var n=0,s=[t,e,o],r=0;3>r;r++)s[r]<this.min[r]&&(n+=Math.pow(this.min[r]-s[r],2)),s[r]>this.max[r]&&(n+=Math.pow(s[r]-this.max[r],2));return n},testAABB:function(t){for(var e=0;3>e;e++)if(this.max[e]<t.min[e]||this.min[e]>t.max[e])return!1;return!0}},Lore.AABB.fromPoints=function(t){for(var e=t[0],o=t[1],n=t[2],s=new Lore.Vector3f(e,o,n),r=new Lore.Vector3f(e,o,n),i=s.components,a=r.components,c=1;c<t.length/3;c++)t[3*c+0]<i[0]&&(i[0]=t[3*c+0]),t[3*c+1]<i[1]&&(i[1]=t[3*c+1]),t[3*c+2]<i[2]&&(i[2]=t[3*c+2]),t[3*c+0]>a[0]&&(a[0]=t[3*c+0]),t[3*c+1]>a[1]&&(a[1]=t[3*c+1]),t[3*c+2]>a[2]&&(a[2]=t[3*c+2]);var h=new Lore.Vector3f.subtract(r,s);h.multiplyScalar(.5);var u=h.components[0],l=h.components[1],m=h.components[2],f=new Lore.Vector3f(u,l,m);f.add(s);var p=Math.max(u,l,m);return new Lore.AABB(f,p)},Lore.AABB.getCorners=function(t){var e=t.center.components,o=e[0],n=e[1],s=e[2],r=t.radius;return[[o-r,n-r,s-r],[o-r,n-r,s+r],[o-r,n+r,s-r],[o-r,n+r,s+r],[o+r,n-r,s-r],[o+r,n-r,s+r],[o+r,n+r,s-r],[o+r,n+r,s+r]]},Lore.AABB.clone=function(t){var e=new Lore.AABB;return e.back=t.back,e.bottom=t.bottom,e.center=new Lore.Vector3f(t.center.components[0],t.center.components[1],t.center.components[2]),e.front=t.front,e.left=t.left,e.locCode=t.locCode,e.max=t.max,e.min=t.min,e.radius=t.radius,e.right=t.right,e.top=t.top,e},Lore.Raycaster=function(){this.ray=new Lore.Ray,this.near=0,this.far=1e3,this.threshold=.5},Lore.Raycaster.prototype={constructor:Lore.Raycaster,set:function(t,e,o){this.near=t.near,this.far=t.far,this.ray.source.set(e,o,(t.near+t.far)/(t.near-t.far)),this.ray.source.unproject(t),this.ray.direction.set(0,0,-1),this.ray.direction.toDirection(t.modelMatrix)}},Lore.UI=function(t){this.canvas=document.createElement("canvas"),this.renderCanvasElement=document.getElementById(t),this.init(),this.resize()},Lore.UI.prototype={constructor:Lore.UI,init:function(){this.canvas.style.cssText="position: absolute; pointer-events: none;",this.renderCanvasElement.parentNode.insertBefore(this.canvas,this.renderCanvasElement)},setWidth:function(t){this.canvas.width=t},setHeight:function(t){this.canvas.height=t},setTop:function(t){this.canvas.style.top=t},setLeft:function(t){this.canvas.style.left=t},resize:function(){this.setWidth(this.renderCanvasElement.width),this.setHeight(this.renderCanvasElement.height),this.setTop(this.renderCanvasElement.offsetTop),this.setLeft(this.renderCanvasElement.offsetLeft)}};