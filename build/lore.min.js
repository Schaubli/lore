var Lore={Version:"0.0.1"};"function"==typeof define&&define.amd?define("lore",Lore):"undefined"!=typeof exports&&"undefined"!=typeof module&&(module.exports=Lore),Lore.Mouse={Left:0,Middle:1,Right:2},Lore.Keyboard={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Esc:27},Lore.Shaders={},Lore.init=function(t,e){this.opts=Lore.Utils.extend(!0,Lore.defaults,e);var o=(new Lore.UI(t),Lore.Color.fromHex(this.opts.clearColor)),n=new Lore.Renderer(t,{clearColor:o,verbose:!0,fps:document.getElementById("fps"),antialiasing:!1,center:new Lore.Vector3f(150,150,150)});new Lore.CoordinatesHelper(n,"Coordinates","default",{position:new Lore.Vector3f(0,0,0),axis:{x:{length:500,color:Lore.Color.fromHex("#097692")},y:{length:500,color:Lore.Color.fromHex("#097692")},z:{length:500,color:Lore.Color.fromHex("#097692")}},ticks:{x:{length:10,color:Lore.Color.fromHex("#097692")},y:{length:10,color:Lore.Color.fromHex("#097692")},z:{length:10,color:Lore.Color.fromHex("#097692")}},box:{enabled:!1,x:{color:Lore.Color.fromHex("#004F6E")},y:{color:Lore.Color.fromHex("#004F6E")},z:{color:Lore.Color.fromHex("#004F6E")}}});return n.render=function(t,e){for(var o=0;o<e.length;o++)e[o].draw(n)},n},Lore.defaults={clearColor:"#001821"},Lore.DrawModes={points:0,lines:1,lineStrip:2,lineLoop:3,triangles:4,traingleStrip:5,triangleFan:6},Lore.Color=function(t,e,o,n){1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=e||0,this.components[2]=o||0,this.components[3]=n||1)},Lore.Color.prototype={constructor:Lore.Color,set:function(t,e,o,n){this.components[0]=t,this.components[1]=e,this.components[2]=o,4==arguments.length&&(this.components[3]=n)}},Lore.Color.fromHex=function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,o,n){return e+e+o+o+n+n});var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t),n=parseInt(o[1],16),r=parseInt(o[2],16),s=parseInt(o[3],16);return o?new Lore.Color(n/255,r/255,s/255,1):null},Lore.Color.hueToRgb=function(t,e,o){return 0>o&&(o+=1),o>1&&(o-=1),.1667>o?t+6*(e-t)*o:.5>o?e:.6667>o?t+(e-t)*(.6667-o)*6:t},Lore.Color.hslToRgb=function(t,e,o){var n,r,s;if(0==e)n=r=s=o;else{var i=.5>o?o*(1+e):o+e-o*e,a=2*o-i;n=Lore.Color.hueToRgb(a,i,t+.3333),r=Lore.Color.hueToRgb(a,i,t),s=Lore.Color.hueToRgb(a,i,t-.3333)}return[n,r,s]},Lore.Renderer=function(t,e){this.canvas=document.getElementById(t),this.parent=this.canvas.parentElement,this.antialiasing=e.antialiasing!==!1,this.verbose=e.verbose===!0,this.fpsElement=e.fps,this.fps=0,this.clearColor=e.clearColor||new Lore.Color,this.clearDepth="clearDepth"in e?e.clearDepth:1,this.enableDepthTest="enableDepthTest"in e?e.enableDepthTest:!0,this.camera=e.camera||new Lore.OrthographicCamera(this.getWidth()/-2,this.getWidth()/2,this.getHeight()/2,this.getHeight()/-2),this.shaders=[],this.geometries=[],this.render=function(t,e){},this.effect=null,this.lastTiming=performance.now(),this.canvas.addEventListener("contextmenu",function(t){return(t.button=2)?(t.preventDefault(),!1):void 0}),this.init();var o=e.center?e.center:new Lore.Vector3f;this.controls=e.controls||new Lore.OrbitalControls(this,1200,o)},Lore.Renderer.prototype={constructor:Lore.Renderer,ready:!1,gl:null,init:function(){var t=this,e={antialias:this.antialiasing};if(this.gl=this.canvas.getContext("webgl",e)||this.canvas.getContext("experimental-webgl",e),!this.gl)return void console.error("Could not initialize the WebGL context.");var o=this.gl;if(this.verbose){var n=o.getContextAttributes().antialias,r=o.getParameter(o.SAMPLES);console.info("Antialiasing: "+n+" ("+r+"x)");var s=o.getShaderPrecisionFormat(o.FRAGMENT_SHADER,o.HIGH_FLOAT),i=0!=s.precision;console.info("High precision support: "+i)}var a="OES_standard_derivatives",c=o.getExtension(a);null===c&&console.warn("Could not load extension: "+a+".");var h="WEBGL_draw_buffers",u=o.getExtension(h);null===u&&console.warn("Could not load extension: "+h+".");var m="WEBGL_depth_texture",p=o.getExtension(m);null===p&&console.warn("Could not load extension: "+m+"."),this.setClearColor(this.clearColor),o.clearDepth(this.clearDepth),this.enableDepthTest&&(o.enable(o.DEPTH_TEST),o.depthFunc(o.LESS),console.log("enable depth test")),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.enable(o.BLEND),setTimeout(function(){t.updateViewport(0,0,t.getWidth(),t.getHeight())},200),window.addEventListener("resize",function(e){t.updateViewport(0,0,t.getWidth(),t.getHeight())}),this.effect=new Lore.Effect(this,"fxaaEffect"),this.ready=!0,this.animate()},setClearColor:function(t){this.clearColor=t;var e=this.clearColor.components;this.gl.clearColor(e[0],e[1],e[2],e[3])},getWidth:function(){return this.parent.offsetWidth},getHeight:function(){return this.parent.offsetHeight},updateViewport:function(t,e,o,n){this.canvas.width=o,this.canvas.height=n,this.gl.viewport(t,e,o,n),this.camera.left=-o/2,this.camera.right=o/2,this.camera.top=n/2,this.camera.bottom=-n/2,this.camera.updateProjectionMatrix()},animate:function(){var t=this;if(requestAnimationFrame(function(){t.animate()}),this.fpsElement){var e=performance.now(),o=e-this.lastTiming;this.lastTiming=e,this.fps=Math.round(1e3/o),this.fpsElement.innerHTML=this.fps}this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.render(this.camera,this.geometries),this.camera.isProjectionMatrixStale=!1,this.camera.isViewMatrixStale=!1},createProgram:function(t){t.init(this.gl);return this.shaders.push(t),this.shaders.length-1},createGeometry:function(t,e){var o=new Lore.Geometry(t,this.gl,this.shaders[e]);return this.geometries.push(o),o}},Lore.Shader=function(t,e,o,n){this.name=t,this.uniforms=e||{},this.vertexShader=o||[],this.fragmentShader=n||[],this.gl=null,this.program=null,this.initialized=!1,this.uniforms.modelViewMatrix=new Lore.Uniform("modelViewMatrix",(new Lore.Matrix4f).entries,"float_mat4"),this.uniforms.projectionMatrix=new Lore.Uniform("projectionMatrix",(new Lore.Matrix4f).entries,"float_mat4")},Lore.Shader.prototype={constructor:Lore.Shader,getVertexShaderCode:function(){return this.vertexShader.join("\n")},getFragmentShaderCode:function(){return this.fragmentShader.join("\n")},getVertexShader:function(t){var e=t.createShader(t.VERTEX_SHADER),o="uniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\n"+this.getVertexShaderCode();return t.shaderSource(e,o),t.compileShader(e),Lore.Shader.showCompilationInfo(t,e,this.name,"Vertex Shader"),e},getFragmentShader:function(t){var e=t.createShader(t.FRAGMENT_SHADER),o="#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#ifdef GL_ES\nprecision highp float;\n#endif\n\n"+this.getFragmentShaderCode();return t.shaderSource(e,o),t.compileShader(e),Lore.Shader.showCompilationInfo(t,e,this.name,"Fragment Shader"),e},init:function(t){this.gl=t,this.program=this.gl.createProgram();var e=this.getVertexShader(this.gl),o=this.getFragmentShader(this.gl);return e&&o?(this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,o),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)?void(this.initialized=!0):(console.error("Could not link program.\nVALIDATE_STATUS: "+this.gl.getProgramParameter(program,this.gl.VALIDATE_STATUS)+"\nERROR: "+this.gl.getError()),null)):(console.error("Failed to create the fragment or the vertex shader."),null)},updateUniforms:function(){for(var t in this.uniforms){var e=this.uniforms[t];e.stale&&Lore.Uniform.Set(this.gl,this.program,e)}},use:function(){this.gl.useProgram(this.program)}},Lore.Shader.showCompilationInfo=function(t,e,o,n){n=n||"Shader",t.getShaderParameter(e,t.COMPILE_STATUS)===!1&&console.error(n+" "+o+" did not compile."),""!==t.getShaderInfoLog(e)&&console.warn(n+" "+o+" info log: "+t.getShaderInfoLog(e))},Lore.Uniform=function(t,e,o){this.name=t,this.value=e,this.type=o,this.stale=!0},Lore.Uniform.prototype={constructor:Lore.Uniform,setValue:function(t){this.value=t,this.stale=!0}},Lore.Uniform.Set=function(t,e,o){var n=t.getUniformLocation(e,o.name);"int"===o.type?t.uniform1i(n,o.value):"int_vec2"===o.type?t.uniform2iv(n,o.value):"int_vec3"===o.type?t.uniform3iv(n,o.value):"int_vec4"===o.type?t.uniform4iv(n,o.value):"int_array"===o.type?t.uniform1iv(n,o.value):"float"===o.type?t.uniform1f(n,o.value):"float_vec2"===o.type?t.uniform2fv(n,o.value):"float_vec3"===o.type?t.uniform3fv(n,o.value):"float_vec4"===o.type?t.uniform4fv(n,o.value):"float_array"===o.type?t.uniform1fv(n,o.value):"float_mat2"===o.type?t.uniformMatrix2fv(n,!1,o.value):"float_mat3"===o.type?t.uniformMatrix3fv(n,!1,o.value):"float_mat4"===o.type&&t.uniformMatrix4fv(n,!1,o.value),o.stale=!0},Lore.Node=function(){this.type="Lore.Node",this.id=Lore.Node.createGUID(),this.isVisible=!0,this.position=new Lore.Vector3f,this.rotation=new Lore.Quaternion,this.scale=new Lore.Vector3f(1,1,1),this.up=new Lore.Vector3f(0,1,0),this.normalMatrix=new Lore.Matrix3f,this.modelMatrix=new Lore.Matrix4f,this.isStale=!1,this.children=new Array,this.parent=null},Lore.Node.prototype={constructor:Lore.Node,applyMatrix:function(t){this.modelMatrix.multiplyB(t)},getUpVector:function(){var t=new Lore.Vector3f(0,1,0);return t.applyQuaternion(this.rotation)},getForwardVector:function(){var t=new Lore.Vector3f(0,0,1);return t.applyQuaternion(this.rotation)},getRightVector:function(){var t=new Lore.Vector3f(1,0,0);return t.applyQuaternion(this.rotation)},translateOnAxis:function(t,e){var o=new Lore.Vector3f(t.components[0],t.components[1],t.components[2]);return o.applyQuaternion(this.rotation),o.multiplyScalar(e),this.position.add(o),this},translateX:function(t){return this.position.components[0]=this.position.components[0]+t,this},translateY:function(t){return this.position.components[1]=this.position.components[1]+t,this},translateZ:function(t){return this.position.components[2]=this.position.components[2]+t,this},setTranslation:function(t){return this.position=t,this},setRotation:function(t,e){return this.rotation.setFromAxisAngle(t,e),this},rotate:function(t,e){var o=new Lore.Quaternion(t,e);return this.rotation.multiplyA(o),this},rotateX:function(t){return this.rotation.rotateX(t),this},rotateY:function(t){return this.rotation.rotateY(t),this},rotateZ:function(t){return this.rotation.rotateZ(t),this},getRotationMatrix:function(){return this.rotation.toRotationMatrix()},update:function(){this.modelMatrix.compose(this.position,this.rotation,this.scale),this.isStale=!0},getModelMatrix:function(){return this.modelMatrix.entries}},Lore.Node.createGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,o="x"==t?e:3&e|8;return o.toString(16)})},Lore.Geometry=function(t,e,o){Lore.Node.call(this),this.type="Lore.Geometry",this.name=t,this.gl=e,this.shader=o,this.attributes={},this.drawMode=this.gl.POINTS},Lore.Geometry.prototype=Object.assign(Object.create(Lore.Node.prototype),{constructor:Lore.Geometry,addAttribute:function(t,e,o){return this.attributes[t]=new Lore.Attribute(e,o,t),this.attributes[t].createBuffer(this.gl,this.shader.program),this},updateAttribute:function(t,e){this.attributes[t].update(this.gl,e)},getAttribute:function(t){return this.attributes[t]},removeAttribute:function(t){return delete this.attributes[t],this},setMode:function(t){switch(t){case Lore.DrawModes.points:this.drawMode=this.gl.POINTS;break;case Lore.DrawModes.lines:this.drawMode=this.gl.LINES;break;case Lore.DrawModes.lineStrip:this.drawMode=this.gl.LINE_STRIP;break;case Lore.DrawModes.lineLoop:this.drawMode=this.gl.LINE_LOOP;break;case Lore.DrawModes.triangles:this.drawMode=this.gl.TRIANGLES;break;case Lore.DrawModes.triangleStrip:this.drawMode=this.gl.TRIANGLE_STRIP;break;case Lore.DrawModes.triangleFan:this.drawMode=this.gl.TRIANGLE_FAN}},size:function(){return Object.keys(this.attributes).length>0?this.attributes[Object.keys(this.attributes)[0]].size:0},draw:function(t){if(this.isVisible){for(var e in this.attributes)this.attributes[e].stale&&this.attributes[e].update(this.gl);if(this.shader.use(),t.camera.isProjectionMatrixStale&&this.shader.uniforms.projectionMatrix.setValue(t.camera.getProjectionMatrix()),t.camera.isViewMatrixStale){var o=Lore.Matrix4f.multiply(t.camera.viewMatrix,this.modelMatrix);this.shader.uniforms.modelViewMatrix.setValue(o.entries)}this.shader.updateUniforms();for(e in this.attributes)this.attributes[e].bind(this.gl);this.gl.drawArrays(this.drawMode,0,this.size())}}}),Lore.Attribute=function(t,e,o){this.type="Lore.Attribute",this.data=t,this.attributeLength=e||3,this.name=o,this.size=this.data.length/this.attributeLength,this.buffer=null,this.attributeLocation,this.bufferType=null,this.drawMode=null,this.stale=!1},Lore.Attribute.prototype={constructor:Lore.Attribute,setFromVector:function(t,e){this.data.set(e.components,t*this.attributeLength,e.components.length)},setFromVectorArray:function(t){if(this.attributeLength!==t[0].components.length)throw"The attribute has a length of "+this.attributeLength+". But the vectors have "+t[0].components.length+" components.";for(var e=0;e<t.length;e++)this.data.set(t[e].components,e*this.attributeLength,t[e].components.length)},getX:function(t){return this.data[t*this.attributeLength]},setX:function(t,e){this.data[t*this.attributeLength]},getY:function(t){return this.data[t*this.attributeLength+1]},setY:function(t,e){this.data[t*this.attributeLength+1]},getZ:function(t){return this.data[t*this.attributeLength+2]},setZ:function(t,e){this.data[t*this.attributeLength+2]},getW:function(t){return this.data[t*this.attributeLength+3]},setW:function(t,e){this.data[t*this.attributeLength+3]},getGlType:function(t){return t.FLOAT},update:function(t){t.bindBuffer(this.bufferType,this.buffer),t.bufferData(this.bufferType,this.data,this.drawMode),this.stale=!1},createBuffer:function(t,e,o,n){this.buffer=t.createBuffer(),this.bufferType=o||t.ARRAY_BUFFER,this.drawMode=n||t.STATIC_DRAW,t.bindBuffer(this.bufferType,this.buffer),t.bufferData(this.bufferType,this.data,this.drawMode),this.buffer.itemSize=this.attributeLength,this.buffer.numItems=this.size,this.attributeLocation=t.getAttribLocation(e,this.name),t.bindBuffer(this.bufferType,null)},bind:function(t){t.bindBuffer(this.bufferType,this.buffer),this.attributeLocation>=0&&(t.vertexAttribPointer(this.attributeLocation,this.attributeLength,this.getGlType(t),t.FALSE,0,0),t.enableVertexAttribArray(this.attributeLocation))}},Lore.Effect=function(t,e){this.renderer=t,this.gl=this.renderer.gl,this.framebuffer=this.initFramebuffer(),this.texture=this.initTexture(),this.renderbuffer=this.initRenderbuffer(),this.shader=this.renderer.shaders[this.renderer.createProgram(Lore.Shaders[e])],this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},Lore.Effect.prototype={constructor:Lore.Effect,initBuffer:function(){var t=this.gl,e=t.getAttribLocation(this.shader.program,"v_coord"),o=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,-1,-1,1,-1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,2,t.FLOAT,!1,0,0),o},initTexture:function(){var t=this.gl,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.renderer.getWidth(),this.renderer.getHeight(),0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),e},initFramebuffer:function(){var t=this.gl,e=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,e),e},initRenderbuffer:function(){var t=this.gl,e=t.createRenderbuffer();return t.bindRenderbuffer(t.RENDERBUFFER,e),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.renderer.getWidth(),this.renderer.getHeight()),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e),e},bind:function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},unbind:function(){var t=this.gl;t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),this.initBuffer(),this.shader.use(),t.drawArrays(t.TRIANGLES,0,6)}},Lore.ControlsBase=function(t){this.canvas=t.canvas,this.eventListeners={},this.mouse={previousPosition:{x:null,y:null},delta:{x:0,y:0},position:{x:0,y:0},state:{left:!1,middle:!1,right:!1},normalizedPosition:{x:0,y:0},touches:0},this.keyboard={alt:!1,ctrl:!1,shift:!1};var e=this;this.canvas.addEventListener("mousemove",function(t){(null!==e.mouse.previousPosition.x&&e.mouse.state.left||e.mouse.state.middle||e.mouse.state.right)&&(e.mouse.delta.x=t.pageX-e.mouse.previousPosition.x,e.mouse.delta.y=t.pageY-e.mouse.previousPosition.y,e.mouse.position.x+=.01*e.mouse.delta.x,e.mouse.position.y+=.01*e.mouse.delta.y,e.raiseEvent("mousemove",{e:e.mouse.delta}),e.mouse.state.left?e.raiseEvent("mousedrag",{e:e.mouse.delta,source:"left"}):e.mouse.state.middle?e.raiseEvent("mousedrag",{e:e.mouse.delta,source:"middle"}):e.mouse.state.right&&e.raiseEvent("mousedrag",{e:e.mouse.delta,source:"right"})),e.mouse.previousPosition.x=t.pageX,e.mouse.previousPosition.y=t.pageY}),this.canvas.addEventListener("touchstart",function(t){e.mouse.touches++;var o=t.touches[0];t.preventDefault(),e.mouse.touched=!0;var n=e.canvas.getBoundingClientRect();e.mouse.normalizedPosition.x=(o.clientX-n.left)/e.canvas.width*2-1,e.mouse.normalizedPosition.y=2*-((o.clientY-n.top)/e.canvas.height)+1,e.raiseEvent("mousedown",{e:e,source:"touch"})}),this.canvas.addEventListener("touchend",function(t){e.mouse.touches--,t.preventDefault(),e.mouse.touched=!1,e.mouse.previousPosition.x=null,e.mouse.previousPosition.y=null,e.raiseEvent("mouseup",{e:e,source:"touch"})}),this.canvas.addEventListener("touchmove",function(t){var o=t.touches[0],n="left";2==e.mouse.touches&&(n="right"),t.preventDefault(),null!==e.mouse.previousPosition.x&&e.mouse.touched&&(e.mouse.delta.x=o.pageX-e.mouse.previousPosition.x,e.mouse.delta.y=o.pageY-e.mouse.previousPosition.y,e.mouse.position.x+=.01*e.mouse.delta.x,e.mouse.position.y+=.01*e.mouse.delta.y,e.raiseEvent("mousemove",{e:e.mouse.delta}),e.raiseEvent("mousedrag",{e:e.mouse.delta,source:n})),e.mouse.previousPosition.x=o.pageX,e.mouse.previousPosition.y=o.pageY});var o="mousewheel";navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(o="DOMMouseScroll"),this.canvas.addEventListener(o,function(t){e.raiseEvent("mousewheel",{e:t.wheelDelta})}),this.canvas.addEventListener("keydown",function(t){16==t.which?e.keyboard.shift=!0:17==t.which?e.keyboard.ctrl=!0:18==t.which&&(e.keyboard.alt=!0),e.raiseEvent("keydown",{e:t.which})}),this.canvas.addEventListener("keyup",function(t){16==t.which?e.keyboard.shift=!1:17==t.which?e.keyboard.ctrl=!1:18==t.which&&(e.keyboard.alt=!1),e.raiseEvent("keyup",{e:t.which})}),this.canvas.addEventListener("mousedown",function(t){var o=t.button,n="left";0==o?e.mouse.state.left=!0:1==o?(e.mouse.state.middle=!0,n="middle"):2==o&&(e.mouse.state.right=!0,n="right");var r=e.canvas.getBoundingClientRect();e.mouse.normalizedPosition.x=(t.clientX-r.left)/e.canvas.width*2-1,e.mouse.normalizedPosition.y=2*-((t.clientY-r.top)/e.canvas.height)+1,e.raiseEvent("mousedown",{e:e,source:n})}),this.canvas.addEventListener("mouseup",function(t){var o=t.button,n="left";0==o?e.mouse.state.left=!1:1==o?(e.mouse.state.middle=!1,n="middle"):2==o&&(e.mouse.state.right=!1,n="right"),e.mouse.previousPosition.x=null,e.mouse.previousPosition.y=null,e.raiseEvent("mouseup",{e:e,source:n})})},Lore.ControlsBase.prototype={constructor:Lore.ControlsBase,addEventListener:function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},raiseEvent:function(t,e){if(this.eventListeners[t])for(var o=0;o<this.eventListeners[t].length;o++)this.eventListeners[t][o](e)}},Lore.OrbitalControls=function(t,e,o){Lore.ControlsBase.call(this,t),this.up=Lore.Vector3f.up(),this.radius=e,this.camera=t.camera,this.canvas=t.canvas,this.dPhi=0,this.dTheta=0,this.dPan=new Lore.Vector3f,this.spherical=new Lore.SphericalCoords,this.lookAt=o||new Lore.Vector3f,this.scale=.95,this.zoomed=!1,this.camera.position=new Lore.Vector3f(0,0,e),this.camera.updateProjectionMatrix(),this.camera.updateViewMatrix();var n=this;this.addEventListener("mousedrag",function(t){n.update(t.e,t.source)}),this.addEventListener("mousewheel",function(t){n.update({x:0,y:-t.e},"wheel")}),this.update({x:0,y:0},"left")},Lore.OrbitalControls.prototype=Object.assign(Object.create(Lore.ControlsBase.prototype),{constructor:Lore.OrbitalControls,update:function(t,e){if("left"==e)this.dTheta=-2*Math.PI*t.x/(this.canvas.clientWidth*this.camera.zoom),this.dPhi=-2*Math.PI*t.y/(this.canvas.clientHeight*this.camera.zoom);else if("right"==e){var o=t.x*(this.camera.right-this.camera.left)/this.camera.zoom/this.canvas.clientWidth,n=t.y*(this.camera.top-this.camera.bottom)/this.camera.zoom/this.canvas.clientHeight,r=this.camera.getUpVector().components,s=this.camera.getRightVector().components;this.dPan.components[0]=s[0]*-o+r[0]*n,this.dPan.components[1]=s[1]*-o+r[1]*n,this.dPan.components[2]=s[2]*-o+r[2]*n}else"middle"!=e&&"wheel"!=e||(t.y>0?(this.camera.zoom=Math.max(0,this.camera.zoom*this.scale),this.camera.updateProjectionMatrix(),this.zoomed=!0,this.raiseEvent("zoomchanged",this.camera.zoom)):t.y<0&&(this.camera.zoom=Math.max(0,this.camera.zoom/this.scale),this.camera.updateProjectionMatrix(),this.zoomed=!0,this.raiseEvent("zoomchanged",this.camera.zoom)));var i=this.camera.position.clone().subtract(this.lookAt);this.spherical.setFromVector(i),this.spherical.components[1]+=this.dPhi,this.spherical.components[2]+=this.dTheta,this.spherical.limit(0,.5*Math.PI,-(1/0),1/0),this.spherical.secure(),this.lookAt.add(this.dPan),i.setFromSphericalCoords(this.spherical),this.camera.position.copyFrom(this.lookAt).add(i),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this.dPhi=0,this.dTheta=0,this.dPan.set(0,0,0),this.zoomed&&(this.zoomed=!1)}}),Lore.CameraBase=function(){Lore.Node.call(this),this.type="Lore.CameraBase",this.renderer=null,this.isProjectionMatrixStale=!1,this.isViewMatrixStale=!1,this.projectionMatrix=new Lore.ProjectionMatrix,this.viewMatrix=new Lore.Matrix4f},Lore.CameraBase.prototype=Object.assign(Object.create(Lore.Node.prototype),{constructor:Lore.CameraBase,init:function(t,e){this.gl=t,this.program=e},setLookAt:function(t){this.rotation.lookAt(this.position,t,Lore.Vector3f.up())},updateProjectionMatrix:function(){},updateViewMatrix:function(){this.update();var t=this.modelMatrix.clone();t.invert(),this.viewMatrix=t,this.isViewMatrixStale=!0},getProjectionMatrix:function(){return this.projectionMatrix.entries},getViewMatrix:function(){return this.viewMatrix.entries}}),Lore.OrthographicCamera=function(t,e,o,n,r,s){Lore.CameraBase.call(this),this.type="Lore.OrthographicCamera",this.zoom=1,this.left=t,this.right=e,this.top=o,this.bottom=n,this.near=r||.1,this.far=s||2500,this.updateProjectionMatrix()},Lore.OrthographicCamera.prototype=Object.assign(Object.create(Lore.CameraBase.prototype),{constructor:Lore.OrthographicCamera,updateProjectionMatrix:function(){var t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),o=(this.right+this.left)/2,n=(this.top+this.bottom)/2,r=o-t,s=o+t,i=n+e,a=n-e;this.projectionMatrix.setOrthographic(r,s,i,a,this.near,this.far),this.isProjectionMatrixStale=!0}}),Lore.Array2=function(t){this.arr=t},Lore.Array2.prototype={constructor:Lore.Array2,multiply:function(t,e,o){t<<=1,this.arr[t]*=e,this.arr[t+1]*=o},multiplyScalar:function(t,e){t<<=1,this.arr[t]*=e,this.arr[t+1]*=e},divide:function(t,e,o){t<<=1,this.arr[t]/=e,this.arr[t+1]/=o},divideScalar:function(t,e){t<<=1,this.arr[t]/=e,this.arr[t+1]/=e},add:function(t,e,o){t<<=1,this.arr[t]+=e,this.arr[t+1]+=o},subtract:function(t,e,o){t<<=1,this.arr[t]-=e,this.arr[t+1]-=o}},Lore.Array3=function(t){this.arr=t},Lore.Array3.prototype={constructor:Lore.Array3,multiply:function(t,e,o,n){t*=3,this.arr[t]*=e,this.arr[t+1]*=o,this.arr[t+2]*=n},multiplyScalar:function(t,e){t*=3,this.arr[t]*=e,this.arr[t+1]*=e,this.arr[t+2]*=e},divide:function(t,e,o,n){t*=3,this.arr[t]/=e,this.arr[t+1]/=o,this.arr[t+2]/=n},divideScalar:function(t,e){t*=3,this.arr[t]/=e,this.arr[t+1]/=e,this.arr[t+2]/=e},add:function(t,e,o,n){t*=3,this.arr[t]+=e,this.arr[t+1]+=o,this.arr[t+2]+=n},subtract:function(t,e,o,n){t*=3,this.arr[t]-=e,this.arr[t+1]-=o,this.arr[t+2]-=n}},Lore.Vector2f=function(t,e){this.components=new Float32Array(2),this.components[0]=t||0,this.components[1]=e||0},Lore.Vector2f.prototype={constructor:Lore.Vector2f,set:function(t,e){return this.components[0]=t,this.components[1]=e,this},getX:function(){return this.components[0]},getY:function(){return this.components[1]},setX:function(t){this.components[0]=t},setY:function(t){this.components[1]=t},lengthSq:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]},length:function(){return Math.sqrt(this.lengthSq())},multiply:function(t){return this.components[0]*=t.components[0],this.components[1]*=t.components[1],this},multiplyScalar:function(t){return this.components[0]*=t,this.components[1]*=t,this},divide:function(t){return this.components[0]/=t.components[0],this.components[1]/=t.components[1],this},divideScalar:function(t){return this.components[0]/=t,this.components[1]/=t,this},add:function(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this},subtract:function(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this},clone:function(){return new Lore.Vector2f(this.components[0],this.components[1])},equals:function(t){return this.components[0]===t.components[0]&&this.components[1]===t.components[1]}},Lore.Vector2f.multiply=function(t,e){return new Lore.Vector2f(t.components[0]*e.components[0],t.components[1]*e.components[1])},Lore.Vector2f.multiplyScalar=function(t,e){return new Lore.Vector2f(t.components[0]*e,t.components[1]*e)},Lore.Vector2f.divide=function(t,e){return new Lore.Vector2f(t.components[0]/e.components[0],t.components[1]/e.components[1])},Lore.Vector2f.divideScalar=function(t,e){return new Lore.Vector2f(t.components[0]/e,t.components[1]/e)},Lore.Vector2f.add=function(t,e){return new Lore.Vector2f(t.components[0]+e.components[0],t.components[1]+e.components[1])},Lore.Vector2f.subtract=function(t,e){return new Lore.Vector2f(t.components[0]-e.components[0],t.components[1]-e.components[1])},Lore.Vector3f=function(t,e,o){1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(3),this.components[0]=t||0,this.components[1]=e||0,this.components[2]=o||0)},Lore.Vector3f.prototype={constructor:Lore.Vector3f,set:function(t,e,o){return this.components[0]=t,this.components[1]=e,this.components[2]=o,this},getX:function(){return this.components[0]},getY:function(){return this.components[1]},getZ:function(){return this.components[2]},setX:function(t){return this.components[0]=t,this},setY:function(t){return this.components[1]=t,this},setZ:function(t){return this.components[2]=t,this},setFromSphericalCoords:function(t){var e=t.components[0],o=t.components[1],n=t.components[2],r=Math.sin(o)*e;return this.components[0]=Math.sin(n)*r,this.components[1]=Math.cos(o)*e,this.components[2]=Math.cos(n)*r,this},copyFrom:function(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this},setLength:function(t){return this.multiplyScalar(t/this.length())},lengthSq:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},multiply:function(t){return this.components[0]*=t.components[0],this.components[1]*=t.components[1],this.components[2]*=t.components[2],this},multiplyScalar:function(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this},divide:function(t){return this.components[0]/=t.components[0],this.components[1]/=t.components[1],this.components[2]/=t.components[2],this},divideScalar:function(t){return this.components[0]/=t,this.components[1]/=t,this.components[2]/=t,this},add:function(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this},subtract:function(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this},dot:function(t){return this.components[0]*t.components[0]+this.components[1]*t.components[1]+this.components[2]*t.components[2]},cross:function(t){return new Lore.Vector3f(this.components[1]*t.components[2]-this.components[2]*t.components[1],this.components[2]*t.components[0]-this.components[0]*t.components[2],this.components[0]*t.components[1]-this.components[1]*t.components[0])},project:function(t){return this.applyProjection(Lore.Matrix4f.multiply(t.projectionMatrix,Lore.Matrix4f.invert(t.modelMatrix)))},unproject:function(t){return this.applyProjection(Lore.Matrix4f.multiply(t.modelMatrix,Lore.Matrix4f.invert(t.projectionMatrix)))},applyProjection:function(t){var e=this.components[0],o=this.components[1],n=this.components[2],r=t.entries,s=1/(r[3]*e+r[7]*o+r[11]*n+r[15]);return this.components[0]=(r[0]*e+r[4]*o+r[8]*n+r[12])*s,this.components[1]=(r[1]*e+r[5]*o+r[9]*n+r[13])*s,this.components[2]=(r[2]*e+r[6]*o+r[10]*n+r[14])*s,this},toDirection:function(t){var e=this.components[0],o=this.components[1],n=this.components[2],r=t.entries;this.components[0]=r[0]*e+r[4]*o+r[8]*n,this.components[1]=r[1]*e+r[5]*o+r[9]*n,this.components[2]=r[2]*e+r[6]*o+r[10]*n,this.normalize()},applyQuaternion:function(t){var e=this.components[0],o=this.components[1],n=this.components[2],r=t.components[0],s=t.components[1],i=t.components[2],a=t.components[3],c=a*e+s*n-i*o,h=a*o+i*e-r*n,u=a*n+r*o-s*e,m=-r*e-s*o-i*n;return this.components[0]=c*a+m*-r+h*-i-u*-s,this.components[1]=h*a+m*-s+u*-r-c*-i,this.components[2]=u*a+m*-i+c*-s-h*-r,this},distanceToSq:function(t){var e=this.components[0]-t.components[0],o=this.components[1]-t.components[1],n=this.components[2]-t.components[2];return e*e+o*o+n*n},distanceTo:function(t){return Math.sqrt(this.distanceToSq(t))},clone:function(){return new Lore.Vector3f(this.components[0],this.components[1],this.components[2])},equals:function(t){return this.components[0]===t.components[0]&&this.components[1]===t.components[1]&&this.components[2]===t.components[2]},toString:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}},Lore.Vector3f.normalize=function(t){return Lore.Vector3f.divideScalar(t,t.length())},Lore.Vector3f.multiply=function(t,e){return new Lore.Vector3f(t.components[0]*e.components[0],t.components[1]*e.components[1],t.components[2]*e.components[2])},Lore.Vector3f.multiplyScalar=function(t,e){return new Lore.Vector3f(t.components[0]*e,t.components[1]*e,t.components[2]*e)},Lore.Vector3f.divide=function(t,e){return new Lore.Vector3f(t.components[0]/e.components[0],t.components[1]/e.components[1],t.components[2]/e.components[2])},Lore.Vector3f.divideScalar=function(t,e){return new Lore.Vector3f(t.components[0]/e,t.components[1]/e,t.components[2]/e)},Lore.Vector3f.add=function(t,e){return new Lore.Vector3f(t.components[0]+e.components[0],t.components[1]+e.components[1],t.components[2]+e.components[2])},Lore.Vector3f.subtract=function(t,e){return new Lore.Vector3f(t.components[0]-e.components[0],t.components[1]-e.components[1],t.components[2]-e.components[2])},Lore.Vector3f.cross=function(t,e){return new Lore.Vector3f(t.components[1]*e.components[2]-t.components[2]*e.components[1],t.components[2]*e.components[0]-t.components[0]*e.components[2],t.components[0]*e.components[1]-t.components[1]*e.components[0]);
},Lore.Vector3f.dot=function(t,e){return t.components[0]*e.components[0]+t.components[1]*e.components[1]+t.components[2]*e.components[2]},Lore.Vector3f.forward=function(){return new Lore.Vector3f(0,0,1)},Lore.Vector3f.up=function(){return new Lore.Vector3f(0,1,0)},Lore.Vector3f.right=function(){return new Lore.Vector3f(1,0,0)},Lore.Matrix3f=function(t){this.entries=t||new Float32Array([1,0,0,0,1,0,0,0,1])},Lore.Matrix3f.prototype={constructor:Lore.Matrix3f,clone:function(){return new Lore.Matrix3f(new Float32Array(this.entries))},equals:function(t){for(var e=0;e<this.entries.length;e++)if(this.entries[e]!==t.entries[e])return!1;return!0}},Lore.Matrix4f=function(t){this.entries=t||new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},Lore.Matrix4f.prototype={constructor:Lore.Matrix4f,set:function(t,e,o,n,r,s,i,a,c,h,u,m,p,l,f,d){this.entries.set([t,e,o,n,r,s,i,a,c,h,u,m,p,l,f,d])},multiplyA:function(t){var e=this.entries[0],o=this.entries[4],n=this.entries[8],r=this.entries[12],s=this.entries[1],i=this.entries[5],a=this.entries[9],c=this.entries[13],h=this.entries[2],u=this.entries[6],m=this.entries[10],p=this.entries[14],l=this.entries[3],f=this.entries[7],d=this.entries[11],g=this.entries[15],v=t.entries[0],L=t.entries[4],y=t.entries[8],x=t.entries[12],b=t.entries[1],w=t.entries[5],A=t.entries[9],M=t.entries[13],S=t.entries[2],E=t.entries[6],C=t.entries[10],F=t.entries[14],P=t.entries[3],T=t.entries[7],V=t.entries[11],R=t.entries[15];return this.entries[0]=e*v+o*b+n*S+r*P,this.entries[1]=s*v+i*b+a*S+c*P,this.entries[2]=l*v+f*b+d*S+g*P,this.entries[3]=e*L+o*w+n*E+r*T,this.entries[4]=h*v+u*b+m*S+p*P,this.entries[5]=s*L+i*w+a*E+c*T,this.entries[6]=h*L+u*w+m*E+p*T,this.entries[7]=l*L+f*w+d*E+g*T,this.entries[8]=e*y+o*A+n*C+r*V,this.entries[9]=s*y+i*A+a*C+c*V,this.entries[10]=h*y+u*A+m*C+p*V,this.entries[11]=l*y+f*A+d*C+g*V,this.entries[12]=e*x+o*M+n*F+r*R,this.entries[13]=s*x+i*M+a*F+c*R,this.entries[14]=h*x+u*M+m*F+p*R,this.entries[15]=l*x+f*M+d*F+g*R,this},multiplyB:function(t){var e=t.entries[0],o=t.entries[4],n=t.entries[8],r=t.entries[12],s=t.entries[1],i=t.entries[5],a=t.entries[9],c=t.entries[13],h=t.entries[2],u=t.entries[6],m=t.entries[10],p=t.entries[14],l=t.entries[3],f=t.entries[7],d=t.entries[11],g=t.entries[15],v=this.entries[0],L=this.entries[4],y=this.entries[8],x=this.entries[12],b=this.entries[1],w=this.entries[5],A=this.entries[9],M=this.entries[13],S=this.entries[2],E=this.entries[6],C=this.entries[10],F=this.entries[14],P=this.entries[3],T=this.entries[7],V=this.entries[11],R=this.entries[15];return this.entries[0]=e*v+o*b+n*S+r*P,this.entries[1]=s*v+i*b+a*S+c*P,this.entries[2]=l*v+f*b+d*S+g*P,this.entries[3]=e*L+o*w+n*E+r*T,this.entries[4]=h*v+u*b+m*S+p*P,this.entries[5]=s*L+i*w+a*E+c*T,this.entries[6]=h*L+u*w+m*E+p*T,this.entries[7]=l*L+f*w+d*E+g*T,this.entries[8]=e*y+o*A+n*C+r*V,this.entries[9]=s*y+i*A+a*C+c*V,this.entries[10]=h*y+u*A+m*C+p*V,this.entries[11]=l*y+f*A+d*C+g*V,this.entries[12]=e*x+o*M+n*F+r*R,this.entries[13]=s*x+i*M+a*F+c*R,this.entries[14]=h*x+u*M+m*F+p*R,this.entries[15]=l*x+f*M+d*F+g*R,this},scale:function(t){var e=t.components[0],o=t.components[1],n=t.components[2];return this.entries[0]*=e,this.entries[1]*=e,this.entries[2]*=e,this.entries[3]*=e,this.entries[4]*=o,this.entries[5]*=o,this.entries[6]*=o,this.entries[7]*=o,this.entries[8]*=n,this.entries[9]*=n,this.entries[10]*=n,this.entries[11]*=n,this},setPosition:function(t){return this.entries[12]=t.components[0],this.entries[13]=t.components[1],this.entries[14]=t.components[2],this},setRotation:function(t){var e=t.components[0],o=t.components[1],n=t.components[2],r=t.components[3],s=e+e,i=o+o,a=n+n,c=e*s,h=e*i,u=e*a,m=o*i,p=o*a,l=n*a,f=r*s,d=r*i,g=r*a;return this.entries[0]=1-(m+l),this.entries[1]=h+g,this.entries[2]=u-d,this.entries[4]=h-g,this.entries[5]=1-(c+l),this.entries[6]=p+f,this.entries[8]=u+d,this.entries[9]=p-f,this.entries[10]=1-(c+m),this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[12]=0,this.entries[13]=0,this.entries[14]=0,this.entries[15]=1,this},determinant:function(){var t=a.entries[0],e=a.entries[4],o=a.entries[8],n=a.entries[12],r=a.entries[1],s=a.entries[5],i=a.entries[9],c=a.entries[13],h=a.entries[2],u=a.entries[6],m=a.entries[10],p=a.entries[14],l=a.entries[3],f=a.entries[7],d=a.entries[11],g=a.entries[15];return l*(n*i*u-o*c*u-n*s*m+e*c*m+o*s*p-e*i*p)+f*(t*i*p-t*c*m+n*r*m-o*r*p+o*c*h-n*i*h)+d*(t*c*u-t*s*p-n*r*u+e*r*p+n*s*h-e*c*h)+g*(-o*s*h-t*i*u+t*s*m+o*r*u-e*r*m+e*i*h)},decompose:function(t,e,o){var n=(new Lore.Vector3f,new Lore.Matrix4f);position.set(this.entries[12],this.entries[13],this.entries[14]);var r=Math.sqrt(this.entries[0]*this.entries[0]+this.entries[1]*this.entries[1]+this.entries[2]*this.entries[2]),s=Math.sqrt(this.entries[4]*this.entries[4]+this.entries[5]*this.entries[5]+this.entries[6]*this.entries[6]),i=Math.sqrt(this.entries[8]*this.entries[8]+this.entries[9]*this.entries[9]+this.entries[10]*this.entries[10]),a=this.determinant();0>a&&(r=-r),o.set(r,s,i);var c=1/r,h=1/s,u=1/i;return n.entries.set(this.entries),n.entries[0]*=c,n.entries[1]*=c,n.entries[2]*=c,n.entries[4]*=h,n.entries[5]*=h,n.entries[6]*=h,n.entries[8]*=u,n.entries[9]*=u,n.entries[10]*=u,e.setFromMatrix(n),this},compose:function(t,e,o){return this.setRotation(e),this.scale(o),this.setPosition(t),this},invert:function(){var t=new Lore.Matrix4f,e=this.entries;t.entries[0]=e[5]*e[10]*e[15]-e[5]*e[11]*e[14]-e[9]*e[6]*e[15]+e[9]*e[7]*e[14]+e[13]*e[6]*e[11]-e[13]*e[7]*e[10],t.entries[4]=-e[4]*e[10]*e[15]+e[4]*e[11]*e[14]+e[8]*e[6]*e[15]-e[8]*e[7]*e[14]-e[12]*e[6]*e[11]+e[12]*e[7]*e[10],t.entries[8]=e[4]*e[9]*e[15]-e[4]*e[11]*e[13]-e[8]*e[5]*e[15]+e[8]*e[7]*e[13]+e[12]*e[5]*e[11]-e[12]*e[7]*e[9],t.entries[12]=-e[4]*e[9]*e[14]+e[4]*e[10]*e[13]+e[8]*e[5]*e[14]-e[8]*e[6]*e[13]-e[12]*e[5]*e[10]+e[12]*e[6]*e[9],t.entries[1]=-e[1]*e[10]*e[15]+e[1]*e[11]*e[14]+e[9]*e[2]*e[15]-e[9]*e[3]*e[14]-e[13]*e[2]*e[11]+e[13]*e[3]*e[10],t.entries[5]=e[0]*e[10]*e[15]-e[0]*e[11]*e[14]-e[8]*e[2]*e[15]+e[8]*e[3]*e[14]+e[12]*e[2]*e[11]-e[12]*e[3]*e[10],t.entries[9]=-e[0]*e[9]*e[15]+e[0]*e[11]*e[13]+e[8]*e[1]*e[15]-e[8]*e[3]*e[13]-e[12]*e[1]*e[11]+e[12]*e[3]*e[9],t.entries[13]=e[0]*e[9]*e[14]-e[0]*e[10]*e[13]-e[8]*e[1]*e[14]+e[8]*e[2]*e[13]+e[12]*e[1]*e[10]-e[12]*e[2]*e[9],t.entries[2]=e[1]*e[6]*e[15]-e[1]*e[7]*e[14]-e[5]*e[2]*e[15]+e[5]*e[3]*e[14]+e[13]*e[2]*e[7]-e[13]*e[3]*e[6],t.entries[6]=-e[0]*e[6]*e[15]+e[0]*e[7]*e[14]+e[4]*e[2]*e[15]-e[4]*e[3]*e[14]-e[12]*e[2]*e[7]+e[12]*e[3]*e[6],t.entries[10]=e[0]*e[5]*e[15]-e[0]*e[7]*e[13]-e[4]*e[1]*e[15]+e[4]*e[3]*e[13]+e[12]*e[1]*e[7]-e[12]*e[3]*e[5],t.entries[14]=-e[0]*e[5]*e[14]+e[0]*e[6]*e[13]+e[4]*e[1]*e[14]-e[4]*e[2]*e[13]-e[12]*e[1]*e[6]+e[12]*e[2]*e[5],t.entries[3]=-e[1]*e[6]*e[11]+e[1]*e[7]*e[10]+e[5]*e[2]*e[11]-e[5]*e[3]*e[10]-e[9]*e[2]*e[7]+e[9]*e[3]*e[6],t.entries[7]=e[0]*e[6]*e[11]-e[0]*e[7]*e[10]-e[4]*e[2]*e[11]+e[4]*e[3]*e[10]+e[8]*e[2]*e[7]-e[8]*e[3]*e[6],t.entries[11]=-e[0]*e[5]*e[11]+e[0]*e[7]*e[9]+e[4]*e[1]*e[11]-e[4]*e[3]*e[9]-e[8]*e[1]*e[7]+e[8]*e[3]*e[5],t.entries[15]=e[0]*e[5]*e[10]-e[0]*e[6]*e[9]-e[4]*e[1]*e[10]+e[4]*e[2]*e[9]+e[8]*e[1]*e[6]-e[8]*e[2]*e[5];var o=e[0]*t.entries[0]+e[1]*t.entries[4]+e[2]*t.entries[8]+e[3]*t.entries[12];if(0==o)throw"Determinant is zero.";o=1/o;for(var n=0;16>n;n++)this.entries[n]=t.entries[n]*o;return this},clone:function(){return new Lore.Matrix4f(new Float32Array(this.entries))},equals:function(t){for(var e=0;e<this.entries.length;e++)if(this.entries[e]!==t.entries[e])return!1;return!0},toString:function(){console.log(this.entries[0]+", "+this.entries[4]+", "+this.entries[8]+", "+this.entries[12]),console.log(this.entries[1]+", "+this.entries[5]+", "+this.entries[9]+", "+this.entries[13]),console.log(this.entries[2]+", "+this.entries[6]+", "+this.entries[10]+", "+this.entries[14]),console.log(this.entries[3]+", "+this.entries[7]+", "+this.entries[11]+", "+this.entries[15])}},Lore.Matrix4f.multiply=function(t,e){var o=t.entries[0],n=t.entries[4],r=t.entries[8],s=t.entries[12],i=t.entries[1],a=t.entries[5],c=t.entries[9],h=t.entries[13],u=t.entries[2],m=t.entries[6],p=t.entries[10],l=t.entries[14],f=t.entries[3],d=t.entries[7],g=t.entries[11],v=t.entries[15],L=e.entries[0],y=e.entries[4],x=e.entries[8],b=e.entries[12],w=e.entries[1],A=e.entries[5],M=e.entries[9],S=e.entries[13],E=e.entries[2],C=e.entries[6],F=e.entries[10],P=e.entries[14],T=e.entries[3],V=e.entries[7],R=e.entries[11],_=e.entries[15];return new Lore.Matrix4f(new Float32Array([o*L+n*w+r*E+s*T,i*L+a*w+c*E+h*T,u*L+m*w+p*E+l*T,f*L+d*w+g*E+v*T,o*y+n*A+r*C+s*V,i*y+a*A+c*C+h*V,u*y+m*A+p*C+l*V,f*y+d*A+g*C+v*V,o*x+n*M+r*F+s*R,i*x+a*M+c*F+h*R,u*x+m*M+p*F+l*R,f*x+d*M+g*F+v*R,o*b+n*S+r*P+s*_,i*b+a*S+c*P+h*_,u*b+m*S+p*P+l*_,f*b+d*S+g*P+v*_]))},Lore.Matrix4f.fromQuaternion=function(t){var e=t.components[0],o=t.components[1],n=t.components[2],r=t.components[3],s=e+e,i=o+o,a=n+n,c=e*s,h=e*i,u=e*a,m=o*i,p=o*a,l=n*a,f=r*s,d=r*i,g=r*a;return new Lore.Matrix4f(new Float32Array([1-(m+l),h+g,u-d,0,h-g,1-(c+l),p+f,0,u+d,p-f,1-(c+m),0,0,0,0,1]))},Lore.Matrix4f.lookAt=function(t,e,o){var n=Lore.Vector3f.subtract(t,e).normalize();0===n.lengthSq()&&(n.components[2]=1);var r=Lore.Vector3f.cross(o,n).normalize();0===r.lengthSq()&&(n.components[2]+=1e-4,r=Lore.Vector3f.cross(o,n).normalize());var s=Lore.Vector3f.cross(n,r);return new Lore.Matrix4f(new Float32Array([r.components[0],r.components[1],r.components[2],0,s.components[0],s.components[1],s.components[2],0,n.components[0],n.components[1],n.components[2],0,0,0,0,1]))},Lore.Matrix4f.compose=function(t,e,o){var n=new Lore.Matrix4f;return n.setRotation(e),n.scale(o),n.setPosition(t),n},Lore.Matrix4f.invert=function(t){var e=new Lore.Matrix4f,o=t.entries;e.entries[0]=o[5]*o[10]*o[15]-o[5]*o[11]*o[14]-o[9]*o[6]*o[15]+o[9]*o[7]*o[14]+o[13]*o[6]*o[11]-o[13]*o[7]*o[10],e.entries[4]=-o[4]*o[10]*o[15]+o[4]*o[11]*o[14]+o[8]*o[6]*o[15]-o[8]*o[7]*o[14]-o[12]*o[6]*o[11]+o[12]*o[7]*o[10],e.entries[8]=o[4]*o[9]*o[15]-o[4]*o[11]*o[13]-o[8]*o[5]*o[15]+o[8]*o[7]*o[13]+o[12]*o[5]*o[11]-o[12]*o[7]*o[9],e.entries[12]=-o[4]*o[9]*o[14]+o[4]*o[10]*o[13]+o[8]*o[5]*o[14]-o[8]*o[6]*o[13]-o[12]*o[5]*o[10]+o[12]*o[6]*o[9],e.entries[1]=-o[1]*o[10]*o[15]+o[1]*o[11]*o[14]+o[9]*o[2]*o[15]-o[9]*o[3]*o[14]-o[13]*o[2]*o[11]+o[13]*o[3]*o[10],e.entries[5]=o[0]*o[10]*o[15]-o[0]*o[11]*o[14]-o[8]*o[2]*o[15]+o[8]*o[3]*o[14]+o[12]*o[2]*o[11]-o[12]*o[3]*o[10],e.entries[9]=-o[0]*o[9]*o[15]+o[0]*o[11]*o[13]+o[8]*o[1]*o[15]-o[8]*o[3]*o[13]-o[12]*o[1]*o[11]+o[12]*o[3]*o[9],e.entries[13]=o[0]*o[9]*o[14]-o[0]*o[10]*o[13]-o[8]*o[1]*o[14]+o[8]*o[2]*o[13]+o[12]*o[1]*o[10]-o[12]*o[2]*o[9],e.entries[2]=o[1]*o[6]*o[15]-o[1]*o[7]*o[14]-o[5]*o[2]*o[15]+o[5]*o[3]*o[14]+o[13]*o[2]*o[7]-o[13]*o[3]*o[6],e.entries[6]=-o[0]*o[6]*o[15]+o[0]*o[7]*o[14]+o[4]*o[2]*o[15]-o[4]*o[3]*o[14]-o[12]*o[2]*o[7]+o[12]*o[3]*o[6],e.entries[10]=o[0]*o[5]*o[15]-o[0]*o[7]*o[13]-o[4]*o[1]*o[15]+o[4]*o[3]*o[13]+o[12]*o[1]*o[7]-o[12]*o[3]*o[5],e.entries[14]=-o[0]*o[5]*o[14]+o[0]*o[6]*o[13]+o[4]*o[1]*o[14]-o[4]*o[2]*o[13]-o[12]*o[1]*o[6]+o[12]*o[2]*o[5],e.entries[3]=-o[1]*o[6]*o[11]+o[1]*o[7]*o[10]+o[5]*o[2]*o[11]-o[5]*o[3]*o[10]-o[9]*o[2]*o[7]+o[9]*o[3]*o[6],e.entries[7]=o[0]*o[6]*o[11]-o[0]*o[7]*o[10]-o[4]*o[2]*o[11]+o[4]*o[3]*o[10]+o[8]*o[2]*o[7]-o[8]*o[3]*o[6],e.entries[11]=-o[0]*o[5]*o[11]+o[0]*o[7]*o[9]+o[4]*o[1]*o[11]-o[4]*o[3]*o[9]-o[8]*o[1]*o[7]+o[8]*o[3]*o[5],e.entries[15]=o[0]*o[5]*o[10]-o[0]*o[6]*o[9]-o[4]*o[1]*o[10]+o[4]*o[2]*o[9]+o[8]*o[1]*o[6]-o[8]*o[2]*o[5];var n=o[0]*e.entries[0]+o[1]*e.entries[4]+o[2]*e.entries[8]+o[3]*e.entries[12];if(0==n)throw"Determinant is zero.";n=1/n;for(var r=0;16>r;r++)e.entries[r]=e.entries[r]*n;return e},Lore.Quaternion=function(t,e,o,n){1===arguments.length?this.components=new Float32Array(t):2===arguments.length?(this.components=new Float32Array(4),this.setFromAxisAngle(t,e)):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=e||0,this.components[2]=o||0,this.components[3]=void 0!==n?n:1)},Lore.Quaternion.prototype={constructor:Lore.Quaternion,getX:function(){return this.components[0]},getY:function(){return this.components[1]},getZ:function(){return this.components[2]},getW:function(){return this.components[3]},set:function(t,e,o,n){this.components[0]=t,this.components[1]=e,this.components[2]=o,this.components[3]=n},setX:function(t){this.components[0]=t},setY:function(t){this.components[1]=t},setZ:function(t){this.components[2]=t},setW:function(t){this.components[3]=t},setFromAxisAngle:function(t,e){var o=Lore.Vector3f.normalize(t),n=e/2,r=Math.sin(n);this.components[0]=o.components[0]*r,this.components[1]=o.components[1]*r,this.components[2]=o.components[2]*r,this.components[3]=Math.cos(n)},setFromUnitVectors:function(t,e){var o=null,n=t.dot(e)+1;1e-6>n?(o=new Lore.Vector3f,n=0,Math.abs(t.components[0])>Math.abs(t.components[2])?o.set(-t.components[1],t.components[0],0):o.set(0,-t.components[2],t.components[1])):o=Lore.Vector3f.cross(t,e),this.set(o.components[0],o.components[1],o.components[2],n),this.normalize()},lookAt:function(t,e,o){return this.setFromMatrix(Lore.Matrix4f.lookAt(t,e,o)),this},lengthSq:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]+this.components[3]*this.components[3]},length:function(){return Math.sqrt(this.lengthSq())},inverse:function(){return this.conjugate().normalize()},normalize:function(){var t=this.length();if(0===t)this.components[0]=0,this.components[1]=0,this.components[2]=0,this.components[3]=1;else{var e=1/t;this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e}return this},dot:function(t){return this.components[0]*t.components[0]+this.components[1]*t.components[1]+this.components[2]*t.components[2]+this.components[3]*t.components[3]},multiplyA:function(t){var e=this.components[0]*t.components[3]+this.components[3]*t.components[0]+this.components[1]*t.components[2]-this.components[2]*t.components[1],o=this.components[1]*t.components[3]+this.components[3]*t.components[1]+this.components[2]*t.components[0]-this.components[0]*t.components[2],n=this.components[2]*t.components[3]+this.components[3]*t.components[2]+this.components[0]*t.components[1]-this.components[1]*t.components[0],r=this.components[3]*t.components[3]-this.components[0]*t.components[0]-this.components[1]*t.components[1]-this.components[2]*t.components[2];return this.components[0]=e,this.components[1]=o,this.components[2]=n,this.components[3]=r,this},multiplyB:function(t){var e=t.components[0]*this.components[3]+t.components[3]*this.components[0]+t.components[1]*this.components[2]-t.components[2]*this.components[1],o=t.components[1]*this.components[3]+t.components[3]*this.components[1]+t.components[2]*this.components[0]-t.components[0]*this.components[2],n=t.components[2]*this.components[3]+t.components[3]*this.components[2]+t.components[0]*this.components[1]-t.components[1]*this.components[0],r=t.components[3]*this.components[3]-t.components[0]*this.components[0]-t.components[1]*this.components[1]-t.components[2]*this.components[2];return this.components[0]=e,this.components[1]=o,this.components[2]=n,this.components[3]=r,this},multiplyScalar:function(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this.components[3]*=t,this},conjugate:function(){return this.components[0]*=-1,this.components[1]*=-1,this.components[2]*=-1,this},add:function(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this.components[3]+=t.components[3],this},subtract:function(t){return this.components[0]-=t.components[0],this.components[1]-=t.components[1],this.components[2]-=t.components[2],this.components[3]-=t.components[3],this},rotateX:function(t){var e=t/2;return this.multiplyA(new Lore.Quaternion(Math.sin(e),0,0,Math.cos(e)))},rotateY:function(t){var e=t/2;return this.multiplyA(new Lore.Quaternion(0,Math.sin(e),0,Math.cos(e)))},rotateZ:function(t){var e=t/2;return this.multiplyA(new Lore.Quaternion(0,0,Math.sin(e),Math.cos(e)))},toAxisAngle:function(){console.warn("The method toAxisAngle() has not been implemented.")},toRotationMatrix:function(){var t=this.components[0],e=this.components[1],o=this.components[2],n=this.components[3],r=t*t,s=t*e,i=t*o,a=t*n,c=e*n,h=e*e,u=e*o,m=o*o,p=o*n,l=new Lore.Matrix4f;return l.entries[0]=1-2*(h+m),l.entries[1]=2*(s+p),l.entries[2]=2*(i-c),l.entries[4]=2*(u-p),l.entries[5]=1-2*(r+m),l.entries[6]=2*(u+a),l.entries[8]=2*(i+c),l.entries[9]=2*(u-a),l.entries[10]=1-2*(r+h),l},setFromMatrix:function(t){var e=t.entries[0],o=t.entries[4],n=t.entries[8],r=t.entries[1],s=t.entries[5],i=t.entries[9],a=t.entries[2],c=t.entries[6],h=t.entries[10],u=e+s+h;if(u>0){var m=.5/Math.sqrt(u+1);this.components[0]=(c-i)*m,this.components[1]=(n-a)*m,this.components[2]=(r-o)*m,this.components[3]=.25/m}else if(e>s&&e>h){var m=2*Math.sqrt(1+e-s-h);this.components[0]=.25*m,this.components[1]=(o+r)/m,this.components[2]=(n+a)/m,this.components[3]=(c-i)/m}else if(s>h){var m=2*Math.sqrt(1+s-e-h);this.components[0]=(o+r)/m,this.components[1]=.25*m,this.components[2]=(i+c)/m,this.components[3]=(n-a)/m}else{var m=2*Math.sqrt(1+h-e-s);this.components[0]=(n+a)/m,this.components[1]=(i+c)/m,this.components[2]=.25*m,this.components[3]=(r-o)/m}return this},clone:function(){return new Lore.Quaternion(this.components[0],this.components[1],this.components[2],this.components[3])},equals:function(t){return this.components[0]===t.components[0]&&this.components[1]===t.components[1]&&this.components[2]===t.components[2]&&this.components[3]===t.components[3]},toString:function(){return"x: "+this.getX()+", y: "+this.getY()+", z: "+this.getZ()+", w: "+this.getW()}},Lore.Quaternion.dot=function(t,e){return new Lore.Quaternion(t.components[0]*e.components[0]+t.components[1]*e.components[1]+t.components[2]*e.components[2]+t.components[3]*e.components[3])},Lore.Quaternion.multiply=function(t,e){return new Lore.Quaternion(t.components[0]*e.components[3]+t.components[3]*e.components[0]+t.components[1]*e.components[2]-t.components[2]*e.components[1],t.components[1]*e.components[3]+t.components[3]*e.components[1]+t.components[2]*e.components[0]-t.components[0]*e.components[2],t.components[2]*e.components[3]+t.components[3]*e.components[2]+t.components[0]*e.components[1]-t.components[1]*e.components[0],t.components[3]*e.components[3]+t.components[0]*e.components[0]+t.components[1]*e.components[1]-t.components[2]*e.components[2])},Lore.Quaternion.multiplyScalar=function(t,e){return new Lore.Quaternion(t.components[0]*e,t.components[1]*e,t.components[2]*e,t.components[3]*e)},Lore.Quaternion.inverse=function(t){var e=new Lore.Quaternion(t.components);return e.conjugate().normalize()},Lore.Quaternion.normalize=function(t){var e=t.length();if(0===e)return new Lore.Quaternion(0,0,0,1);var o=1/e;return new Lore.Quaternion(t.components[0]*o,t.components[1]*o,t.components[2]*o,t.components[3]*o)},Lore.Quaternion.conjugate=function(t){return new Lore.Quaternion(-1*t.components[0],-1*t.components[1],-1*t.components[2],t.components[3])},Lore.Quaternion.add=function(t,e){return new Lore.Quaternion(t.components[0]+e.components[0],t.components[1]+e.components[1],t.components[2]+e.components[2],t.components[3]+e.components[3])},Lore.Quaternion.subtract=function(t,e){return new Lore.Quaternion(t.components[0]-e.components[0],t.components[1]-e.components[1],t.components[2]-e.components[2],t.components[3]-e.components[3])},Lore.Quaternion.fromMatrix=function(t){var e=new Lore.Quaternion;return e.setFromMatrix(t),e},Lore.Quaternion.slerp=function(t,e,o){if(0===o)return new Lore.Quaternion(t.components);if(1===o)return new Lore.Quaternion(e.components);var n=new Lore.Quaternion(e.components),r=t.components[0]*n.components[0]+t.components[1]*n.components[1]+t.components[2]*n.components[2]+t.components[3]*n.components[3];if(0>r&&(n.multiplyScalar(-1),r=-r),Math.abs(r)>=1)return new Lore.Quaternion(t.components);var s=Math.acos(r),i=sqrt(1-r*r);if(Math.abs(i)<.001)return new Lore.Quaternion(.5*t.components[0]+.5*n.components[0],.5*t.components[1]+.5*n.components[1],.5*t.components[2]+.5*n.components[2],.5*t.components[3]+.5*n.components[3]);var a=Math.sin((1-o)*s)/i,c=Math.sin(o*s)/i;return new Lore.Quaternion(t.components[0]*a+n.components[0]*c,t.components[1]*a+n.components[1]*c,t.components[2]*a+n.components[2]*c,t.components[3]*a+n.components[3]*c)},Lore.SphericalCoords=function(t,e,o){this.components=new Float32Array(3),this.radius=void 0!==t?t:1,this.phi=e?e:0,this.theta=o?o:0},Lore.SphericalCoords.prototype={constructor:Lore.SphericalCoords,set:function(t,e,o){return this.components[0]=t,this.components[1]=e,this.components[2]=o,this},secure:function(){return this.components[1]=Math.max(1e-6,Math.min(Math.PI-1e-6,this.components[1])),this},setFromVector:function(t){return this.components[0]=t.length(),0===this.components[0]?(this.components[1]=0,this.components[2]=0):(this.components[1]=Math.acos(Math.max(-1,Math.min(1,t.components[1]/this.components[0]))),this.components[2]=Math.atan2(t.components[0],t.components[2])),this},limit:function(t,e,o,n){this.components[1]=Math.max(t,Math.min(e,this.components[1])),this.components[2]=Math.max(o,Math.min(n,this.components[2]))},clone:function(){return new Lore.SphericalCoords(this.radius,this.phi,this.theta)},toString:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}},Lore.ProjectionMatrix=function(){Lore.Matrix4f.call(this)},Lore.ProjectionMatrix.prototype=Object.assign(Object.create(Lore.Matrix4f.prototype),{constructor:Lore.ProjectionMatrix,setOrthographic:function(t,e,o,n,r,s){var i=1/(e-t),a=1/(o-n),c=1/(s-r),h=(e+t)*i,u=(o+n)*a,m=(s+r)*c;return this.set(),this.entries[0]=2*i,this.entries[4]=0,this.entries[8]=0,this.entries[12]=-h,this.entries[1]=0,this.entries[5]=2*a,this.entries[9]=0,this.entries[13]=-u,this.entries[2]=0,this.entries[6]=0,this.entries[10]=-2*c,this.entries[14]=-m,this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[15]=1,this}}),Lore.Statistics=function(){},Lore.Statistics.prototype={constructor:Lore.Vector2f},Lore.Statistics.spareRandomNormal=null,Lore.Statistics.randomNormal=function(){var t,e,o,n,r;if(null!==Lore.Statistics.spareRandomNormal)t=Lore.Statistics.spareRandomNormal,Lore.Statistics.spareRandomNormal=null;else{do e=2*Math.random()-1,o=2*Math.random()-1,n=e*e+o*o;while(0===n||n>=1);r=Math.sqrt(-2*Math.log(n)/n),t=e*r,Lore.Statistics.spareRandomNormal=o*r}return t/14},Lore.Statistics.randomNormalInRange=function(t,e){var o;do o=Lore.Statistics.randomNormal();while(t>o||o>e);return o},Lore.Statistics.randomNormalScaled=function(t,e){var o=Lore.Statistics.randomNormalInRange(-1,1);return o*e+t},Lore.Statistics.normalize=function(t){for(var e=Number.MIN_VALUE,o=Number.MAX_VALUE,n=0;n<t.length;n++){var r=t[n];r>e&&(e=r),o>r&&(o=r)}for(var s=e-o,n=0;n<t.length;n++)t[n]=(t[n]-o)/s;return[o,e]},Lore.Statistics.scale=function(t,e,o,n,r){return(r-n)*(t-e)/(o-e)+n},Lore.Ray=function(t,e){this.source=t||new Lore.Vector3f,this.direction=e||new Lore.Vector3f},Lore.Ray.prototype={constructor:Lore.Ray,copyFrom:function(t){return this.source.copyFrom(t.source),this.direction.copyFrom(t.direction),this},applyProjection:function(t){return this.direction.add(this.source).applyProjection(t),this.source.applyProjection(t),this.direction.subtract(this.source),this.direction.normalize(),this},distanceSqToPoint:function(t){var e=Lore.Vector3f.subtract(t,this.source),o=e.dot(this.direction);return 0>o?this.source.distanceToSq(t):(e.copyFrom(this.direction).multiplyScalar(o).add(this.source),e.distanceToSq(t))},closestPointToPoint:function(t){var e=Lore.Vector3f.subtract(t,this.source),o=e.dot(this.direction);return 0>o?e.copyFrom(this.source):e.copyFrom(this.direction).multiplyScalar(o).add(this.source)}},Lore.HelperBase=function(t,e,o){Lore.Node.call(this),this.renderer=t,this.shader=Lore.Shaders[o],this.program=this.renderer.createProgram(this.shader),this.geometry=this.renderer.createGeometry(e,this.program)},Lore.HelperBase.prototype=Object.assign(Object.create(Lore.Node.prototype),{constructor:Lore.HelperBase,setAttribute:function(t,e){this.geometry.addAttribute(t,e)},updateAttribute:function(t,e,o){for(var n=this.geometry.attributes[t],r=e*n.attributeLength,s=0;s<n.attributeLength;s++)n.data[r+s]=o[s]||n.data[r+s];n.stale=!0},updateAttributeAll:function(t,e){for(var o=this.geometry.attributes[t],n=0;n<o.data.length;n++)o.data[n]=e[n];o.stale=!0},draw:function(){this.geometry.draw(this.renderer)}}),Lore.PointHelper=function(t,e,o,n){Lore.HelperBase.call(this,t,e,o),this.opts=Lore.Utils.extend(!0,Lore.PointHelper.defaults,n),this.indices=null,this.octree=null,this.geometry.setMode(Lore.DrawModes.points),this.initPointSize()},Lore.PointHelper.prototype=Object.assign(Object.create(Lore.HelperBase.prototype),{constructor:Lore.PointHelper,getMaxLength:function(t,e,o){return Math.max(t.length,Math.max(e.length,o.length))},setPositions:function(t){this.setAttribute("position",t)},setPositionsXYZ:function(t,e,o,n){for(var r=new Float32Array(3*n),s=0;n>s;s++){var i=3*s;r[i]=t[s]||0,r[i+1]=e[s]||0,r[i+2]=o[s]||0}if(this.opts.octree){for(var a=Lore.AABB.fromPoints(r),c=new Uint32Array(n),s=0;n>s;s++)c[s]=s;this.octree=new Lore.Octree,this.octree.build(c,r,a)}this.setAttribute("position",r)},setPositionsXYZColor:function(t,e,o,n){var r=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,r),this.setColor(n,r)},setPositionsXYZRGB:function(t,e,o,n,r,s,i){i=!!i;var a=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,a),this.setRGB(n,r,s,a,i)},setPositionsXYZHues:function(t,e,o,n){var r=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,r),this.setHues(n,r)},setPositionsXYZHSL:function(t,e,o,n,r,s){var i=this.getMaxLength(t,e,o);this.setPositionsXYZ(t,e,o,i),this.setHSL(n,r,s,i)},setHues:function(t,e){for(var o=new Float32Array(3*e),n=0;e>n;n++){var r=t[n]||0;r=Lore.Statistics.scale(r,0,1,.2,1),r=1-r,r=this.shiftHue(r,-.2);var s=Lore.Color.hslToRgb(r,.5,.5);o[3*n]=s[0],o[3*n+1]=s[1],o[3*n+2]=s[2]}this.setColors(o)},setHSL:function(t,e,o,n){for(var r=new Float32Array(3*n),s=0;n>s;s++){var i=t[s]||0;i=Lore.Statistics.scale(i,0,1,.2,1),i=1-i,i=this.shiftHue(i,-.2);var a=Lore.Color.hslToRgb(i,e[s],o[s]);r[3*s]=a[0],r[3*s+1]=a[1],r[3*s+2]=a[2]}this.setColors(r)},shiftHue:function(t,e){return t+=e,t>1&&(t-=1),0>t&&(t=1+t),t},setColors:function(t){this.setAttribute("color",t)},updateColors:function(t){this.updateAttributeAll("color",t)},updateColor:function(t,e){this.updateAttribute("color",t,e.components)},setPointSize:function(t){this.geometry.shader.uniforms.size.value=t},initPointSize:function(){this.geometry.shader.uniforms.size.value=this.renderer.camera.zoom},setRGB:function(t,e,o,n,r){var s=new Float32Array(3*n);if(r)for(var i=0;n>i;i++){var a=3*i;s[a]=t[i]/255,s[a+1]=e[i]/255,s[a+2]=o[i]/255}else for(var i=0;n>i;i++){var a=3*i;s[a]=t[i],s[a+1]=e[i],s[a+2]=o[i]}this.setColors(s)},updateRGB:function(t,e,o){for(var n=new Float32Array(3*t.length),r=0;r<t.length;r++){var s=3*r;n[s]=t[r],n[s+1]=e[r],n[s+2]=o[r]}this.updateColors(n)},setColor:function(t,e){for(var o=new Float32Array(3*e),n=0;3*e>n;n+=3)o[n]=t.components[0],o[n+1]=t.components[1],o[n+2]=t.components[2];this.setColors(o)}}),Lore.PointHelper.defaults={octree:!0},Lore.CoordinatesHelper=function(t,e,o,n){Lore.HelperBase.call(this,t,e,o),this.opts=Lore.Utils.extend(!0,Lore.CoordinatesHelper.defaults,n),this.geometry.setMode(Lore.DrawModes.lines),this.init()},Lore.CoordinatesHelper.prototype=Object.assign(Object.create(Lore.HelperBase.prototype),{constructor:Lore.CoordinatesHelper,init:function(){var t=this.opts.position.components,e=this.opts.axis,o=[t[0],t[1],t[2],t[0]+e.x.length,t[1],t[2],t[0],t[1],t[2],t[0],t[1]+e.y.length,t[2],t[0],t[1],t[2],t[0],t[1],t[2]+e.z.length],n=e.x.color.components,r=e.y.color.components,s=e.z.color.components,i=[n[0],n[1],n[2],n[0],n[1],n[2],r[0],r[1],r[2],r[0],r[1],r[2],s[0],s[1],s[2],s[0],s[1],s[2]];if(this.opts.box.enabled){var a=this.opts.box.x.color.components,c=this.opts.box.y.color.components,h=this.opts.box.z.color.components;o.push(t[0]+e.x.length,t[1]+e.y.length,t[2]+e.z.length,t[0],t[1]+e.y.length,t[2]+e.z.length,t[0]+e.x.length,t[1],t[2]+e.z.length,t[0],t[1],t[2]+e.z.length,t[0]+e.x.length,t[1]+e.y.length,t[2],t[0],t[1]+e.y.length,t[2],t[0]+e.x.length,t[1]+e.y.length,t[2]+e.z.length,t[0]+e.x.length,t[1],t[2]+e.z.length,t[0],t[1]+e.y.length,t[2]+e.z.length,t[0],t[1],t[2]+e.z.length,t[0]+e.x.length,t[1]+e.y.length,t[2],t[0]+e.x.length,t[1],t[2],t[0]+e.x.length,t[1]+e.y.length,t[2]+e.z.length,t[0]+e.x.length,t[1]+e.y.length,t[2],t[0],t[1]+e.y.length,t[2]+e.z.length,t[0],t[1]+e.y.length,t[2],t[0]+e.x.length,t[1],t[2]+e.z.length,t[0]+e.x.length,t[1],t[2]),i.push(a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2])}for(var u=this.opts.ticks.x,m=e.x.length/u.count,p=this.opts.ticks.y,l=e.y.length/p.count,f=this.opts.ticks.z,d=e.z.length/f.count,g=t[0],v=u.color.components,L=0;L<u.count-1;L++)g+=m,o.push(g+u.offset.components[0],t[1]+u.offset.components[1],t[2]+u.offset.components[2],g+u.offset.components[0],t[1]+u.offset.components[1]+u.length,t[2]+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[0];for(var L=0;L<u.count-1;L++)g+=m,o.push(g+u.offset.components[0],t[1]+u.offset.components[1],t[2]+u.offset.components[2],g+u.offset.components[0],t[1]+u.offset.components[1],t[2]+u.offset.components[2]+u.length),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[1],v=p.color.components;for(var L=0;L<p.count-1;L++)g+=l,o.push(t[0]+u.offset.components[0],g+u.offset.components[1],t[2]+u.offset.components[2],t[0]+u.offset.components[0]+u.length,g+u.offset.components[1],t[2]+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[1];for(var L=0;L<p.count-1;L++)g+=l,o.push(t[0]+u.offset.components[0],g+u.offset.components[1],t[2]+u.offset.components[2],t[0]+u.offset.components[0],g+u.offset.components[1],t[2]+u.offset.components[2]+u.length),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[2],v=f.color.components;for(var L=0;L<f.count-1;L++)g+=d,o.push(t[0]+u.offset.components[0],t[1]+u.offset.components[1],g+u.offset.components[2],t[0]+u.offset.components[0],t[1]+u.offset.components[1]+u.length,g+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);g=t[2];for(var L=0;L<f.count-1;L++)g+=d,o.push(t[0]+u.offset.components[0],t[1]+u.offset.components[1],g+u.offset.components[2],t[0]+u.offset.components[0]+u.length,t[1]+u.offset.components[1],g+u.offset.components[2]),i.push(v[0],v[1],v[2],v[0],v[1],v[2]);this.setAttribute("position",new Float32Array(o)),this.setAttribute("color",new Float32Array(i))}}),Lore.CoordinatesHelper.defaults={position:new Lore.Vector3f,axis:{x:{length:50,color:Lore.Color.fromHex("#222222")},y:{length:50,color:Lore.Color.fromHex("#222222")},z:{length:50,color:Lore.Color.fromHex("#222222")}},ticks:{x:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")},y:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")},z:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")}},box:{enabled:!0,x:{color:Lore.Color.fromHex("#999999")},y:{color:Lore.Color.fromHex("#999999")},z:{color:Lore.Color.fromHex("#999999")}}},Lore.OctreeHelper=function(t,e,o,n,r){Lore.HelperBase.call(this,t,e,o),this.opts=Lore.Utils.extend(!0,Lore.OctreeHelper.defaults,r),this.target=n,this.octree=this.target.octree,this.raycaster=new Lore.Raycaster;var s=this;t.controls.addEventListener("mousedown",function(t){var e=t.e.mouse.normalizedPosition;s.raycaster.set(s.renderer.camera,e.x,e.y);var o=s.octree.raySearch(s.raycaster),n=s.rayIntersections(o);n.sort(function(t,e){return t.distance-e.distance;
}),n.length>0&&s.target.updateColor(n[0].index,new Lore.Color(1,1,1,1))}),t.controls.addEventListener("zoomchanged",function(t){s.target.setPointSize(1.5*t)}),this.init()},Lore.OctreeHelper.prototype=Object.assign(Object.create(Lore.HelperBase.prototype),{constructor:Lore.OctreeHelper,init:function(){"center"===this.opts.visualize?this.drawCenters():"cubes"===this.opts.visualize&&this.drawBoxes()},drawCenters:function(){this.geometry.setMode(Lore.DrawModes.points);var t=this.octree.aabbs,e=Object.keys(t).length,o=new Float32Array(3*e),n=new Float32Array(3*e),r=0;for(key in t){var s=t[key].center.components,i=3*r;o[i]=1,o[i+1]=1,o[i+2]=1,n[i]=s[0],n[i+1]=s[1],n[i+2]=s[2],r++}this.setAttribute("position",new Float32Array(n)),this.setAttribute("color",new Float32Array(o))},drawBoxes:function(){this.geometry.setMode(Lore.DrawModes.lines);for(var t=this.octree.aabbs,e=Object.keys(t).length,o=new Float32Array(24*e*3),n=new Float32Array(24*e*3),r=0;r<o.length;r++)o[r]=1;var s=0;for(key in t){var i=Lore.AABB.getCorners(t[key]);n[s++]=i[0][0],n[s++]=i[0][1],n[s++]=i[0][2],n[s++]=i[1][0],n[s++]=i[1][1],n[s++]=i[1][2],n[s++]=i[0][0],n[s++]=i[0][1],n[s++]=i[0][2],n[s++]=i[2][0],n[s++]=i[2][1],n[s++]=i[2][2],n[s++]=i[0][0],n[s++]=i[0][1],n[s++]=i[0][2],n[s++]=i[4][0],n[s++]=i[4][1],n[s++]=i[4][2],n[s++]=i[1][0],n[s++]=i[1][1],n[s++]=i[1][2],n[s++]=i[3][0],n[s++]=i[3][1],n[s++]=i[3][2],n[s++]=i[1][0],n[s++]=i[1][1],n[s++]=i[1][2],n[s++]=i[5][0],n[s++]=i[5][1],n[s++]=i[5][2],n[s++]=i[2][0],n[s++]=i[2][1],n[s++]=i[2][2],n[s++]=i[3][0],n[s++]=i[3][1],n[s++]=i[3][2],n[s++]=i[2][0],n[s++]=i[2][1],n[s++]=i[2][2],n[s++]=i[6][0],n[s++]=i[6][1],n[s++]=i[6][2],n[s++]=i[3][0],n[s++]=i[3][1],n[s++]=i[3][2],n[s++]=i[7][0],n[s++]=i[7][1],n[s++]=i[7][2],n[s++]=i[4][0],n[s++]=i[4][1],n[s++]=i[4][2],n[s++]=i[5][0],n[s++]=i[5][1],n[s++]=i[5][2],n[s++]=i[4][0],n[s++]=i[4][1],n[s++]=i[4][2],n[s++]=i[6][0],n[s++]=i[6][1],n[s++]=i[6][2],n[s++]=i[5][0],n[s++]=i[5][1],n[s++]=i[5][2],n[s++]=i[7][0],n[s++]=i[7][1],n[s++]=i[7][2],n[s++]=i[6][0],n[s++]=i[6][1],n[s++]=i[6][2],n[s++]=i[7][0],n[s++]=i[7][1],n[s++]=i[7][2]}this.setAttribute("position",n),this.setAttribute("color",o)},rayIntersections:function(t){var e=[],o=Lore.Matrix4f.invert(this.target.modelMatrix),n=new Lore.Ray,r=this.raycaster.threshold,s=this.target.geometry.attributes.position.data;n.copyFrom(this.raycaster.ray).applyProjection(o);for(var i=r,a=i*i,c=0;c<t.length;c++){var h=t[c].index,u=t[c].locCode,m=3*h,p=new Lore.Vector3f(s[m],s[m+1],s[m+2]),l=n.distanceSqToPoint(p);if(a>l){var f=n.closestPointToPoint(p);f.applyProjection(this.target.modelMatrix);var d=this.raycaster.ray.source.distanceTo(f);if(d<this.raycaster.near||d>this.raycaster.far)continue;e.push({distance:d,index:h,locCode:u})}}return e}}),Lore.OctreeHelper.defaults={visualize:!1},Lore.FileReaderBase=function(t){this.elementId=t,this.element=document.getElementById(this.elementId),this.eventListeners={};var e=this;this.element.addEventListener("change",function(){var t=new FileReader;t.onload=function(){e.loaded(t.result)},t.readAsBinaryString(this.files[0])})},Lore.FileReaderBase.prototype={constructor:Lore.FileReaderBase,addEventListener:function(t,e){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e)},raiseEvent:function(t,e){if(this.eventListeners[t])for(var o=0;o<this.eventListeners[t].length;o++)this.eventListeners[t][o](e)},loaded:function(t){}},Lore.CsvFileReader=function(t,e){Lore.FileReaderBase.call(this,t),this.opts=Lore.Utils.extend(!0,Lore.CsvFileReader.defaults,e),this.columns=[]},Lore.CsvFileReader.prototype=Object.assign(Object.create(Lore.FileReaderBase.prototype),{constructor:Lore.CsvFileReader,loaded:function(t){t=t.replace("\n\n","\n"),t=t.replace(/^\s+|\s+$/g,"");for(var e=t.split("\n"),o=e.length,n=!0,r=this.opts.cols,s=this.opts.header?1:0,i=s;o>i;i++){var a=e[i].split(this.opts.separator);if(0==r.length)for(var c=0;c<a.length;c++)r.push[c];if(n){for(var c=0;c<r.length;c++)this.createArray(c,this.opts.types[c],o-s);n=!1}for(var c=0;c<r.length;c++)this.columns[c][i-s]=a[r[c]]}this.raiseEvent("loaded",this.columns)},createArray:function(t,e,o){"Int8Array"==e?this.columns[t]=new Int8Array(o):"Uint8Array"==e?this.columns[t]=new Uint8Array(o):"Uint8ClampedArray"==e?this.columns[t]=new Uint8ClampedArray(o):"Int16Array"==e?this.columns[t]=new Int16Array(o):"Uint16Array"==e?this.columns[t]=new Uint16Array(o):"Int32Array"==e?this.columns[t]=new Int32Array(o):"Uint32Array"==e?this.columns[t]=new Uint32Array(o):"Float32Array"==e?this.columns[t]=new Float32Array(o):"Float64Array"==e?this.columns[t]=new Float64Array(o):this.columns[t]=new Array(o)}}),Lore.CsvFileReader.defaults={separator:",",cols:[],types:[],header:!0},Lore.Utils={},Lore.Utils.extend=function(){var t={},e=!1,o=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(e=arguments[0],o++);for(var r=function(o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e&&"[object Object]"===Object.prototype.toString.call(o[n])?t[n]=Lore.Utils.extend(!0,t[n],o[n]):t[n]=o[n])};n>o;o++){var s=arguments[o];r(s)}return t},Lore.Utils.arrayContains=function(t,e){for(var o=0;o<t.length;o++)if(t[o]===e)return!0;return!1},Lore.Utils.concatTypedArrays=function(t,e){var o=new t.constructor(t.length+e.length);return o.set(t),o.set(e,t.length),o},Lore.Utils.msb=function(t){return 2147483648&t?31:Lore.Utils.msb(t<<1|1)-1},Lore.Utils.mergePointDistances=function(t,e){var o={};return o.indices=Lore.Utils.concatTypedArrays(t.indices,e.indices),o.distancesSq=Lore.Utils.concatTypedArrays(t.distancesSq,e.distancesSq),o},Lore.Shaders["default"]=new Lore.Shader("Default",{size:new Lore.Uniform("size",5,"float")},["uniform float size;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);","gl_PointSize = size;","vColor = color;","}"],["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.circle=new Lore.Shader("Circle",{size:new Lore.Uniform("size",5,"float")},["uniform float size;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","gl_PointSize = size;","vColor = color;","}"],["varying vec3 vColor;","void main() {","float r = 1.0, delta = 0.0, alpha = 1.0;","vec2 cxy = 2.0 * gl_PointCoord - 1.0;","r = dot(cxy, cxy);","#ifdef GL_OES_standard_derivatives","delta = fwidth(r);","alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);","#endif","gl_FragColor = vec4(vColor, alpha);","}"]),Lore.Shaders.defaultEffect=new Lore.Shader("DefaultEffect",{},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main(void) {","vec4 color = texture2D(fbo_texture, f_texcoord);","gl_FragColor = color;","}"]),Lore.Shaders.fxaaEffect=new Lore.Shader("FXAAEffect",{},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["#define FXAA_REDUCE_MIN   (1.0/ 128.0)","#define FXAA_REDUCE_MUL   (1.0 / 8.0)","#define FXAA_SPAN_MAX     8.0","vec4 applyFXAA(vec2 fragCoord, sampler2D tex)","{","vec4 color;","vec2 inverseVP = vec2(1.0 / 750.0, 1.0 / 750.0);","vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;","vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;","vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;","vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;","vec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;","vec3 luma = vec3(0.299, 0.587, 0.114);","float lumaNW = dot(rgbNW, luma);","float lumaNE = dot(rgbNE, luma);","float lumaSW = dot(rgbSW, luma);","float lumaSE = dot(rgbSE, luma);","float lumaM  = dot(rgbM,  luma);","float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));","float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);","float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);","dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;","vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);","vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);","float lumaB = dot(rgbB, luma);","if ((lumaB < lumaMin) || (lumaB > lumaMax))","color = vec4(rgbA, 1.0);","else","color = vec4(rgbB, 1.0);","return color;","}","uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main(void) {","vec4 color = applyFXAA(f_texcoord * 750.0, fbo_texture);","gl_FragColor = color;","}"]),Lore.Octree=function(t,e){this.threshold=t||500,this.maxDepth=e||8,this.points={},this.aabbs={}},Lore.Octree.prototype={constructor:Lore.Octree,build:function(t,e,o,n){n=n||1,o.setLocCode(n),this.points[n]=null,this.aabbs[n]=o;var r=this.getDepth(n);if(t.length<=this.threshold||r>=this.maxDepth){this.points[n]=new Uint32Array(t.length);for(var s=0;s<t.length;s++)this.points[n][s]=t[s];return!0}for(var i=new Uint32Array(8),a=new Float32Array(t.length),s=0;s<t.length;s++){var c=3*t[s];e[c+0]>=o.center.components[0]&&(a[s]|=4),e[c+1]>=o.center.components[1]&&(a[s]|=2),e[c+2]>=o.center.components[2]&&(a[s]|=1),i[a[s]]++}for(var h=new Array(8),u=new Array(8),s=0;8>s;s++)if(0!=i[s]){h[s]=new Uint32Array(i[s]);for(var m=0,c=0;m<t.length;m++)a[m]==s&&(h[s][c++]=t[m]);var p=Lore.Octree.OctreeOffsets[s],l=new Lore.Vector3f(p[0],p[1],p[2]);l.multiplyScalar(o.radius),u[s]=new Lore.AABB(o.center.clone().add(l),.5*o.radius)}for(var s=0;8>s;s++)if(0!=i[s]){var f=this.generateLocCode(n,s);this.build(h[s],e,u[s],f)}},getLocCodes:function(){return Object.keys(this.aabbs)},getDepth:function(t){return Lore.Utils.msb(t)/3},generateLocCode:function(t,e){var o=Lore.Utils.msb(t);return-1==o?8|e:(t=t<<=3,t|e)},traverse:function(t,e){e=e||1;for(var o=0;8>o;o++){var n=e<<3|o;this.aabbs[n]&&(t(this.points[n],this.aabbs[n],n),this.traverse(t,n))}},traverseIf:function(t,e,o){o=o||1;for(var n=0;8>n;n++){var r=o<<3|n;if(this.aabbs[r]){if(!e(this.aabbs[r],r))continue;t(this.points[r],this.aabbs[r],r),this.traverseIf(t,e,r)}}},raySearch:function(t){var e=[],o=t.ray.direction.clone();o.normalize();var n=new Lore.Vector3f(1,1,1);return n.divide(o),this.traverseIf(function(t,o,n){if(t)for(var r=0;r<t.length;r++)e.push({index:t[r],locCode:n})},function(e,o){return e.cylinderTest(t.ray.source,n,t.far,t.threshold)}),e},getCenters:function(t){t=t||0;var e=new Array;return this.traverse(function(o,n,r){o&&o.length>t&&e.push(n.center)}),e},getClosestBox:function(t,e,o){o=o||1;for(var n=-1,r=Number.MAX_VALUE,s=0;8>s;s++){var i=o<<3|s;if(this.aabbs[i]){if(this.points[i]&&this.points[i].length<e)continue;var a=this.aabbs[i].distanceToPointSq(t.components[0],t.components[1],t.components[2]);r>a&&(r=a,n=i)}}return 0>n?this.aabbs[o]:this.getClosestBox(t,e,n)},getFarthestBox:function(t,e,o){o=o||1;for(var n=-1,r=Number.MIN_VALUE,s=0;8>s;s++){var i=o<<3|s;if(this.aabbs[i]){if(this.points[i]&&this.points[i].length<e)continue;var a=this.aabbs[i].distanceToPointSq(t.components[0],t.components[1],t.components[2]);a>r&&(r=a,n=i)}}return 0>n?this.aabbs[o]:this.getFarthestBox(t,e,n)},getClosestPoint:function(t,e,o,n){o=o||0;var r=Number.MAX_VALUE,s=null,i=null;i=n?this.aabbs[n]:this.getClosestBox(t,o);var a=this.points[i.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var h=a[c];h*=3;var u=e[h],m=e[h+1],p=e[h+2],l=t.components,f=Math.pow(l[0]-u,2)+Math.pow(l[1]-m,2)+Math.pow(l[2]-p,2);r>f&&(r=f,s={x:u,y:m,z:p})}return s?new Lore.Vector3f(s.x,s.y,s.z):null},getFarthestPoint:function(t,e,o,n){o=o||0;var r=Number.MIN_VALUE,s=null,i=null;i=n?this.aabbs[n]:this.getFArthestBox(t,o);var a=this.points[i.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var h=a[c];h*=3;var u=e[h],m=e[h+1],p=e[h+2],l=t.components,f=Math.pow(l[0]-u,2)+Math.pow(l[1]-m,2)+Math.pow(l[2]-p,2);f>r&&(r=f,s={x:u,y:m,z:p})}return s?new Lore.Vector3f(s.x,s.y,s.z):null},getParent:function(t){return t>>>3},getNeighbours:function(t){var e=this,o=new Array;return this.traverseIf(function(e,n,r){e&&e.length>0&&r!=t&&o.push(r)},function(o,n){return o.testAABB(e.aabbs[t])}),o},kNearestNeighbours:function(t,e,o,n,r){t+=1;for(var s=this.positions/3,i=3*e,a={x:n[i],y:n[i+1],z:n[i+2]},c=a.components[0],h=a.components[1],u=a.components[2],m=this.getCellDistancesToPoint(c,h,u,o),p=this.pointDistancesSq(c,h,u,o,n),l=new RadixSort,f=l.sort(p.distancesSq,!0),d=l.sort(m.distancesSq,!0),g=0,v=0,L=new Uint32Array(t),y=0;t>v&&y<f.array.length;y++){if(f.array[y]>d.array[0]){g=y;break}L[y]=p.indices[f.indices[y]],v++}if(v==t)return L;for(var y=0;y<d.array.length;y++){var o=m.locCodes[d.indices[y]],x=this.pointDistancesSq(c,h,u,o,n);p=Lore.Utils.mergePointDistances(p,x);for(var b=l.sort(p.distancesSq,!0),w=g;t>v&&w<b.array.length;w++){if(b.array[w]>d.array[y+1]){g=w;break}L[w]=p.indices[b.indices[w]],v++}if(v==t||v>=s-1)return L}return L},getCellDistancesToPoint:function(t,e,o,n){var r=new Array;this.traverse(function(t,e,o){t&&t.length>0&&o!=n&&r.push(o)});for(var s=new Float32Array(r.length),i=0;i<r.length;i++)s[i]=this.aabbs[r[i]].distanceToPointSq(t,e,o);return{locCodes:r,distancesSq:s}},expandNeighbourhood:function(t,e,o,n,r){for(var s=r.locCodes,i=r.distancesSq,a=s.length,c=a-1;c>=0;c--)for(var h=this.getNeighbours(s[c]),u=0;u<h.length;u++)h[u]==n&&console.log(n),h[u]==n||Lore.Utils.arrayContains(s,h[u])||s.push(h[u]);var m=s.length,p=i.length;if(m!=p){for(var l=new Float32Array(m-p),c=p,f=0;m>c;c++,f++)l[f]=this.aabbs[s[c]].distanceToPointSq(t,e,o);return r.distancesSq=Lore.Utils.concatTypedArrays(i,l),s.length-a}},cellDistancesSq:function(t,e,o,n){for(var r=this.getNeighbours(n),s=new Float32Array(r.length),i=0;i<r.length;i++)s[i]=this.aabbs[r[i]].distanceToPointSq(t,e,o);return{locCodes:r,distancesSq:s}},pointDistancesSq:function(t,e,o,n,r){for(var s=this.points[n],i=new Uint32Array(s.length),a=new Float32Array(s.length),c=0;c<s.length;c++){var h=3*s[c],u=r[h],m=r[h+1],p=r[h+2];i[c]=s[c],a[c]=Math.pow(u-t,2)+Math.pow(m-e,2)+Math.pow(p-o,2)}return{indices:i,distancesSq:a}}},Lore.Octree.clone=function(t){var e=new Lore.Octree;e.threshold=t.threshold,e.maxDepth=t.maxDepth,e.points=t.points;for(var o in t.aabbs)t.aabbs.hasOwnProperty(o)&&(e.aabbs[o]=Lore.AABB.clone(t.aabbs[o]));return e},Lore.Octree.OctreeOffsets=[[-.5,-.5,-.5],[-.5,-.5,.5],[-.5,.5,-.5],[-.5,.5,.5],[.5,-.5,-.5],[.5,-.5,.5],[.5,.5,-.5],[.5,.5,.5]],Lore.AABB=function(t,e){this.center=t||new Lore.Vector3f,this.radius=e||0,this.locCode=0,this.left=0,this.right=0,this.back=0,this.front=0,this.bottom=0,this.top=0,this.neighbours=new Array(6),this.min=new Float32Array(3),this.max=new Float32Array(3),this.updateDimensions()},Lore.AABB.prototype={constructor:Lore.AABB,updateDimensions:function(){var t=this.center.components[0],e=this.center.components[1],o=this.center.components[2];this.min[0]=t-this.radius,this.min[1]=e-this.radius,this.min[2]=o-this.radius,this.max[0]=t+this.radius,this.max[1]=e+this.radius,this.max[2]=o+this.radius,this.left=t-this.radius,this.right=t+this.radius,this.back=o-this.radius,this.front=o+this.radius,this.bottom=e-this.radius,this.top=e+this.radius},setLocCode:function(t){this.locCode=t},getLocCode:function(){return this.locCode},rayTest:function(t,e,o){var n=t.components,r=e.components,s=(this.left-n[0])*r[0],i=(this.right-n[0])*r[0],a=(this.bottom-n[1])*r[1],c=(this.top-n[1])*r[1],h=(this.back-n[2])*r[2],u=(this.front-n[2])*r[2],m=Math.min(Math.max(s,i),Math.max(a,c),Math.max(h,u));if(0>m)return!1;var p=Math.max(Math.min(s,i),Math.min(a,c),Math.min(h,u));return!(p>m||p>o)},cylinderTest:function(t,e,o,n){this.radius+=n,this.updateDimensions();var r=this.rayTest(t,e,o);return this.radius-=n,this.updateDimensions(),r},distanceToPointSq:function(t,e,o){for(var n=0,r=[t,e,o],s=0;3>s;s++)r[s]<this.min[s]&&(n+=Math.pow(this.min[s]-r[s],2)),r[s]>this.max[s]&&(n+=Math.pow(r[s]-this.max[s],2));return n},testAABB:function(t){for(var e=0;3>e;e++)if(this.max[e]<t.min[e]||this.min[e]>t.max[e])return!1;return!0}},Lore.AABB.fromPoints=function(t){for(var e=t[0],o=t[1],n=t[2],r=new Lore.Vector3f(e,o,n),s=new Lore.Vector3f(e,o,n),i=r.components,a=s.components,c=1;c<t.length/3;c++)t[3*c+0]<i[0]&&(i[0]=t[3*c+0]),t[3*c+1]<i[1]&&(i[1]=t[3*c+1]),t[3*c+2]<i[2]&&(i[2]=t[3*c+2]),t[3*c+0]>a[0]&&(a[0]=t[3*c+0]),t[3*c+1]>a[1]&&(a[1]=t[3*c+1]),t[3*c+2]>a[2]&&(a[2]=t[3*c+2]);var h=new Lore.Vector3f.subtract(s,r);h.multiplyScalar(.5);var u=h.components[0],m=h.components[1],p=h.components[2],l=new Lore.Vector3f(u,m,p);l.add(r);var f=Math.max(u,m,p);return new Lore.AABB(l,f)},Lore.AABB.getCorners=function(t){var e=t.center.components,o=e[0],n=e[1],r=e[2],s=t.radius;return[[o-s,n-s,r-s],[o-s,n-s,r+s],[o-s,n+s,r-s],[o-s,n+s,r+s],[o+s,n-s,r-s],[o+s,n-s,r+s],[o+s,n+s,r-s],[o+s,n+s,r+s]]},Lore.AABB.clone=function(t){var e=new Lore.AABB;return e.back=t.back,e.bottom=t.bottom,e.center=new Lore.Vector3f(t.center.components[0],t.center.components[1],t.center.components[2]),e.front=t.front,e.left=t.left,e.locCode=t.locCode,e.max=t.max,e.min=t.min,e.radius=t.radius,e.right=t.right,e.top=t.top,e},Lore.Raycaster=function(){this.ray=new Lore.Ray,this.near=0,this.far=1e3,this.threshold=.5},Lore.Raycaster.prototype={constructor:Lore.Raycaster,set:function(t,e,o){this.near=t.near,this.far=t.far,this.ray.source.set(e,o,(t.near+t.far)/(t.near-t.far)),this.ray.source.unproject(t),this.ray.direction.set(0,0,-1),this.ray.direction.toDirection(t.modelMatrix)}},Lore.UI=function(t){this.canvas=document.createElement("canvas"),this.renderCanvasElement=document.getElementById(t),this.init(),this.resize()},Lore.UI.prototype={constructor:Lore.UI,init:function(){this.canvas.style.cssText="position: absolute; pointer-events: none;",this.renderCanvasElement.parentNode.insertBefore(this.canvas,this.renderCanvasElement)},setWidth:function(t){this.canvas.width=t},setHeight:function(t){this.canvas.height=t},setTop:function(t){this.canvas.style.top=t},setLeft:function(t){this.canvas.style.left=t},resize:function(){this.setWidth(this.renderCanvasElement.width),this.setHeight(this.renderCanvasElement.height),this.setTop(this.renderCanvasElement.offsetTop),this.setLeft(this.renderCanvasElement.offsetLeft)}};